Sjasm Z80 Assembler v0.42c - www.xl2s.tk             [2016.01.12 - 08:17:44]

main.asm
Errors: 0

       1   00:0000                      ;----------------------------------------------------------------------------
       2   00:0000                      ;
       3   00:0000                      ;----------------------------------------------------------------------------
       4   00:0000                      
       5   00:0000                              output "urd2.rom"
       6   00:0000                      
       7   00:0000                      		;	konami scc
       8   00:0000                      		
       9   00:0000  (00:5000)           _kBank1:	equ 05000h ;- 57FFh (5000h used)
      10   00:0000  (00:7000)           _kBank2: 	equ 07000h ;- 77FFh (7000h used)
      11   00:0000  (00:9000)           _kBank3: 	equ 09000h ;- 97FFh (9000h used)
      12   00:0000  (00:B000)           _kBank4: 	equ 0B000h ;- B7FFh (B000h used)
      13   00:0000                      
      14   00:0000                      
      15   00:0000                      
      16   00:0000                      		defpage	 0,0x4000, 0x2000		; page 0 main code + far call routines
      17   00:0000                      		defpage	 1,0x6000, 0x2000		; page 1 main code + far call routines
      18   00:0000                      		defpage	 2,0x8000, 0x2000		; swapped data 
      19   00:0000                      		defpage	 3,0xA000, 0x2000		; swapped data 
      20   00:0000                      		
      21   00:0000                      		defpage	 4..15					; 64KB of swapped data 
      22   00:0000                      
      23   00:0000                      
      24   00:0000                      
      25   00:0000                        		include "header.asm"
       1.  00:0000                      
       2.  00:0000                        // MSX 1 
       3.  00:0000  (00:F3DF)           RG0SAV  equ 0xF3DF  
       4.  00:0000  (00:F3E0)           RG1SAV  equ 0xF3E0  
       5.  00:0000  (00:F3E1)           RG2SAV  equ 0xF3E1
       6.  00:0000  (00:F3E2)           RG3SAV  equ 0xF3E2
       7.  00:0000  (00:F3E3)           RG4SAV  equ 0xF3E3
       8.  00:0000  (00:F3E4)           RG5SAV  equ 0xF3E4
       9.  00:0000  (00:F3E5)           RG6SAV  equ 0xF3E5
      10.  00:0000  (00:F3E6)           RG7SAV  equ 0xF3E6
      11.  00:0000                      // MSX 2
      12.  00:0000  (00:FFE7)           RG8SAV  equ 0xFFE7 
      13.  00:0000  (00:FFE8)           RG9SAV  equ 0xFFE8 
      14.  00:0000  (00:FFE9)           RG10SAV equ 0xFFE9 
      15.  00:0000  (00:FFEA)           RG11SAV equ 0xFFEA 
      16.  00:0000  (00:FFEB)           RG12SAV equ 0xFFEB 
      17.  00:0000  (00:FFEC)           RG13SAV equ 0xFFEC 
      18.  00:0000  (00:FFED)           RG14SAV equ 0xFFED 
      19.  00:0000  (00:FFEE)           RG15SAV equ 0xFFEE 
      20.  00:0000  (00:FFEF)           RG16SAV equ 0xFFEF 
      21.  00:0000  (00:FFF0)           RG17SAV equ 0xFFF0 
      22.  00:0000  (00:FFF1)           RG18SAV equ 0xFFF1 
      23.  00:0000  (00:FFF2)           RG19SAV equ 0xFFF2 
      24.  00:0000  (00:FFF3)           RG20SAV equ 0xFFF3 
      25.  00:0000  (00:FFF4)           RG21SAV equ 0xFFF4 
      26.  00:0000  (00:FFF5)           RG22SAV equ 0xFFF5 
      27.  00:0000  (00:FFF7)           RG23SAV equ 0xFFF7 
      28.  00:0000                      
      29.  00:0000  (00:FC9E)           _jiffy: equ 0xFC9E 
      30.  00:0000                      
      31.  00:0000                      	
      32.  00:0000                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      33.  00:0000                      
      34.  00:0000  (00:000C)           max_enem:					equ 12		; max 12
      35.  00:0000  (00:0003)           max_enem_bullets:			equ 3
      36.  00:0000  (00:0002)           max_bullets:				equ 2		; max number of enemies*2 + ms_bullets + enem_bullets + 3 for ms	<= 32 sprites
      37.  00:0000                      
      38.  00:0000  (00:0004)           maxspeed:					equ 4		; the actual speed is divided by 4
      39.  00:0000  (00:00B4)           assault_wave_timer_preset:	equ	3*60	; a wave each 3 seconds
      40.  00:0000  (00:0002)           enemy_bullet_speed:			equ	2	
      41.  00:0000  (00:0078)           xship_rel:					equ (128-8)
      42.  00:0000                      
      43.  00:0000  (00:0100)           mapWidth	equ	256
      44.  00:0000  (00:000B)           mapHeight	equ	11
      45.  00:0000  (00:00A8)           YSIZE		equ	10*16+8
      46.  00:0000                      
      47.  00:0000                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      48.  00:0000                      
      49.  00:0000                      
      50.  00:0000                      	macro setpage_a
      51.  00:0000                    < 		ld	(_kBank3),a
      52.  00:0000                    < 		inc	a
      53.  00:0000                    < 		ld	(_kBank4),a
      54.  00:0000                    < 	endmacro
      55.  00:0000                      	
      56.  00:0000                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  
      26   00:0000                      		
      27   00:0000                      		
      28   00:0000                      		
      29   00:0000  (00)                		page 0
      30   00:4000                      		
      31   00:4000                              org 4000h
      32   00:4000                              dw  4241h,START,0,0,0,0,0,0
      32   00:4000  41 42 F5 45 00 00 00 00 00 00 00 00 00 00 00 00 
      33   00:4010                      
      34   00:4010                      	;-------------------------------------		
      35   00:4010                      
      36   00:4010                      
      37   00:4010                      		include rominit64.asm
       1.  00:4010                      
       2.  00:4010                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
       3.  00:4010                      ; set pages and subslot
       4.  00:4010                      ;
       5.  00:4010                      
       6.  00:4010                      
       7.  00:4010  (00:0024)           ENASLT:			equ		024h
       8.  00:4010  (00:0138)           RSLREG:			equ		0138h
       9.  00:4010  (00:FCC1)           EXPTBL:			equ		0FCC1h	; Bios Slot / Expansion Slot
      10.  00:4010                      
      11.  00:4010                      
      12.  00:4010                      ; ----------------------------
      13.  00:4010                      ; pre-set main slot for page 3
      14.  00:4010                      ; and set sub-slot for page 3
      15.  00:4010                      ; ----------------------------
      16.  00:4010                      	macro	mainslot_setup n
      17.  00:4010                    < 	and		3
      18.  00:4010                    < [2]	rrca
      19.  00:4010                    < 	and		0xC0
      20.  00:4010                    < 	ld		c,a
      21.  00:4010                    < 	ld		a,d
      22.  00:4010                    < 	and		0x3F
      23.  00:4010                    < 	or		c
      24.  00:4010                    < 	ld		c,a					; Primary slot value with main slot in page 3
      25.  00:4010                    < 
      26.  00:4010                    < 	ld		a,b
      27.  00:4010                    < 	and		0x0C
      28.  00:4010                    < [2]	rrca
      29.  00:4010                    < 	and		3
      30.  00:4010                    < 	ld		b,a					; B = Expanded slot in page 3
      31.  00:4010                    < 	ld		a,c
      32.  00:4010                    < 	out		(0A8h),a			; Slot : Main Slot, xx, xx, Main slot
      33.  00:4010                    < 	ld		a,(0FFFFh)
      34.  00:4010                    < 	cpl
      35.  00:4010                    < 	if (n<=4)
      36.  00:4010                    < [n]	RLCA
      37.  00:4010                    < 	else
      38.  00:4010                    < [8-n] RRCA	
      39.  00:4010                    < 	endif
      40.  00:4010                    < 	and		0xFC
      41.  00:4010                    < 	or		b
      42.  00:4010                    < 	if (n<=4)
      43.  00:4010                    < [n]	RRCA
      44.  00:4010                    < 	else
      45.  00:4010                    < [8-n] RLCA
      46.  00:4010                    < 	endif
      47.  00:4010                    < 	ld		(0FFFFh),a		; Expanded slot selected
      48.  00:4010                    < 	ld		b,a				; save for later	
      49.  00:4010                    < 	endmacro
      50.  00:4010                      		
      51.  00:4010                      
      52.  00:4010                      ; ------------------------------
      53.  00:4010                      ; SEARCH_SLOT
      54.  00:4010                      ; look for the slot of our rom
      55.  00:4010                      ; active in page 1
      56.  00:4010                      ; ------------------------------
      57.  00:4010                      
      58.  00:4010                      search_slot:
      59.  00:4010  CD 38 01            	call	RSLREG
      60.  00:4013  0F 0F               [2]	rrca
      61.  00:4015  E6 03               	and		3
      62.  00:4017  4F                  	ld		c,a
      63.  00:4018  06 00               	ld		b,0
      64.  00:401A  21 C1 FC            	ld		hl,EXPTBL
      65.  00:401D  09                  	add		hl,bc
      66.  00:401E  7E                  	ld		a,(hl)
      67.  00:401F  E6 80               	and		080h
      68.  00:4021  B1                  	or		c
      69.  00:4022  4F                  	ld		c,a
      70.  00:4023  23 23 23 23         [4]	inc		hl
      71.  00:4027  7E                  	ld		a,(hl)
      72.  00:4028  E6 0C               	and		0Ch
      73.  00:402A  B1                  	or		c
      74.  00:402B  32 00 C0            	ld		(slotvar),a
      75.  00:402E  C9                  	ret
      76.  00:402F                      	
      77.  00:402F                      ; ------------------------------
      78.  00:402F                      ; look for the slot of ram
      79.  00:402F                      ; active in page 3
      80.  00:402F                      ; ------------------------------
      81.  00:402F                      
      82.  00:402F                      search_slotram:
      83.  00:402F  F3                  	di
      84.  00:4030  CD 38 01            	call	RSLREG
      85.  00:4033  07 07               [2]	rlca
      86.  00:4035  E6 03               	and		3
      87.  00:4037  4F                  	ld		c,a
      88.  00:4038  06 00               	ld		b,0
      89.  00:403A  21 C1 FC            	ld		hl,EXPTBL
      90.  00:403D  09                  	add		hl,bc
      91.  00:403E  7E                  	ld		a,(hl)
      92.  00:403F  E6 80               	and		080h
      93.  00:4041  28 0D               	jr		z,search_slotram0
      94.  00:4043  B1                  	or		c
      95.  00:4044  4F                  	ld		c,a
      96.  00:4045  23 23 23 23         [4]	inc		hl
      97.  00:4049  7E                  	ld		a,(hl)
      98.  00:404A  07 07 07 07         [4]	rlca
      99.  00:404E  E6 0C               	and		0Ch
     100.  00:4050                      search_slotram0:
     101.  00:4050  B1                  	or		c
     102.  00:4051  32 01 C0            	ld		(slotram),a
     103.  00:4054  C9                  	ret
     104.  00:4055                      	
     105.  00:4055                      ; ------------------------------
     106.  00:4055                      ; SETROMPAGE0
     107.  00:4055                      ; Set the chart in
     108.  00:4055                      ; Page 0
     109.  00:4055                      ; -----------------------------
     110.  00:4055                      
     111.  00:4055                      setrompage0:
     112.  00:4055  3A 00 C0            	ld		a,(slotvar)
     113.  00:4058  C3 7C 40            	jp		setslotpage0
     114.  00:405B                      
     115.  00:405B                      setrampage0:
     116.  00:405B  3A 01 C0            	ld		a,(slotram)
     117.  00:405E  C3 7C 40            	jp		setslotpage0
     118.  00:4061                      
     119.  00:4061                      setrompage2:
     120.  00:4061  3A 00 C0            	ld		a,(slotvar)
     121.  00:4064  C3 F2 40            	jp		setslotpage2
     122.  00:4067                      
     123.  00:4067                      setrampage2:
     124.  00:4067  3A 01 C0            	ld		a,(slotram)
     125.  00:406A  C3 F2 40            	jp		setslotpage2
     126.  00:406D                      	
     127.  00:406D                      setrompage3:
     128.  00:406D  3A 00 C0            	ld		a,(slotvar)
     129.  00:4070  C3 39 41            	jp		setslotpage3
     130.  00:4073                      
     131.  00:4073                      setrampage3:
     132.  00:4073  3A 01 C0            	ld		a,(slotram)
     133.  00:4076  C3 39 41            	jp		setslotpage3
     134.  00:4079                      	
     135.  00:4079                      ; ------------------------------
     136.  00:4079                      ; RECBIOS
     137.  00:4079                      ; set the bios ROM
     138.  00:4079                      ; -------------------------------
     139.  00:4079                      recbios:
     140.  00:4079  3A C1 FC            	ld		a,(EXPTBL)
     141.  00:407C                      
     142.  00:407C                      ; ---------------------------
     143.  00:407C                      ; SETSLOTPAGE0
     144.  00:407C                      ; Set the slot passed in A
     145.  00:407C                      ; at page 0 in the Z80 address space
     146.  00:407C                      ; A: Format FxxxSSPP
     147.  00:407C                      ; ----------------------------
     148.  00:407C                      
     149.  00:407C                      setslotpage0:
     150.  00:407C  F3                  	di
     151.  00:407D  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     152.  00:407E  DB A8               	in		a,(0A8h)
     153.  00:4080  E6 FC               	and		0xFC
     154.  00:4082  57                  	ld		d,a					; D = Primary slot value
     155.  00:4083  78                  	ld		a,b
     156.  00:4084  E6 03               	and		3
     157.  00:4086  B2                  	or		d
     158.  00:4087  57                  	ld		d,a		; D = Final Value for primary slot
     159.  00:4088  78                  	ld		a,b		; Check if expanded
     160.  00:4089  CB 7F               	bit		7,a
     161.  00:408B  28 22               	jr		z,1f	; Not Expanded
     162.  00:408D                      	mainslot_setup	0
     162.  00:408D  E6 03             >  and  3
     162.  00:408F  0F 0F             > [2] rrca
     162.  00:4091  E6 C0             >  and  0xC0
     162.  00:4093  4F                >  ld  c,a
     162.  00:4094  7A                >  ld  a,d
     162.  00:4095  E6 3F             >  and  0x3F
     162.  00:4097  B1                >  or  c
     162.  00:4098  4F                >  ld  c,a
     162.  00:4099                    > 
     162.  00:4099  78                >  ld  a,b
     162.  00:409A  E6 0C             >  and  0x0C
     162.  00:409C  0F 0F             > [2] rrca
     162.  00:409E  E6 03             >  and  3
     162.  00:40A0  47                >  ld  b,a
     162.  00:40A1  79                >  ld  a,c
     162.  00:40A2  D3 A8             >  out  (0A8h),a
     162.  00:40A4  3A FF FF          >  ld  a,(0FFFFh)
     162.  00:40A7  2F                >  cpl
     162.  00:40A8                    >  if (n<=4)
     162.  00:40A8                    > [n] RLCA
     162.  00:40A8                    >  else
     162.  00:40A8                    ~ [8-n] RRCA
     162.  00:40A8                    ~  endif
     162.  00:40A8  E6 FC             >  and  0xFC
     162.  00:40AA  B0                >  or  b
     162.  00:40AB                    >  if (n<=4)
     162.  00:40AB                    > [n] RRCA
     162.  00:40AB                    >  else
     162.  00:40AB                    ~ [8-n] RLCA
     162.  00:40AB                    ~  endif
     162.  00:40AB  32 FF FF          >  ld  (0FFFFh),a
     162.  00:40AE  47                >  ld  b,a
     163.  00:40AF  7A                  1:	ld		a,d				; A = Final value
     164.  00:40B0  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     165.  00:40B2  C9                  	ret
     166.  00:40B3                      
     167.  00:40B3                      ; ---------------------------
     168.  00:40B3                      ; SETSLOTPAGE1
     169.  00:40B3                      ; Set the slot passed in A
     170.  00:40B3                      ; at page 1 in the Z80 address space
     171.  00:40B3                      ; A: Format FxxxSSPP
     172.  00:40B3                      ; ----------------------------
     173.  00:40B3                      
     174.  00:40B3                      setslotpage1:
     175.  00:40B3  F3                  	di
     176.  00:40B4  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     177.  00:40B5  DB A8               	in		a,(0A8h)
     178.  00:40B7  0F 0F               [2]	RRCA
     179.  00:40B9  E6 FC               	and		0xFC
     180.  00:40BB  57                  	ld		d,a					; D = Primary slot value
     181.  00:40BC  78                  	ld		a,b
     182.  00:40BD  E6 03               	and		3
     183.  00:40BF  B2                  	or		d
     184.  00:40C0  07 07               [2]	RLCA
     185.  00:40C2  57                  	ld		d,a		; D = Final Value for primary slot
     186.  00:40C3  78                  	ld		a,b		; Check if expanded
     187.  00:40C4  CB 7F               	bit		7,a
     188.  00:40C6  28 26               	jr		z,1f	; Not Expanded
     189.  00:40C8                      	mainslot_setup	6
     189.  00:40C8  E6 03             >  and  3
     189.  00:40CA  0F 0F             > [2] rrca
     189.  00:40CC  E6 C0             >  and  0xC0
     189.  00:40CE  4F                >  ld  c,a
     189.  00:40CF  7A                >  ld  a,d
     189.  00:40D0  E6 3F             >  and  0x3F
     189.  00:40D2  B1                >  or  c
     189.  00:40D3  4F                >  ld  c,a
     189.  00:40D4                    > 
     189.  00:40D4  78                >  ld  a,b
     189.  00:40D5  E6 0C             >  and  0x0C
     189.  00:40D7  0F 0F             > [2] rrca
     189.  00:40D9  E6 03             >  and  3
     189.  00:40DB  47                >  ld  b,a
     189.  00:40DC  79                >  ld  a,c
     189.  00:40DD  D3 A8             >  out  (0A8h),a
     189.  00:40DF  3A FF FF          >  ld  a,(0FFFFh)
     189.  00:40E2  2F                >  cpl
     189.  00:40E3                    >  if (n<=4)
     189.  00:40E3                    ~ [n] RLCA
     189.  00:40E3                    ~  else
     189.  00:40E3  0F 0F             > [8-n] RRCA
     189.  00:40E5                    >  endif
     189.  00:40E5  E6 FC             >  and  0xFC
     189.  00:40E7  B0                >  or  b
     189.  00:40E8                    >  if (n<=4)
     189.  00:40E8                    ~ [n] RRCA
     189.  00:40E8                    ~  else
     189.  00:40E8  07 07             > [8-n] RLCA
     189.  00:40EA                    >  endif
     189.  00:40EA  32 FF FF          >  ld  (0FFFFh),a
     189.  00:40ED  47                >  ld  b,a
     190.  00:40EE  7A                  1:	ld		a,d				; A = Final value
     191.  00:40EF  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     192.  00:40F1  C9                  	ret
     193.  00:40F2                      	
     194.  00:40F2                      
     195.  00:40F2                      ; ---------------------------
     196.  00:40F2                      ; SETSLOTPAGE2
     197.  00:40F2                      ; Set the slot passed in A
     198.  00:40F2                      ; at page 2 in the Z80 address space
     199.  00:40F2                      ; A: Format FxxxSSPP
     200.  00:40F2                      ; ----------------------------
     201.  00:40F2                      
     202.  00:40F2                      setslotpage2:
     203.  00:40F2  F3                  	di
     204.  00:40F3  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     205.  00:40F4  DB A8               	in		a,(0A8h)
     206.  00:40F6  07 07 07 07         [4]	RLCA
     207.  00:40FA  E6 FC               	and		0xFC
     208.  00:40FC  57                  	ld		d,a					; D = Primary slot value
     209.  00:40FD  78                  	ld		a,b
     210.  00:40FE  E6 03               	and		3
     211.  00:4100  B2                  	or		d
     212.  00:4101  0F 0F 0F 0F         [4]	RRCA
     213.  00:4105  57                  	ld		d,a		; D = Final Value for primary slot
     214.  00:4106  78                  	ld		a,b		; Check if expanded
     215.  00:4107  CB 7F               	bit		7,a
     216.  00:4109  28 2A               	jr		z,1f	; Not Expanded
     217.  00:410B                      	mainslot_setup	4
     217.  00:410B  E6 03             >  and  3
     217.  00:410D  0F 0F             > [2] rrca
     217.  00:410F  E6 C0             >  and  0xC0
     217.  00:4111  4F                >  ld  c,a
     217.  00:4112  7A                >  ld  a,d
     217.  00:4113  E6 3F             >  and  0x3F
     217.  00:4115  B1                >  or  c
     217.  00:4116  4F                >  ld  c,a
     217.  00:4117                    > 
     217.  00:4117  78                >  ld  a,b
     217.  00:4118  E6 0C             >  and  0x0C
     217.  00:411A  0F 0F             > [2] rrca
     217.  00:411C  E6 03             >  and  3
     217.  00:411E  47                >  ld  b,a
     217.  00:411F  79                >  ld  a,c
     217.  00:4120  D3 A8             >  out  (0A8h),a
     217.  00:4122  3A FF FF          >  ld  a,(0FFFFh)
     217.  00:4125  2F                >  cpl
     217.  00:4126                    >  if (n<=4)
     217.  00:4126  07 07 07 07       > [n] RLCA
     217.  00:412A                    >  else
     217.  00:412A                    ~ [8-n] RRCA
     217.  00:412A                    ~  endif
     217.  00:412A  E6 FC             >  and  0xFC
     217.  00:412C  B0                >  or  b
     217.  00:412D                    >  if (n<=4)
     217.  00:412D  0F 0F 0F 0F       > [n] RRCA
     217.  00:4131                    >  else
     217.  00:4131                    ~ [8-n] RLCA
     217.  00:4131                    ~  endif
     217.  00:4131  32 FF FF          >  ld  (0FFFFh),a
     217.  00:4134  47                >  ld  b,a
     218.  00:4135  7A                  1:	ld		a,d				; A = Final value
     219.  00:4136  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     220.  00:4138  C9                  	ret
     221.  00:4139                      	
     222.  00:4139                      ; ---------------------------
     223.  00:4139                      ; SETSLOTPAGE3
     224.  00:4139                      ; Set the slot passed in A
     225.  00:4139                      ; at page 3 in the Z80 address space
     226.  00:4139                      ; A: Format FxxxSSPP
     227.  00:4139                      ; ----------------------------
     228.  00:4139                      	
     229.  00:4139                      setslotpage3:
     230.  00:4139  F3                  	di
     231.  00:413A  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     232.  00:413B  DB A8               	in		a,(0A8h)
     233.  00:413D  07 07               [2]	RLCA
     234.  00:413F  E6 FC               	and		0xFC
     235.  00:4141  57                  	ld		d,a					; D = Primary slot value
     236.  00:4142  78                  	ld		a,b
     237.  00:4143  E6 03               	and		3
     238.  00:4145  B2                  	or		d
     239.  00:4146  0F 0F               [2]	RRCA	
     240.  00:4148  57                  	ld		d,a		; D = Final Value for primary slot
     241.  00:4149  78                  	ld		a,b		; Check if expanded
     242.  00:414A  CB 7F               	bit		7,a
     243.  00:414C  28 26               	jr		z,1f	; Not Expanded
     244.  00:414E                      	mainslot_setup	2
     244.  00:414E  E6 03             >  and  3
     244.  00:4150  0F 0F             > [2] rrca
     244.  00:4152  E6 C0             >  and  0xC0
     244.  00:4154  4F                >  ld  c,a
     244.  00:4155  7A                >  ld  a,d
     244.  00:4156  E6 3F             >  and  0x3F
     244.  00:4158  B1                >  or  c
     244.  00:4159  4F                >  ld  c,a
     244.  00:415A                    > 
     244.  00:415A  78                >  ld  a,b
     244.  00:415B  E6 0C             >  and  0x0C
     244.  00:415D  0F 0F             > [2] rrca
     244.  00:415F  E6 03             >  and  3
     244.  00:4161  47                >  ld  b,a
     244.  00:4162  79                >  ld  a,c
     244.  00:4163  D3 A8             >  out  (0A8h),a
     244.  00:4165  3A FF FF          >  ld  a,(0FFFFh)
     244.  00:4168  2F                >  cpl
     244.  00:4169                    >  if (n<=4)
     244.  00:4169  07 07             > [n] RLCA
     244.  00:416B                    >  else
     244.  00:416B                    ~ [8-n] RRCA
     244.  00:416B                    ~  endif
     244.  00:416B  E6 FC             >  and  0xFC
     244.  00:416D  B0                >  or  b
     244.  00:416E                    >  if (n<=4)
     244.  00:416E  0F 0F             > [n] RRCA
     244.  00:4170                    >  else
     244.  00:4170                    ~ [8-n] RLCA
     244.  00:4170                    ~  endif
     244.  00:4170  32 FF FF          >  ld  (0FFFFh),a
     244.  00:4173  47                >  ld  b,a
     245.  00:4174  7A                  1:	ld		a,d				; A = Final value
     246.  00:4175  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     247.  00:4177  C9                  	ret
     248.  00:4178                      
     249.  00:4178                      	
      38   00:4178                      		include vdpio.asm
       1.  00:4178                      
       2.  00:4178                             
       3.  00:4178                      ;-------------------------------------
       4.  00:4178                      _cls:		
       5.  00:4178  0E 00               		ld		c,0
       6.  00:417A  51                  		ld		d,c
       7.  00:417B  59                  		ld		e,c
       8.  00:417C  F3                  		di
       9.  00:417D  CD A5 41            		call	_vdpsetvramwr
      10.  00:4180  41                  		ld		b,c
      11.  00:4181  1E 01               		ld		e,1
      12.  00:4183  AF                  1:		xor		a
      13.  00:4184  D3 98               		out		(0x98),a
      14.  00:4186  ED A1                       cpi
      15.  00:4188  EA 83 41                    jp   	pe,1b
      16.  00:418B  1D                  		dec	e
      17.  00:418C  C2 83 41            		jp		nz,1b
      18.  00:418F  C9                  		ret
      19.  00:4190                      _cls0:
      20.  00:4190  0E 00               		ld		c,0
      21.  00:4192  51                  		ld		d,c
      22.  00:4193  59                  		ld		e,c
      23.  00:4194  F3                  		di
      24.  00:4195  CD A5 41            		call	_vdpsetvramwr
      25.  00:4198  FB                  		ei
      26.  00:4199  01 00 B0            		ld		bc,mapHeight*16*256
      27.  00:419C  AF                  		xor		a
      28.  00:419D  D3 98               1:		out		(0x98),a
      29.  00:419F  ED A1                       cpi
      30.  00:41A1  EA 9D 41                    jp   	pe,1b
      31.  00:41A4  C9                  		ret
      32.  00:41A5                      		
      33.  00:41A5                      ;-------------------------------------
      34.  00:41A5                      		
      35.  00:41A5  (00:0099)           vdpport1 equ 0x99
      36.  00:41A5  (00:009A)           vdpport2 equ 0x9A
      37.  00:41A5                      
      38.  00:41A5                      ; levelcolors:
      39.  00:41A5                      	;  incbin "palette.bin"
      40.  00:41A5                      
      41.  00:41A5                      ; _SetPalet:   
      42.  00:41A5                      		; di
      43.  00:41A5                      		; xor a 			;Set pointer to zero.
      44.  00:41A5                      		; out (vdpport1),a        
      45.  00:41A5                      		; ld  a,16 | 010000000B
      46.  00:41A5                      		; out (vdpport1),a
      47.  00:41A5                      
      48.  00:41A5                      		; ld  hl,levelcolors
      49.  00:41A5                      		; ld bc,vdpport2+32*256
      50.  00:41A5                      		; otir
      51.  00:41A5                      		; ei
      52.  00:41A5                      		; ret
      53.  00:41A5                      
      54.  00:41A5                      ;Set VDP for writing at address CDE (17-bit) 
      55.  00:41A5                      
      56.  00:41A5                      _vdpsetvramwr:
      57.  00:41A5  79                  		ld a,c
      58.  00:41A6                      _vdpsetvramwr2:
      59.  00:41A6                      ;Set VDP for writing at address ADE (17-bit) ;
      60.  00:41A6  CB 02               		rlc d
      61.  00:41A8  17                  		rla
      62.  00:41A9  CB 02               		rlc d
      63.  00:41AB  17                  		rla
      64.  00:41AC  CB 3A               		srl d ; primo shift, il secondo dopo la out
      65.  00:41AE                      
      66.  00:41AE  D3 99               		out (0x99),a ;set bits 14-16
      67.  00:41B0  3E 8E               		ld a,14+128
      68.  00:41B2  D3 99               		out (0x99),a
      69.  00:41B4                      
      70.  00:41B4  CB 3A               		srl d ; secondo shift.     
      71.  00:41B6                      _vdpsetvramwr14
      72.  00:41B6  7B                  		ld a,e ;set bits 0-7
      73.  00:41B7  D3 99               		out (0x99),a
      74.  00:41B9  7A                  		ld a,d ;set bits 8-13
      75.  00:41BA  F6 40               		or 0x40 ; + write access
      76.  00:41BC  D3 99               		out (0x99),a
      77.  00:41BE  C9                  		ret
      78.  00:41BF                      	
      79.  00:41BF                      ;Set VDP port #98 to start reading at address CDE (17-bit) ;
      80.  00:41BF                      
      81.  00:41BF                      _vdpsetvramrd:
      82.  00:41BF  79                  		ld a,c
      83.  00:41C0                      ;Set VDP port #98 to start reading at address ADE (17-bit) ;
      84.  00:41C0  CB 02               		rlc d
      85.  00:41C2  17                  		rla
      86.  00:41C3  CB 02               		rlc d
      87.  00:41C5  17                  		rla
      88.  00:41C6  CB 3A               		srl d 			; primo shift, il secondo dopo la out
      89.  00:41C8                      
      90.  00:41C8  D3 99               		out (0x99),a 	; set bits 14-16
      91.  00:41CA  3E 8E               		ld a,14+128
      92.  00:41CC  D3 99               		out (0x99),a
      93.  00:41CE                      
      94.  00:41CE  CB 3A               		srl d 	; secondo shift.            
      95.  00:41D0  7B                  		ld a,e 	; set bits 0-7
      96.  00:41D1  D3 99               		out (0x99),a
      97.  00:41D3  7A                  		ld a,d 	; set bits 8-13
      98.  00:41D4  E6 3F               		and 0x3F
      99.  00:41D6  D3 99               		out (0x99),a
     100.  00:41D8  C9                  		ret
     101.  00:41D9                      
     102.  00:41D9                      ;Display page E in screen 5
     103.  00:41D9                      _setpage:
     104.  00:41D9  7B                  	ld a,e
     105.  00:41DA  87 87 87 87 87      [5]	add a,a ;x32
     106.  00:41DF  F6 1F               	or	 00011111B
     107.  00:41E1  F3                  	di
     108.  00:41E2  D3 99               	out (0x99),a
     109.  00:41E4  3E 82               	ld a,2+128
     110.  00:41E6  D3 99               	out (0x99),a
     111.  00:41E8  FB                  	ei            
     112.  00:41E9  C9                  	ret
     113.  00:41EA                      
     114.  00:41EA  (00:005F)           chgmod        equ     0x005f      ;change graphic mode
     115.  00:41EA  (00:000C)           RDSLT         equ     0x000c      ;read address HL in slot A
     116.  00:41EA  (00:0156)           KILBUF        equ     0x0156      ;clear keyboard buffer
     117.  00:41EA                      
     118.  00:41EA                      set_scr:
     119.  00:41EA                      	
     120.  00:41EA                      	// sprites 16x16
     121.  00:41EA  3A E0 F3            	ld		a,(RG1SAV)
     122.  00:41ED  F6 02               	or		00000010B
     123.  00:41EF  32 E0 F3            	ld		(RG1SAV),a
     124.  00:41F2                      
     125.  00:41F2                      	// enable sprites + TP
     126.  00:41F2  3A E7 FF            	ld		a,(RG8SAV)
     127.  00:41F5                      	; or		00100010B
     128.  00:41F5  F6 20               	or		00100000B
     129.  00:41F7  32 E7 FF            	ld		(RG8SAV),a
     130.  00:41FA                      		
     131.  00:41FA                      	// Set @50Hz (only PAL is supported)
     132.  00:41FA  3A 02 C0            	ld	a,(SEL_NTSC)
     133.  00:41FD  A7                  	and 	a
     134.  00:41FE  20 07               	jr		nz,1f
     135.  00:4200                      	
     136.  00:4200  3A E8 FF            	ld		a,(RG9SAV)		
     137.  00:4203  F6 02               	or		00000010B		; PAL
     138.  00:4205  18 05               	jr	2f
     139.  00:4207                      1:		
     140.  00:4207  3A E8 FF            	ld		a,(RG9SAV)		
     141.  00:420A  E6 FD               	and		11111101B		; NTSC 
     142.  00:420C  32 E8 FF            2:	ld		(RG9SAV),a
     143.  00:420F                      
     144.  00:420F  3E 08               	ld  	a,8
     145.  00:4211  CD 5F 00            	call	chgmod
     146.  00:4214                      
     147.  00:4214  3A E8 FF            	ld		a,(RG9SAV)		
     148.  00:4217  E6 7F               	and		01111111B		; 192 lines	
     149.  00:4219  32 E8 FF            	ld		(RG9SAV),a
     150.  00:421C  D3 99               	out		(0x99),a
     151.  00:421E  3E 89               	ld		a,9+128
     152.  00:4220  D3 99               	out		(0x99),a
     153.  00:4222                      	
     154.  00:4222                      	// border color
     155.  00:4222  AF                  	xor		a
     156.  00:4223  32 E6 F3            	ld		(RG7SAV),a
     157.  00:4226  D3 99               	out		(0x99),a
     158.  00:4228  3E 87               	ld		a,7+128
     159.  00:422A  D3 99               	out		(0x99),a
     160.  00:422C  C9                  	ret
     161.  00:422D                      
     162.  00:422D                      
     163.  00:422D                      _waitvdp:
     164.  00:422D  3E 02               	ld a,2
     165.  00:422F  D3 99               	out (0x99),a
     166.  00:4231  3E 8F               	ld a, 128+15
     167.  00:4233  D3 99               	out (0x99),a
     168.  00:4235  DB 99               1:  in	a,(0x99)
     169.  00:4237  0F                  	rrca
     170.  00:4238  DA 35 42            	jp c,1b
     171.  00:423B                      
     172.  00:423B  C9                  	ret
     173.  00:423C                      
     174.  00:423C                      ; .inf:
     175.  00:423C                      	; ld	a,r			; random colour
     176.  00:423C                      	; out		(0x99),a
     177.  00:423C                      	; ld		a,7+128
     178.  00:423C                      	; out		(0x99),a
     179.  00:423C                      	; jp	1b
     180.  00:423C                      	
      39   00:423C                      		include isr.asm
       1.  00:423C                      
       2.  00:423C                      		; include "header.asm"
       3.  00:423C                      
       4.  00:423C                      
       5.  00:423C                      _fake_isr
       6.  00:423C  F5                  		push	af
       7.  00:423D                      		; xor		a
       8.  00:423D                      		; out		(0x99),a
       9.  00:423D                      		; ld		a,7+128
      10.  00:423D                      		; out		(0x99),a
      11.  00:423D                      		
      12.  00:423D                      		; ld	a,(halfrate)
      13.  00:423D                      		; xor	255
      14.  00:423D                      		; ld	(halfrate),a				
      15.  00:423D                      		; jr	z,1f
      16.  00:423D                      		
      17.  00:423D  E5                  		push   hl         
      18.  00:423E  D5                  		push   de         
      19.  00:423F  C5                  		push   bc         
      20.  00:4240  D9                  		exx               
      21.  00:4241  08                  		ex     af,af'     
      22.  00:4242  E5                  		push   hl         
      23.  00:4243  D5                  		push   de         
      24.  00:4244  C5                  		push   bc         
      25.  00:4245  F5                  		push   af         
      26.  00:4246  FD E5               		push   iy         
      27.  00:4248  DD E5               		push   ix         
      28.  00:424A                      
      29.  00:424A  3E E0               		ld		a,11100000B
      30.  00:424C  D3 99               		out		(0x99),a
      31.  00:424E  3E 87               		ld		a,7+128
      32.  00:4250  D3 99               		out		(0x99),a
      33.  00:4252                      
      34.  00:4252  CD 82 42            		call	fsm
      35.  00:4255                      		
      36.  00:4255                      		; ld		e,240-16
      37.  00:4255                      		; ld		d,240-32
      38.  00:4255                      		; call	move_slice
      39.  00:4255                      		
      40.  00:4255                      		; call	brdrs
      41.  00:4255                      
      42.  00:4255                      		; ld		a,11100011B
      43.  00:4255                      		; out		(0x99),a
      44.  00:4255                      		; ld		a,7+128
      45.  00:4255                      		; out		(0x99),a
      46.  00:4255                      
      47.  00:4255                      		; call 	_waitvdp		
      48.  00:4255                      
      49.  00:4255  2A 9E FC            		ld	hl,(_jiffy)
      50.  00:4258  23                  		inc	hl
      51.  00:4259  22 9E FC            		ld	(_jiffy),hl
      52.  00:425C  3E 0F               		ld	a,15
      53.  00:425E  A5                  		and	l
      54.  00:425F  32 05 C0            		ld	(_xoffset),a
      55.  00:4262                      		
      56.  00:4262  AF                  		xor		a
      57.  00:4263  D3 99               		out		(0x99),a
      58.  00:4265  3E 87               		ld		a,7+128
      59.  00:4267  D3 99               		out		(0x99),a
      60.  00:4269                      		
      61.  00:4269  DD E1               		pop    ix         
      62.  00:426B  FD E1               		pop    iy         
      63.  00:426D  F1                  		pop    af         
      64.  00:426E  C1                  		pop    bc         
      65.  00:426F  D1                  		pop    de         
      66.  00:4270  E1                  		pop    hl         
      67.  00:4271  08                  		ex     af,af'     
      68.  00:4272  D9                  		exx               
      69.  00:4273  C1                  		pop    bc         
      70.  00:4274  D1                  		pop    de         
      71.  00:4275  E1                  		pop    hl         
      72.  00:4276                      
      73.  00:4276                      1:		
      74.  00:4276  AF                  		xor	a 			; read S#0
      75.  00:4277  D3 99               		out (0x99),a
      76.  00:4279  3E 8F               		ld a,128+15
      77.  00:427B  D3 99               		out (0x99),a
      78.  00:427D  DB 99               		in	a,(0x99)
      79.  00:427F  F1                  		pop	af
      80.  00:4280  FB                  		ei
      81.  00:4281  C9                  		ret
      82.  00:4282                      
      83.  00:4282                      
      84.  00:4282                      ; _isrinit:
      85.  00:4282                      		; di
      86.  00:4282                      		; ld	hl,0x0038
      87.  00:4282                      		; ld	(hl),0xC3
      88.  00:4282                      		; inc	hl
      89.  00:4282                      		; ld	(hl),low _scroll
      90.  00:4282                      		; inc	hl
      91.  00:4282                      		; ld	(hl),high _scroll
      92.  00:4282                      
      93.  00:4282                      ; ; set interrupt line
      94.  00:4282                      		; LD    A,YSIZE-1
      95.  00:4282                      		; out (0x99),a
      96.  00:4282                      		; LD    A,19+128
      97.  00:4282                      		; out (0x99),a
      98.  00:4282                      	
      99.  00:4282                      ; ; enable line interrupt
     100.  00:4282                      		; LD    A,(RG0SAV)
     101.  00:4282                      		; OR    00010000B
     102.  00:4282                      		; LD    (RG0SAV),A
     103.  00:4282                      		; out (0x99),a
     104.  00:4282                      		; LD    A,0+128
     105.  00:4282                      		; out (0x99),a
     106.  00:4282                      		; ei
     107.  00:4282                      		; ret
     108.  00:4282                      	
     109.  00:4282                      ; _intreset:
     110.  00:4282                      		; di
     111.  00:4282                      		; ld	hl,0x0038
     112.  00:4282                      		; ld	(hl),0xC3
     113.  00:4282                      		; inc	hl
     114.  00:4282                      		; ld	(hl),low _fake_isr
     115.  00:4282                      		; inc	hl
     116.  00:4282                      		; ld	(hl),high _fake_isr
     117.  00:4282                      
     118.  00:4282                      ; ; disable line interrupt		
     119.  00:4282                      		; LD    A,(RG0SAV)
     120.  00:4282                      		; and    11101111B
     121.  00:4282                      		; LD    (RG0SAV),A
     122.  00:4282                      		; out (0x99),a
     123.  00:4282                      		; LD    A,0+128
     124.  00:4282                      		; out (0x99),a
     125.  00:4282                      		; ei
     126.  00:4282                      		; ret
     127.  00:4282                      	
     128.  00:4282                      ; ;;;;;;;;;;;;;;;;;;;;;;
     129.  00:4282                      ; ; actual ISR handler
     130.  00:4282                      ; ;;;;;;;;;;;;;;;;;;;;;;
     131.  00:4282                      
     132.  00:4282                      ; _scroll:
     133.  00:4282                      		; push	af
     134.  00:4282                      		
     135.  00:4282                      		; ld a,1 			; read S#1
     136.  00:4282                      		; out (0x99),a
     137.  00:4282                      		; ld a,128+15
     138.  00:4282                      		; out (0x99),a
     139.  00:4282                      		 
     140.  00:4282                      		; in	a,(0x99)
     141.  00:4282                      		; rra
     142.  00:4282                      		; jp	c,lint	
     143.  00:4282                      
     144.  00:4282                      		; xor	a 			; read S#0
     145.  00:4282                      		; out (0x99),a
     146.  00:4282                      		; ld a,128+15
     147.  00:4282                      		; out (0x99),a
     148.  00:4282                      		 
     149.  00:4282                      		; in	a,(0x99)
     150.  00:4282                      		; rlca
     151.  00:4282                      		; jp	c,vblank
     152.  00:4282                      		
     153.  00:4282                      		; pop	af			; none of them (?)
     154.  00:4282                      		; ei
     155.  00:4282                      		; ret
     156.  00:4282                      	
     157.  00:4282                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;	
     158.  00:4282                      ; ; manage score bar at YSIZE
     159.  00:4282                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;	
     160.  00:4282                      ; waitHBLANK
     161.  00:4282                      		; ld a,2 				; read S#2
     162.  00:4282                      		; out (0x99),a
     163.  00:4282                      		; ld a,128+15
     164.  00:4282                      		; out (0x99),a		; poll for HBLANK
     165.  00:4282                      		 
     166.  00:4282                      ; ; 1:	in	a,(0x99)		; we are in HBLANK already, so wait until end of HBLANK
     167.  00:4282                      ; ; 		and	0x20
     168.  00:4282                      ; ; 		jp	nz,1b			
     169.  00:4282                      
     170.  00:4282                      ; 2:		in	a,(0x99)		; wait until end of the active area
     171.  00:4282                      		; and	0x20
     172.  00:4282                      		; jp	z,2b
     173.  00:4282                      		; ret
     174.  00:4282                      	
     175.  00:4282                      ; lint:	
     176.  00:4282                      		; ; call	waitHBLANK
     177.  00:4282                      		; ; now we are at the start of HBLANK
     178.  00:4282                      	
     179.  00:4282                      		; ; ld	a,(RG1SAV)
     180.  00:4282                      		; ; and	010111111B			; disable screen
     181.  00:4282                      		; ; ld	(RG1SAV),a
     182.  00:4282                      		; ; out	(0x99),a
     183.  00:4282                      		; ; ld	a,1+128
     184.  00:4282                      		; ; out	(0x99),a
     185.  00:4282                      
     186.  00:4282                      
     187.  00:4282                      		; ld a,00011111B		; 0XX11111B
     188.  00:4282                      		; out (0x99),a
     189.  00:4282                      		; ld a,2+128			; R#2 
     190.  00:4282                      		; out (0x99),a		; score bar in page 0
     191.  00:4282                      
     192.  00:4282                      		; LD    A,mapHeight*16-(YSIZE-2)	; SCROLL DOWN
     193.  00:4282                      		; out (0x99),a
     194.  00:4282                      		; LD    A,23+128
     195.  00:4282                      		; out (0x99),a
     196.  00:4282                      
     197.  00:4282                      		; xor		a
     198.  00:4282                      		; out	(099h),a
     199.  00:4282                      		; ld	a,18+128
     200.  00:4282                      		; out	(099h),a		; set adjust 0,0
     201.  00:4282                      
     202.  00:4282                      
     203.  00:4282                      		; ld	a,(RG8SAV)
     204.  00:4282                      		; or	000000010B		; disable sprites
     205.  00:4282                      		; ld	(RG8SAV),a
     206.  00:4282                      		; out	(0x99),a
     207.  00:4282                      		; ld	a,8+128
     208.  00:4282                      		; out	(0x99),a
     209.  00:4282                      
     210.  00:4282                      		; ; call	waitHBLANK
     211.  00:4282                      		
     212.  00:4282                      		; ; ld	a,(RG1SAV)
     213.  00:4282                      		; ; or 	01000010B		; enable screen
     214.  00:4282                      		; ; ld	(RG1SAV),a
     215.  00:4282                      		; ; out	(0x99),a
     216.  00:4282                      		; ; ld	a,1+128
     217.  00:4282                      		; ; out	(0x99),a
     218.  00:4282                      	
     219.  00:4282                      		; push   hl         
     220.  00:4282                      		; push   de         
     221.  00:4282                      		; push   bc         
     222.  00:4282                      		; exx               
     223.  00:4282                      		; ex     af,af'     
     224.  00:4282                      		; push   hl         
     225.  00:4282                      		; push   de         
     226.  00:4282                      		; push   bc         
     227.  00:4282                      		; push   af         
     228.  00:4282                      		; push   iy         
     229.  00:4282                      		; push   ix         
     230.  00:4282                      
     231.  00:4282                      		
     232.  00:4282                      		; ld	hl,.exit
     233.  00:4282                      		; push	hl
     234.  00:4282                      		; ld		a,(dxmap)
     235.  00:4282                      		; rlc a
     236.  00:4282                      
     237.  00:4282                      		; jp	nc,_blank_line_lft		; >0 == dx
     238.  00:4282                      		; jp	 c,_blank_line_rgt		; <0 == sx
     239.  00:4282                      ; 1:		pop	hl
     240.  00:4282                      ; .exit:
     241.  00:4282                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     242.  00:4282                      		; ; ld		a,00001000B
     243.  00:4282                      		; ; out		(0x99),a
     244.  00:4282                      		; ; ld		a,7+128
     245.  00:4282                      		; ; out		(0x99),a
     246.  00:4282                      		
     247.  00:4282                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     248.  00:4282                      		; call	test_star
     249.  00:4282                      
     250.  00:4282                      		; xor		a
     251.  00:4282                      		; out		(0x99),a
     252.  00:4282                      		; ld		a,7+128
     253.  00:4282                      		; out		(0x99),a
     254.  00:4282                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     255.  00:4282                      		
     256.  00:4282                      		; pop    ix         
     257.  00:4282                      		; pop    iy         
     258.  00:4282                      		; pop    af         
     259.  00:4282                      		; pop    bc         
     260.  00:4282                      		; pop    de         
     261.  00:4282                      		; pop    hl         
     262.  00:4282                      		; ex     af,af'     
     263.  00:4282                      		; exx               
     264.  00:4282                      		; pop    bc         
     265.  00:4282                      		; pop    de         
     266.  00:4282                      		; pop    hl         
     267.  00:4282                      
     268.  00:4282                      		; pop		af
     269.  00:4282                      		; ei
     270.  00:4282                      		; ret
     271.  00:4282                      
     272.  00:4282                      ; ;-------------------------------------		
     273.  00:4282                      
     274.  00:4282                      ; border_color	equ 	0;	00100101B
     275.  00:4282                      		
     276.  00:4282                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;	
     277.  00:4282                      ; ;   manage normal vblank routine
     278.  00:4282                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;	
     279.  00:4282                      
     280.  00:4282                      ; vblank:
     281.  00:4282                      		; call	activate_window	
     282.  00:4282                      
     283.  00:4282                      		; push   hl         
     284.  00:4282                      		; push   de         
     285.  00:4282                      		; push   bc         
     286.  00:4282                      		; exx               
     287.  00:4282                      		; ex     af,af'     
     288.  00:4282                      		; push   hl         
     289.  00:4282                      		; push   de         
     290.  00:4282                      		; push   bc         
     291.  00:4282                      		; push   af         
     292.  00:4282                      		; push   iy         
     293.  00:4282                      		; push   ix         
     294.  00:4282                      
     295.  00:4282                      		; ; ld	a,00011100B		; red
     296.  00:4282                      		; ; out		(0x99),a
     297.  00:4282                      		; ; ld		a,7+128
     298.  00:4282                      		; ; out		(0x99),a
     299.  00:4282                      
     300.  00:4282                      		; call	changedir
     301.  00:4282                      				
     302.  00:4282                      		; ld	hl,(_jiffy)
     303.  00:4282                      		; inc	hl
     304.  00:4282                      		; ld	(_jiffy),hl
     305.  00:4282                      				
     306.  00:4282                      		; ; ld	a,00011100B		; red
     307.  00:4282                      		; ; out	(0x99),a
     308.  00:4282                      		; ; ld	a,7+128
     309.  00:4282                      		; ; out	(0x99),a
     310.  00:4282                      		
     311.  00:4282                      
     312.  00:4282                      		; ; xor		a		; black
     313.  00:4282                      		; ; out	(0x99),a
     314.  00:4282                      		; ; ld	a,7+128
     315.  00:4282                      		; ; out	(0x99),a
     316.  00:4282                      	
     317.  00:4282                      		; pop    ix         
     318.  00:4282                      		; pop    iy         
     319.  00:4282                      		; pop    af         
     320.  00:4282                      		; pop    bc         
     321.  00:4282                      		; pop    de         
     322.  00:4282                      		; pop    hl         
     323.  00:4282                      		; ex     af,af'     
     324.  00:4282                      		; exx               
     325.  00:4282                      		; pop    bc         
     326.  00:4282                      		; pop    de         
     327.  00:4282                      		; pop    hl         
     328.  00:4282                      
     329.  00:4282                      		; pop		af
     330.  00:4282                      		; ei
     331.  00:4282                      		; ret
     332.  00:4282                      ; ;-------------------------------------
     333.  00:4282                      ; ;-------------------------------------
     334.  00:4282                      
     335.  00:4282                      ; _blank_line_lft:
     336.  00:4282                      		; ; ld	a,00000111B		; blue
     337.  00:4282                      		; ; out	(0x99),a
     338.  00:4282                      		; ; ld	a,7+128
     339.  00:4282                      		; ; out	(0x99),a
     340.  00:4282                      
     341.  00:4282                      		; ld	e,0
     342.  00:4282                      		; call	blank_line
     343.  00:4282                      
     344.  00:4282                      		
     345.  00:4282                      		
     346.  00:4282                      		; ; xor	a
     347.  00:4282                      		; ; out	(0x99),a
     348.  00:4282                      		; ; ld	a,7+128
     349.  00:4282                      		; ; out	(0x99),a
     350.  00:4282                      		; ret
     351.  00:4282                      
     352.  00:4282                      ; ;-------------------------------------	
     353.  00:4282                      
     354.  00:4282                      ; _blank_line_rgt
     355.  00:4282                      		; ; ld	a,00000111B		; blue
     356.  00:4282                      		; ; out	(0x99),a
     357.  00:4282                      		; ; ld	a,7+128
     358.  00:4282                      		; ; out	(0x99),a
     359.  00:4282                      
     360.  00:4282                      		; ld	e,240
     361.  00:4282                      		; call	blank_line
     362.  00:4282                      
     363.  00:4282                      		; ; xor	a
     364.  00:4282                      		; ; out	(0x99),a
     365.  00:4282                      		; ; ld	a,7+128
     366.  00:4282                      		; ; out	(0x99),a
     367.  00:4282                      		; ret
     368.  00:4282                      		
     369.  00:4282                      ; ;-------------------------------------	
     370.  00:4282                      		
     371.  00:4282                      ; inc_xoffset
     372.  00:4282                      		; call	plot_line_rgt1
     373.  00:4282                      		; call	.movex
     374.  00:4282                      		; call	plot_line_rgt2
     375.  00:4282                      				
     376.  00:4282                      		; ; ld	a,00000010B		; blue
     377.  00:4282                      		; ; out	(0x99),a
     378.  00:4282                      		; ; ld	a,7+128
     379.  00:4282                      		; ; out	(0x99),a
     380.  00:4282                      		
     381.  00:4282                      		; jp		newxmap
     382.  00:4282                      		
     383.  00:4282                      ; .movex
     384.  00:4282                      		; ld		a,(_xoffset)
     385.  00:4282                      		; and		a
     386.  00:4282                      		; jr		nz,.case1_15
     387.  00:4282                      ; .case0
     388.  00:4282                      		; ld 		a,(_displaypage)
     389.  00:4282                      		; xor		1
     390.  00:4282                      		; ld 		d,a
     391.  00:4282                      		; ld		e,240
     392.  00:4282                      		; jp		clrboder
     393.  00:4282                      		
     394.  00:4282                      ; .case1_15
     395.  00:4282                      ; [4]		add		a,a
     396.  00:4282                      		; ld		e,a
     397.  00:4282                      		; sub		a,16
     398.  00:4282                      		; ld		d,a
     399.  00:4282                      		; jp		move_block
     400.  00:4282                      
     401.  00:4282                      
     402.  00:4282                      ; ;-------------------------------------	
     403.  00:4282                      	
     404.  00:4282                      ; dec_xoffset
     405.  00:4282                      		; call	plot_line_lft1
     406.  00:4282                      		; call	.movex
     407.  00:4282                      		; call	plot_line_lft2
     408.  00:4282                      				
     409.  00:4282                      		; ; ld	a,00000011B		; blue
     410.  00:4282                      		; ; out	(0x99),a
     411.  00:4282                      		; ; ld	a,7+128
     412.  00:4282                      		; ; out	(0x99),a
     413.  00:4282                      
     414.  00:4282                      		; jp		newxmap
     415.  00:4282                      		
     416.  00:4282                      ; .movex
     417.  00:4282                      		; ld		a,(_xoffset)
     418.  00:4282                      		; cp	15
     419.  00:4282                      		; jr		nz,.case0_14
     420.  00:4282                      ; .case15
     421.  00:4282                      		; ld 		a,(_displaypage)
     422.  00:4282                      		; xor		1
     423.  00:4282                      		; ld 		d,a
     424.  00:4282                      		; ld		e,0
     425.  00:4282                      		; jp		clrboder
     426.  00:4282                      		
     427.  00:4282                      ; .case0_14
     428.  00:4282                      ; [4]		add		a,a
     429.  00:4282                      		; ld		e,a
     430.  00:4282                      		; add		a,16
     431.  00:4282                      		; ld		d,a
     432.  00:4282                      		; jp		move_block
     433.  00:4282                      
     434.  00:4282                      
     435.  00:4282                      ; ;-------------------------------------
     436.  00:4282                      ; newxmap
     437.  00:4282                      		; call 	plot_enemy		
     438.  00:4282                      		; call	color_enemy
     439.  00:4282                      
     440.  00:4282                      		; ld		hl,(_xmapx4)
     441.  00:4282                      		; ld		a,(dxmap)
     442.  00:4282                      		; ld		e,a
     443.  00:4282                      		; add 	a,a
     444.  00:4282                      		; sbc 	a,a
     445.  00:4282                      		; ld		d,a
     446.  00:4282                      		; add 	hl,de
     447.  00:4282                      		; ld		(_xmapx4),hl
     448.  00:4282                      		; repeat 2
     449.  00:4282                      		; sra		h
     450.  00:4282                      		; rr  	l
     451.  00:4282                      		; endrepeat
     452.  00:4282                      		; ld		(xmap),hl
     453.  00:4282                      		; ld 		a,l
     454.  00:4282                      		; and		15
     455.  00:4282                      		; ld		(_xoffset),a
     456.  00:4282                      		; repeat 4
     457.  00:4282                      		; sra		h
     458.  00:4282                      		; rr  	l
     459.  00:4282                      		; endrepeat
     460.  00:4282                      		; ld 		a,l
     461.  00:4282                      		; and		1
     462.  00:4282                      		; ld		(_displaypage),a
     463.  00:4282                      		; ld		de,_levelmap
     464.  00:4282                      		; add		hl,de
     465.  00:4282                      		; ld		(_levelmap_pos),hl
     466.  00:4282                      		; ret
     467.  00:4282                      		
     468.  00:4282                      ; ;-------------------------------------
     469.  00:4282                      
     470.  00:4282                      ; activate_window	
     471.  00:4282                      		; ld	a,(_displaypage)
     472.  00:4282                      ; [5]		add a,a 			; x32
     473.  00:4282                      		; or	00011111B
     474.  00:4282                      		; out (0x99),a
     475.  00:4282                      		; ld a,2+128
     476.  00:4282                      		; out (0x99),a
     477.  00:4282                      		
     478.  00:4282                      		; LD    A,(_yoffset)		; SCROLL DOWN
     479.  00:4282                      		; out (0x99),a
     480.  00:4282                      		; add    A,YSIZE-1
     481.  00:4282                      		; ld		l,a
     482.  00:4282                      		; LD    A,23+128
     483.  00:4282                      		; out (0x99),a
     484.  00:4282                      
     485.  00:4282                      		; ld    a,l
     486.  00:4282                      		; out (0x99),a			; set interrupt line
     487.  00:4282                      		; LD    A,19+128
     488.  00:4282                      		; out (0x99),a
     489.  00:4282                      		
     490.  00:4282                      		; ld	a,(_xoffset)		; set R#18 only if not scrolling
     491.  00:4282                      		; add	a,-8
     492.  00:4282                      		; and	0Fh
     493.  00:4282                      		; out	(099h),a
     494.  00:4282                      		; ld	a,18+128
     495.  00:4282                      		; out	(099h),a
     496.  00:4282                      
     497.  00:4282                      		; ld	a,(RG8SAV)		; enable sprites
     498.  00:4282                      		; and	11111101B
     499.  00:4282                      		; ld	(RG8SAV),a
     500.  00:4282                      		; out	(0x99),a
     501.  00:4282                      		; ld	a,8+128
     502.  00:4282                      		; out	(0x99),a
     503.  00:4282                      
     504.  00:4282                      		; ret
     505.  00:4282                      			
     506.  00:4282                      ; ;-------------------------------------
     507.  00:4282                      	
     508.  00:4282                      ; changedir:
     509.  00:4282                      		; ld		a,(_dxmap)
     510.  00:4282                      		; and		128
     511.  00:4282                      		; ld		b,a
     512.  00:4282                      		; inc		hl
     513.  00:4282                      		; ld		a,(dxmap)		; dxmap
     514.  00:4282                      		; ld		c,a
     515.  00:4282                      		; and		128
     516.  00:4282                      		; xor		b				; compare signs
     517.  00:4282                      		; jp		z,nodirchange
     518.  00:4282                      		; ld		(_dxchng),a		; a<>0
     519.  00:4282                      		; bit		7,c
     520.  00:4282                      		; jr		z,.right
     521.  00:4282                      ; .left
     522.  00:4282                      		; call	plot_line_lft1
     523.  00:4282                      		; ld 		a,(_displaypage)
     524.  00:4282                      		; xor		1
     525.  00:4282                      		; ld 		d,a
     526.  00:4282                      		; ld		e,0
     527.  00:4282                      		; call	clrboder
     528.  00:4282                      		; call	plot_line_lft2
     529.  00:4282                      		; jp		newxmap
     530.  00:4282                      
     531.  00:4282                      ; .right
     532.  00:4282                      		; call	plot_line_rgt1
     533.  00:4282                      		; ld 		a,(_displaypage)
     534.  00:4282                      		; xor		1
     535.  00:4282                      		; ld 		d,a
     536.  00:4282                      		; ld		e,240
     537.  00:4282                      		; call	clrboder
     538.  00:4282                      		; call	plot_line_rgt2
     539.  00:4282                      		; jp		newxmap
     540.  00:4282                      
     541.  00:4282                      ; nodirchange:
     542.  00:4282                      		; ld		a,(_dxchng)
     543.  00:4282                      		; and		a
     544.  00:4282                      		; jr		nz,1f
     545.  00:4282                      		; bit		7,c
     546.  00:4282                      		; jp		z,inc_xoffset
     547.  00:4282                      		; jp		dec_xoffset
     548.  00:4282                      	
     549.  00:4282                      ; 1:		xor	a
     550.  00:4282                      		; ld		(_dxchng),a
     551.  00:4282                      		; bit		7,c
     552.  00:4282                      		; jp		z,.right
     553.  00:4282                      ; .left
     554.  00:4282                      		; call	plot_line_lft1
     555.  00:4282                      		; ld		e,240-16
     556.  00:4282                      		; ld		d,240
     557.  00:4282                      		; call	move_block
     558.  00:4282                      		; call	plot_line_lft2
     559.  00:4282                      		; jp		newxmap
     560.  00:4282                      
     561.  00:4282                      ; .right
     562.  00:4282                      		; call	plot_line_rgt1
     563.  00:4282                      		; ld		e,16
     564.  00:4282                      		; ld		d,0
     565.  00:4282                      		; call	move_block
     566.  00:4282                      		; call	plot_line_rgt2
     567.  00:4282                      		; jp		newxmap
     568.  00:4282                      
     569.  00:4282                      ; ;-------------------------------------
      40   00:4282                      		include fsmscroll.asm
       1.  00:4282                      
       2.  00:4282                      
       3.  00:4282                      fsm:
       4.  00:4282  3A 05 C0            		ld		a,(_xoffset)		; set R#18 only if not scrolling
       5.  00:4285  47                  		ld		b,a
       6.  00:4286                      
       7.  00:4286  C6 F8               		add		a,-8
       8.  00:4288  E6 0F               		and		0Fh
       9.  00:428A  D3 99               		out		(099h),a
      10.  00:428C                      
      11.  00:428C  3E 92               		ld		a,18+128
      12.  00:428E  D3 99               		out		(099h),a
      13.  00:4290                      	
      14.  00:4290  10 03               		djnz	99f
      15.  00:4292  C3 E8 42            		jp		x1
      16.  00:4295  10 03               99:		djnz	99f
      17.  00:4297  C3 F8 42            		jp		x2
      18.  00:429A  10 03               99:		djnz	99f
      19.  00:429C  C3 08 43            		jp		x3
      20.  00:429F  10 03               99:		djnz	99f
      21.  00:42A1  C3 18 43            		jp		x4
      22.  00:42A4  10 03               99:		djnz	99f
      23.  00:42A6  C3 28 43            		jp		x5
      24.  00:42A9  10 03               99:		djnz	99f
      25.  00:42AB  C3 38 43            		jp		x6
      26.  00:42AE  10 03               99:		djnz	99f
      27.  00:42B0  C3 48 43            		jp		x7
      28.  00:42B3  10 03               99:		djnz	99f
      29.  00:42B5  C3 58 43            		jp		x8
      30.  00:42B8  10 03               99:		djnz	99f
      31.  00:42BA  C3 68 43            		jp		x9
      32.  00:42BD  10 03               99:		djnz	99f
      33.  00:42BF  C3 78 43            		jp		x10
      34.  00:42C2  10 03               99:		djnz	99f
      35.  00:42C4  C3 88 43            		jp		x11
      36.  00:42C7  10 03               99:		djnz	99f
      37.  00:42C9  C3 98 43            		jp		x12
      38.  00:42CC  10 03               99:		djnz	99f
      39.  00:42CE  C3 A8 43            		jp		x13
      40.  00:42D1  10 03               99:		djnz	99f
      41.  00:42D3  C3 B8 43            		jp		x14
      42.  00:42D6  10 03               99:		djnz	99f
      43.  00:42D8  C3 C8 43            		jp		x15
      44.  00:42DB  C3 DE 42            99:		jp		x0
      45.  00:42DE                      
      46.  00:42DE  3A 04 C0            x0:		ld		a,(_displaypage)
      47.  00:42E1  57                  		ld		d,a
      48.  00:42E2  1E F0               		ld		e,240
      49.  00:42E4  CD 13 44            		call 	clear_slice
      50.  00:42E7  C9                  		ret
      51.  00:42E8  1E 10               x1:		ld		e,16
      52.  00:42EA  16 00               		ld		d,0
      53.  00:42EC  CD D8 43            		call	move_slice
      54.  00:42EF  DD 2E 00            		ld		ixl,0
      55.  00:42F2  1E F0               		ld		e,240
      56.  00:42F4  CD 4B 44            		call	_brdrs
      57.  00:42F7  C9                  		ret
      58.  00:42F8  1E 20               x2:		ld		e,16*2
      59.  00:42FA  16 10               		ld		d,16
      60.  00:42FC  CD D8 43            		call	move_slice
      61.  00:42FF  DD 2E 01            		ld		ixl,1
      62.  00:4302  1E F1               		ld		e,241
      63.  00:4304  CD 4B 44            		call	_brdrs
      64.  00:4307  C9                  		ret
      65.  00:4308  1E 30               x3:		ld		e,16*3
      66.  00:430A  16 20               		ld		d,16*2
      67.  00:430C  CD D8 43            		call	move_slice
      68.  00:430F  DD 2E 02            		ld		ixl,2
      69.  00:4312  1E F2               		ld		e,242
      70.  00:4314  CD 4B 44            		call	_brdrs
      71.  00:4317  C9                  		ret
      72.  00:4318  1E 40               x4:		ld		e,16*4
      73.  00:431A  16 30               		ld		d,16*3
      74.  00:431C  CD D8 43            		call	move_slice
      75.  00:431F  DD 2E 03            		ld		ixl,3
      76.  00:4322  1E F3               		ld		e,243
      77.  00:4324  CD 4B 44            		call	_brdrs
      78.  00:4327  C9                  		ret
      79.  00:4328  1E 50               x5:		ld		e,16*5
      80.  00:432A  16 40               		ld		d,16*4
      81.  00:432C  CD D8 43            		call	move_slice
      82.  00:432F  DD 2E 04            		ld		ixl,4
      83.  00:4332  1E F4               		ld		e,244
      84.  00:4334  CD 4B 44            		call	_brdrs
      85.  00:4337  C9                  		ret
      86.  00:4338  1E 60               x6:		ld		e,16*6
      87.  00:433A  16 50               		ld		d,16*5
      88.  00:433C  CD D8 43            		call	move_slice
      89.  00:433F  DD 2E 05            		ld		ixl,5
      90.  00:4342  1E F5               		ld		e,245
      91.  00:4344  CD 4B 44            		call	_brdrs
      92.  00:4347  C9                  		ret
      93.  00:4348  1E 70               x7:		ld		e,16*7
      94.  00:434A  16 60               		ld		d,16*6
      95.  00:434C  CD D8 43            		call	move_slice
      96.  00:434F  DD 2E 06            		ld		ixl,6
      97.  00:4352  1E F6               		ld		e,246
      98.  00:4354  CD 4B 44            		call	_brdrs
      99.  00:4357  C9                  		ret
     100.  00:4358  1E 80               x8:		ld		e,16*8
     101.  00:435A  16 70               		ld		d,16*7
     102.  00:435C  CD D8 43            		call	move_slice
     103.  00:435F  DD 2E 07            		ld		ixl,7
     104.  00:4362  1E F7               		ld		e,247
     105.  00:4364  CD 4B 44            		call	_brdrs
     106.  00:4367  C9                  		ret
     107.  00:4368  1E 90               x9:		ld		e,16*9
     108.  00:436A  16 80               		ld		d,16*8
     109.  00:436C  CD D8 43            		call	move_slice
     110.  00:436F  DD 2E 08            		ld		ixl,8
     111.  00:4372  1E F8               		ld		e,248
     112.  00:4374  CD 4B 44            		call	_brdrs
     113.  00:4377  C9                  		ret
     114.  00:4378  1E A0               x10:	ld		e,16*10
     115.  00:437A  16 90               		ld		d,16*9
     116.  00:437C  CD D8 43            		call	move_slice
     117.  00:437F  DD 2E 09            		ld		ixl,9
     118.  00:4382  1E F9               		ld		e,249
     119.  00:4384  CD 4B 44            		call	_brdrs
     120.  00:4387  C9                  		ret
     121.  00:4388  1E B0               x11:	ld		e,16*11
     122.  00:438A  16 A0               		ld		d,16*10
     123.  00:438C  CD D8 43            		call	move_slice
     124.  00:438F  DD 2E 0A            		ld		ixl,10
     125.  00:4392  1E FA               		ld		e,250
     126.  00:4394  CD 4B 44            		call	_brdrs
     127.  00:4397  C9                  		ret
     128.  00:4398  1E C0               x12:	ld		e,16*12
     129.  00:439A  16 B0               		ld		d,16*11
     130.  00:439C  CD D8 43            		call	move_slice
     131.  00:439F  DD 2E 0B            		ld		ixl,11
     132.  00:43A2  1E FB               		ld		e,251
     133.  00:43A4  CD 4B 44            		call	_brdrs
     134.  00:43A7  C9                  		ret
     135.  00:43A8  1E D0               x13:	ld		e,16*13
     136.  00:43AA  16 C0               		ld		d,16*12
     137.  00:43AC  CD D8 43            		call	move_slice
     138.  00:43AF  DD 2E 0C            		ld		ixl,12
     139.  00:43B2  1E FC               		ld		e,252
     140.  00:43B4  CD 4B 44            		call	_brdrs
     141.  00:43B7  C9                  		ret	
     142.  00:43B8  1E E0               x14:	ld		e,16*14
     143.  00:43BA  16 D0               		ld		d,16*13
     144.  00:43BC  CD D8 43            		call	move_slice
     145.  00:43BF  DD 2E 0D            		ld		ixl,13
     146.  00:43C2  1E FD               		ld		e,253
     147.  00:43C4  CD 4B 44            		call	_brdrs
     148.  00:43C7  C9                  		ret
     149.  00:43C8  DD 2E 0E            x15:			ld		ixl,14
     150.  00:43CB  1E FE               		ld		e,254
     151.  00:43CD  CD 4B 44            		call	_brdrs
     152.  00:43D0  1E F0               		ld		e,16*15
     153.  00:43D2  16 E0               		ld		d,16*14
     154.  00:43D4  CD D8 43            		call	move_slice
     155.  00:43D7  C9                  		ret
     156.  00:43D8                      		
     157.  00:43D8                      		
     158.  00:43D8                      		
     159.  00:43D8                      		
     160.  00:43D8                      		
     161.  00:43D8                      		
      41   00:43D8                      		include vdpcmds.asm
       1.  00:43D8                      
       2.  00:43D8                      
       3.  00:43D8                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
       4.  00:43D8                      ; input
       5.  00:43D8                      ; e = sx	from not _displaypage
       6.  00:43D8                      ; d = dx	to _displaypage
       7.  00:43D8                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
       8.  00:43D8                      
       9.  00:43D8                      move_slice:
      10.  00:43D8  3E 20               		ld 		a, 32
      11.  00:43DA  D3 99               		out 	(0x99),a
      12.  00:43DC  3E 91               		ld 		a, 17+128
      13.  00:43DE  D3 99               		out 	(0x99),a
      14.  00:43E0                      
      15.  00:43E0  0E 9B               		ld 		c, 0x9B
      16.  00:43E2                      		
      17.  00:43E2                      		; call _waitvdp				; no need ATM
      18.  00:43E2                      		
      19.  00:43E2  ED 59               		out		(c), e 				; sx
      20.  00:43E4  AF                  		xor a
      21.  00:43E5  D3 9B               		out		(0x9B), a 			; sx (high)
      22.  00:43E7                      		
      23.  00:43E7  D3 9B               		out		(0x9B), a 			; sy
      24.  00:43E9  3A 04 C0            		ld 		a,(_displaypage)	; source page
      25.  00:43EC  D3 9B               		out 	(0x9B), a 			; sy 	(high-> page 0 or 1)
      26.  00:43EE                      
      27.  00:43EE  ED 51               		out 	(c), d 				; dx
      28.  00:43F0  AF                  		xor a
      29.  00:43F1  D3 9B               		out 	(0x9B), a			; dx (high)
      30.  00:43F3                      		
      31.  00:43F3  D3 9B               		out 	(0x9B), a 			; dy
      32.  00:43F5  3A 04 C0            		ld 		a,(_displaypage)	; destination page
      33.  00:43F8  EE 01               		xor	1				
      34.  00:43FA  D3 9B               		out 	(0x9B), a			; dy 	(high-> page 0 or 1)
      35.  00:43FC                      
      36.  00:43FC  3E 10               		ld 		a,16 				; block size
      37.  00:43FE  D3 9B               		out 	(0x9B), a
      38.  00:4400  AF                  		xor a
      39.  00:4401  D3 9B               		out 	(0x9B), a	
      40.  00:4403  3E A0               		ld		a,10*16				; mapHeight*16
      41.  00:4405  D3 9B               		out 	(0x9B), a			; y block size
      42.  00:4407  AF                  		xor		a
      43.  00:4408  D3 9B               		out 	(0x9B), a
      44.  00:440A  D3 9B               		out 	(0x9B), a
      45.  00:440C  D3 9B               		out 	(0x9B), a
      46.  00:440E                      
      47.  00:440E  3E D0               		ld		a,11010000B
      48.  00:4410  D3 9B               		out 	(0x9B), a			; command HMMM
      49.  00:4412  C9                  		ret
      50.  00:4413                      		
      51.  00:4413                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      52.  00:4413                      ; input
      53.  00:4413                      ; d = page
      54.  00:4413                      ; e = dx
      55.  00:4413                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      56.  00:4413                      		
      57.  00:4413                      clear_slice:
      58.  00:4413  3E 24               		ld 		a, 36
      59.  00:4415  D3 99               		out 	(0x99),a
      60.  00:4417  3E 91               		ld 		a, 17+128
      61.  00:4419  D3 99               		out 	(0x99),a
      62.  00:441B                      		
      63.  00:441B                      		; call _waitvdp
      64.  00:441B                      		
      65.  00:441B  7B                  		ld		a,e
      66.  00:441C  D3 9B               		out 	(0x9B), a 			; dx
      67.  00:441E  AF                  		xor		a
      68.  00:441F  D3 9B               		out 	(0x9B), a			; dx (high)
      69.  00:4421                      		
      70.  00:4421  D3 9B               		out 	(0x9B), a			; dy
      71.  00:4423  7A                  		ld 		a,d					; destination page
      72.  00:4424  D3 9B               		out 	(0x9B), a			; dy (high-> page 0 or 1)
      73.  00:4426                      		
      74.  00:4426  3E 10               		ld 		a,16
      75.  00:4428  D3 9B               		out 	(0x9B), a			; x block size
      76.  00:442A  AF                  		xor	a
      77.  00:442B  D3 9B               		out 	(0x9B), a
      78.  00:442D                      
      79.  00:442D  3E A0               		ld		a,10*16				; mapHeight*16
      80.  00:442F  D3 9B               		out 	(0x9B), a			; y block size
      81.  00:4431  AF                  		xor a
      82.  00:4432  D3 9B               		out 	(0x9B), a
      83.  00:4434                      
      84.  00:4434  3E 1C               		ld	a,00011100B
      85.  00:4436  D3 9B               		out 	(0x9B), a			; border_color
      86.  00:4438  AF                  		xor a
      87.  00:4439  D3 9B               		out 	(0x9B), a
      88.  00:443B                      
      89.  00:443B  3E C0               		ld		a,11000000B
      90.  00:443D  D3 9B               		out 	(0x9B), a			; command HMMV
      91.  00:443F  C9                  		ret
      42   00:4440                      		include brdrs.asm
       1.  00:4440                      
       2.  00:4440                      brdrs:
       3.  00:4440  21 56 46            		ld	hl,_levelmap
       4.  00:4443                      		
       5.  00:4443  3A 05 C0            		ld	a,(_xoffset)
       6.  00:4446  DD 6F               		ld	ixl,a	; ixl = x
       7.  00:4448  C6 F0               		add a,240
       8.  00:444A  5F                  		ld	e,a		; e = x+240
       9.  00:444B                      
      10.  00:444B                      _brdrs:
      11.  00:444B  21 56 46            		ld	hl,_levelmap
      12.  00:444E                      
      13.  00:444E  0E 98               		ld	c,0x98
      14.  00:4450                      				
      15.  00:4450  3A 04 C0            		ld	a,(_displaypage)
      16.  00:4453  87 87               [2] 	add a,a
      17.  00:4455  D3 99               		out (0x99),a 	; set bits 14-16
      18.  00:4457  3E 8E               		ld a,14+128
      19.  00:4459  D3 99               		out (0x99),a
      20.  00:445B                      
      21.  00:445B  16 40               		ld	d,0x40		; write access
      22.  00:445D  CD 85 44            		call	plot_col64
      23.  00:4460                      
      24.  00:4460  3A 04 C0            		ld	a,(_displaypage)
      25.  00:4463  87 87               [2] 	add a,a
      26.  00:4465  F6 01               		or	1
      27.  00:4467  D3 99               		out (0x99),a 	; set bits 14-16
      28.  00:4469  3E 8E               		ld a,14+128
      29.  00:446B  D3 99               		out (0x99),a
      30.  00:446D                      
      31.  00:446D  16 40               		ld	d,0x40		; write access	
      32.  00:446F  CD 85 44            		call	plot_col64
      33.  00:4472                      		
      34.  00:4472  3A 04 C0            		ld	a,(_displaypage)
      35.  00:4475  87 87               [2] 	add a,a
      36.  00:4477  F6 02               		or	2
      37.  00:4479  D3 99               		out (0x99),a 	; set bits 14-16
      38.  00:447B  3E 8E               		ld a,14+128
      39.  00:447D  D3 99               		out (0x99),a
      40.  00:447F                      
      41.  00:447F  16 40               		ld	d,0x40		; write access	
      42.  00:4481  CD 91 44            		call	plot_col32
      43.  00:4484                      				
      44.  00:4484  C9                  		ret
      45.  00:4485                      
      46.  00:4485                      plot_col64:
      47.  00:4485                      	; hl -> tile in the map
      48.  00:4485                      		repeat 2
      49.  00:4485                    < 		push	hl
      50.  00:4485                    < 		call	plot_col16
      51.  00:4485                    < 		pop		hl
      52.  00:4485                    < 	; inc h			; next line in the map
      53.  00:4485                    < 		inc l
      54.  00:4485                    < 		endrepeat
      54.  00:4485  E5 CD 9E 44 E1 2C E5 CD 9E 44 E1 2C 
      55.  00:4491                      plot_col32:		
      56.  00:4491                      		repeat 2
      57.  00:4491                    < 		push	hl
      58.  00:4491                    < 		call	plot_col16
      59.  00:4491                    < 		pop		hl
      60.  00:4491                    < 	; inc h			; next line in the map
      61.  00:4491                    < 		inc l
      62.  00:4491                    < 		endrepeat
      62.  00:4491  E5 CD 9E 44 E1 2C E5 CD 9E 44 E1 2C 
      63.  00:449D  C9                  		ret
      64.  00:449E                      
      65.  00:449E                      
      66.  00:449E                      plot_col16:
      67.  00:449E  7E                  		ld	a,(hl)
      68.  00:449F  07 07 07            [3]		rlca
      69.  00:44A2  E6 07               		and	00000111B
      70.  00:44A4  C6 03               		add	a,:_tiles0
      71.  00:44A6  32 00 B0            		ld	(_kBank4),a
      72.  00:44A9  7E                  		ld	a,(hl)
      73.  00:44AA  E6 1F               		and	00011111B
      74.  00:44AC  C6 A0               		add	a,high _tiles0
      75.  00:44AE  67                  		ld	h,a
      76.  00:44AF  3A 05 C0            		ld	a,(_xoffset)
      77.  00:44B2  87 87 87 87         [4]		add	a,a
      78.  00:44B6  6F                  		ld	l,a
      79.  00:44B7                      
      80.  00:44B7                      	; hl -> tile column in the tileset
      81.  00:44B7                      	
      82.  00:44B7                      		repeat 16
      83.  00:44B7                    < 		ld	a,ixl 		;set bits 0-7
      84.  00:44B7                    < 		out (0x99),a
      85.  00:44B7                    < 		ld a,d 			;set bits 8-13
      86.  00:44B7                    < 		out (0x99),a
      87.  00:44B7                    < 		ld	a,e
      88.  00:44B7                    < 		out	(0x98),a
      89.  00:44B7                    < 		ld a,e 			;set bits 0-7
      90.  00:44B7                    < 		out (0x99),a
      91.  00:44B7                    < 		ld a,d 			;set bits 8-13
      92.  00:44B7                    < 		out (0x99),a
      93.  00:44B7                    < 		inc	d
      94.  00:44B7                    < 		outi			; 18
      95.  00:44B7                    < 		endrepeat
      95.  00:44B7  DD 7D D3 99 7A D3 99 7B D3 98 7B D3 99 7A D3 99 
      95.  00:44C7  14 ED A3 DD 7D D3 99 7A D3 99 7B D3 98 7B D3 99 
      95.  00:44D7  7A D3 99 14 ED A3 DD 7D D3 99 7A D3 99 7B D3 98 
      95.  00:44E7  7B D3 99 7A D3 99 14 ED A3 DD 7D D3 99 7A D3 99 
      95.  00:44F7  7B D3 98 7B D3 99 7A D3 99 14 ED A3 DD 7D D3 99 
      95.  00:4507  7A D3 99 7B D3 98 7B D3 99 7A D3 99 14 ED A3 DD 
      95.  00:4517  7D D3 99 7A D3 99 7B D3 98 7B D3 99 7A D3 99 14 
      95.  00:4527  ED A3 DD 7D D3 99 7A D3 99 7B D3 98 7B D3 99 7A 
      95.  00:4537  D3 99 14 ED A3 DD 7D D3 99 7A D3 99 7B D3 98 7B 
      95.  00:4547  D3 99 7A D3 99 14 ED A3 DD 7D D3 99 7A D3 99 7B 
      95.  00:4557  D3 98 7B D3 99 7A D3 99 14 ED A3 DD 7D D3 99 7A 
      95.  00:4567  D3 99 7B D3 98 7B D3 99 7A D3 99 14 ED A3 DD 7D 
      95.  00:4577  D3 99 7A D3 99 7B D3 98 7B D3 99 7A D3 99 14 ED 
      95.  00:4587  A3 DD 7D D3 99 7A D3 99 7B D3 98 7B D3 99 7A D3 
      95.  00:4597  99 14 ED A3 DD 7D D3 99 7A D3 99 7B D3 98 7B D3 
      95.  00:45A7  99 7A D3 99 14 ED A3 DD 7D D3 99 7A D3 99 7B D3 
      95.  00:45B7  98 7B D3 99 7A D3 99 14 ED A3 DD 7D D3 99 7A D3 
      95.  00:45C7  99 7B D3 98 7B D3 99 7A D3 99 14 ED A3 DD 7D D3 
      95.  00:45D7  99 7A D3 99 7B D3 98 7B D3 99 7A D3 99 14 ED A3 
      96.  00:45E7  C9                  		ret
      97.  00:45E8                      		
      43   00:45E8                      		
      44   00:45E8                      		include checkkbd.asm
       1.  00:45E8                      
       2.  00:45E8                      ; // Line Bit_7 Bit_6 Bit_5 Bit_4 Bit_3 Bit_2 Bit_1 Bit_0
       3.  00:45E8                      ; // 0 "7" "6" "5" "4" "3" "2" "1" "0"
       4.  00:45E8                      ; // 1 ";" "]" "[" "\" "=" "-" "9" "8"
       5.  00:45E8                      ; // 2 "B" "A" ??? "/" "." "," "'" "`"
       6.  00:45E8                      ; // 3 "J" "I" "H" "G" "F" "E" "D" "C"
       7.  00:45E8                      ; // 4 "R" "Q" "P" "O" "N" "M" "L" "K"
       8.  00:45E8                      ; // 5 "Z" "Y" "X" "W" "V" "U" "T" "S"
       9.  00:45E8                      ; // 6 F3 F2 F1 CODE CAP GRAPH CTRL SHIFT
      10.  00:45E8                      ; // 7 RET SEL BS STOP TAB ESC F5 F4
      11.  00:45E8                      ; // 8 RIGHT DOWN UP LEFT DEL INS HOME SPACE
      12.  00:45E8                      
      13.  00:45E8                      checkkbd:
      14.  00:45E8  F3                  		di
      15.  00:45E9  DB AA               		in	a,(0aah)
      16.  00:45EB  E6 F0               		and 011110000B			; upper 4 bits contain info to preserve
      17.  00:45ED  B3                  		or	e
      18.  00:45EE  D3 AA               		out (0aah),a
      19.  00:45F0  DB A9               		in	a,(0a9h)
      20.  00:45F2  6F                  		ld	l,a
      21.  00:45F3  FB                  		ei
      22.  00:45F4  C9                  		ret
      45   00:45F5                      		
      46   00:45F5                      ;-------------------------------------
      47   00:45F5                      ; Entry point
      48   00:45F5                      ;-------------------------------------
      49   00:45F5                      START:
      50   00:45F5  AF                  		xor	a
      51   00:45F6                      		; dec	a
      52   00:45F6  32 02 C0            		ld	(SEL_NTSC),a
      53   00:45F9  CD EA 41            		call	set_scr
      54   00:45FC  F3                  		di
      55   00:45FD                      		
      56   00:45FD                      ;-------------------------------------
      57   00:45FD                      ;   Power-up routine for 32K ROM
      58   00:45FD                      ;   set pages and sub slot
      59   00:45FD                      ;-------------------------------------
      60   00:45FD  CD 10 40                    call    search_slot
      61   00:4600  CD 2F 40                    call    search_slotram
      62   00:4603  CD 61 40            		call	setrompage2
      63   00:4606  CD 5B 40            		call	setrampage0
      64   00:4609                      
      65   00:4609                      
      66   00:4609  AF                  		xor	a
      67   00:460A  32 00 50            		ld	(_kBank1),a
      68   00:460D  3C                  		inc	a
      69   00:460E  32 00 70            		ld	(_kBank2),a
      70   00:4611  3C                  		inc	a
      71   00:4612  32 00 90            		ld	(_kBank3),a
      72   00:4615                      
      73   00:4615  CD 78 41            		call	_cls
      74   00:4618                      		
      75   00:4618                      		;--- initialise ISR in RAM
      76   00:4618                      		
      77   00:4618  F3                  		di
      78   00:4619  21 38 00            		ld	hl,0x0038
      79   00:461C  36 C3               		ld	(hl),0xC3
      80   00:461E  23                  		inc	hl
      81   00:461F  36 3C               		ld	(hl),low _fake_isr
      82   00:4621  23                  		inc	hl
      83   00:4622  36 42               		ld	(hl),high _fake_isr
      84   00:4624                      
      85   00:4624  21 00 00            		ld	hl,0
      86   00:4627  22 9E FC            		ld	(_jiffy),hl		
      87   00:462A  AF                  		xor	a
      88   00:462B  32 04 C0            		ld	(_displaypage),a		
      89   00:462E  32 03 C0            		ld	(halfrate),a		
      90   00:4631                      		
      91   00:4631  FB                  		ei
      92   00:4632  76                  1:		halt
      93   00:4633  3A 05 C0            		ld	a,(_xoffset)		
      94   00:4636  A7                  		and	a
      95   00:4637  C2 32 46            		jp	nz,1b
      96   00:463A                      		
      97   00:463A  1E 08               		ld	e,8
      98   00:463C  CD E8 45            		call	checkkbd
      99   00:463F  E6 01               		and	1				; space
     100   00:4641  CC 47 46            		call	z,PAL_ntsc
     101   00:4644  C3 32 46            		jp	1b
     102   00:4647                      		
     103   00:4647                      PAL_ntsc
     104   00:4647  3A E8 FF            		ld		a,(RG9SAV)		
     105   00:464A  EE 02               		xor		00000010B		; PAL or NTSC 
     106   00:464C  32 E8 FF            		ld		(RG9SAV),a
     107   00:464F  D3 99               		out		(0x99),a
     108   00:4651  3E 89               		ld		a,9+128
     109   00:4653  D3 99               		out		(0x99),a
     110   00:4655  C9                  		ret
     111   00:4656                      		
     112   00:4656                      _levelmap
     113   00:4656                      		repeat 16
     114   00:4656                    < 		db	0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15
     115   00:4656                    < 		endrepeat
     115   00:4656  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:4666  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:4676  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:4686  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:4696  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:46A6  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:46B6  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:46C6  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:46D6  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:46E6  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:46F6  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:4706  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:4716  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:4726  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:4736  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     115   00:4746  00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 
     116   00:4756                      		
     117   00:4756  (03)                		page 3
     118   03:A000                      _tiles0:
     119   03:A000                      		repeat 16
     120   03:A000                    < 		ds 256,255-@#
     121   03:A000  FF (256)          < 		endrepeat
     122   03:B000                      		; call	opening
     123   03:B000                      		
     124   03:B000                      
     125   03:B000                      		; call 	_hw_sprite_init
     126   03:B000                      
     127   03:B000                      		; ld		c,0
     128   03:B000                      		; ld		de,256*(mapHeight*16+3)
     129   03:B000                      		; call	_vdpsetvramwr
     130   03:B000                      
     131   03:B000                      		; ld		de, 256*:_scorebar+1
     132   03:B000                      		; call	outvram
     133   03:B000                      		
     134   03:B000                      		; ld		c,1
     135   03:B000                      		; ld		de,256*mapHeight*16
     136   03:B000                      		; call	_vdpsetvramwr
     137   03:B000                      
     138   03:B000                      		; ld		de, 256*:_animated+2
     139   03:B000                      		; call	outvram
     140   03:B000                      
     141   03:B000                      	
     142   03:B000                      		; ; ld	a,:demo_song
     143   03:B000                      		; ; setpage_a
     144   03:B000                      		
     145   03:B000                      		; ; ld	bc,	end_demo_song-musbuff
     146   03:B000                      		; ; ld	hl,	demo_song
     147   03:B000                      		; ; ld	de,	musbuff
     148   03:B000                      		; ; ldir
     149   03:B000                      			
     150   03:B000                      		; ; call	replay_init
     151   03:B000                      		; ; ld		hl,musbuff
     152   03:B000                      		; ; call	replay_loadsong
     153   03:B000                      
     154   03:B000                      
     155   03:B000                      		; ld		e,0
     156   03:B000                      		; call	_setpage
     157   03:B000                      				
     158   03:B000                      		; ld	a, :_level
     159   03:B000                      		; ld	(_kBank4),a
     160   03:B000                      		
     161   03:B000                      		; ld		hl,_level
     162   03:B000                      		; ld		de,_levelmap
     163   03:B000                      		; ld		bc,mapWidth*mapHeight
     164   03:B000                      		; ldir
     165   03:B000                      
     166   03:B000                      
     167   03:B000                      		; ; call	init_page0
     168   03:B000                      
     169   03:B000                      		; ld		a,0
     170   03:B000                      		; ld		(cur_level),a
     171   03:B000                      
     172   03:B000                      		; ei
     173   03:B000                      
     174   03:B000                      ; restart:
     175   03:B000                      		; call	_intreset
     176   03:B000                      
     177   03:B000                      		
     178   03:B000                      
     179   03:B000                      		; ld		a,1
     180   03:B000                      		; ld		(_displaypage),a		
     181   03:B000                      		; call 	_cls0
     182   03:B000                      		; ld		hl,_levelmap
     183   03:B000                      		; ld		(_levelmap_pos),hl
     184   03:B000                      		
     185   03:B000                      		; xor		a
     186   03:B000                      		; ld		h,a
     187   03:B000                      		; ld		l,a
     188   03:B000                      		; ld		(flip_flop),a
     189   03:B000                      		; ld		(god_mode),a
     190   03:B000                      		; ld		(_ymappos),a
     191   03:B000                      		; ld		(_xmappos),hl
     192   03:B000                      		
     193   03:B000                      		; ld		(_nframes),hl
     194   03:B000                      		; ld		(_mcdx),hl
     195   03:B000                      		; ld		(_mcframe),a
     196   03:B000                      		
     197   03:B000                      		; ld		(_yoffset),a		;  0 tutto su
     198   03:B000                      		; ld		(_xoffset),a		;  0 tutto su
     199   03:B000                      								
     200   03:B000                      		; ld		(aniframe),a
     201   03:B000                      		; ld		(anispeed),a
     202   03:B000                      		; ld		(ms_state),a
     203   03:B000                      		; inc 	a
     204   03:B000                      		; ld		(old_aniframe),a		; old_aniframe!=aniframe
     205   03:B000                      	
     206   03:B000                      		; ld		(dxmap),a		; moving right
     207   03:B000                      		; ld		(_dxmap),a		; moving right
     208   03:B000                      
     209   03:B000                      		; ld		(xmap),hl
     210   03:B000                      		; ld		(_xmapx4),hl
     211   03:B000                      		; ld		bc,xship_rel
     212   03:B000                      		; add 	hl,bc
     213   03:B000                      		; ld		(xship),hl
     214   03:B000                      		; ld		a,80
     215   03:B000                      		; ld		(yship),a
     216   03:B000                      
     217   03:B000                      		; call 	npc_init								
     218   03:B000                      		; call 	load_colors
     219   03:B000                      
     220   03:B000                      		; xor	a
     221   03:B000                      		; ld		(_kBank1),a
     222   03:B000                      		; inc	a
     223   03:B000                      		; ld		(_kBank2),a
     224   03:B000                      		; inc	a
     225   03:B000                      		; ld		(_kBank3),a
     226   03:B000                      		
     227   03:B000                      
     228   03:B000                      		; call	_isrinit
     229   03:B000                      
     230   03:B000                      ; main_loop: 
     231   03:B000                      				
     232   03:B000                      		; ld	hl,0
     233   03:B000                      		; ld	(_jiffy),hl
     234   03:B000                      
     235   03:B000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     236   03:B000                      ; ; run ms FSM and place its sprites in the SAT in RAM
     237   03:B000                      		; call	ms_ctrl
     238   03:B000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     239   03:B000                      ; ; test for game restart
     240   03:B000                      		; ld	a,(ms_state)
     241   03:B000                      		; cp	ms_reset
     242   03:B000                      		; jp	z,restart
     243   03:B000                      
     244   03:B000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     245   03:B000                      ; ; place MS in the SAT and test for collision
     246   03:B000                      		; call	put_ms_sprt
     247   03:B000                      		; ld		a,(god_mode)
     248   03:B000                      		; and 	a
     249   03:B000                      		; ; call	z,test_obstacles
     250   03:B000                      
     251   03:B000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     252   03:B000                      ; ; run NCPS FSM
     253   03:B000                      		; call	wave_timer
     254   03:B000                      		; call	npc_loop
     255   03:B000                      		; call	enemy_bullet_loop
     256   03:B000                      
     257   03:B000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     258   03:B000                      ; ; run MS bullets FSM
     259   03:B000                      		; call	bullet_loop
     260   03:B000                      
     261   03:B000                      		; ; ld	a,00100101B			; random colour
     262   03:B000                      		; ; out		(0x99),a
     263   03:B000                      		; ; ld		a,7+128
     264   03:B000                      		; ; out		(0x99),a
     265   03:B000                      		
     266   03:B000                      		; ; call	_waitvdp
     267   03:B000                      
     268   03:B000                      		; ; ld	a,10100101B			; random colour
     269   03:B000                      		; ; out		(0x99),a
     270   03:B000                      		; ; ld		a,7+128
     271   03:B000                      		; ; out		(0x99),a
     272   03:B000                      				
     273   03:B000                      		; ld	a,(joystick)
     274   03:B000                      		; and	32
     275   03:B000                      		; ; call	z,_plot_distrucable
     276   03:B000                      
     277   03:B000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     278   03:B000                      		; ; ld		a,3
     279   03:B000                      		; ; out		(0x99),a
     280   03:B000                      		; ; ld		a,7+128
     281   03:B000                      		; ; out		(0x99),a
     282   03:B000                      		
     283   03:B000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     284   03:B000                      		; ; call	test_star
     285   03:B000                      
     286   03:B000                      		; ; xor		a
     287   03:B000                      		; ; out		(0x99),a
     288   03:B000                      		; ; ld		a,7+128
     289   03:B000                      		; ; out		(0x99),a
     290   03:B000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     291   03:B000                      
     292   03:B000                      		
     293   03:B000                      ; 1:		ld	a,(_jiffy)		; wait for vblank (and not for linit)
     294   03:B000                      		; or	a
     295   03:B000                      		; jr	z,1b
     296   03:B000                      	
     297   03:B000                      		; ld	hl,(xmap)
     298   03:B000                      		; ld	bc,xship_rel
     299   03:B000                      		; add hl,bc
     300   03:B000                      		; ld	(xship),hl
     301   03:B000                      
     302   03:B000                      		; ld		a,(dxmap)
     303   03:B000                      		; ld		(_dxmap),a
     304   03:B000                      
     305   03:B000                      		; jp      main_loop
     306   03:B000                      
     307   03:B000                      ; ;-------------------------------------
     308   03:B000                      ; AFXPLAY:
     309   03:B000                      		; ret
     310   03:B000                      ; ;	include vuitpakker.asm
     311   03:B000                      	; include print.asm
     312   03:B000                      	; include plot_line.asm
     313   03:B000                      	; include plot_line2.asm
     314   03:B000                      	; include color_update.asm
     315   03:B000                      ; ms_bllts_col_win:
     316   03:B000                      	; include ms_bllts_frm_coll_wind.asm
     317   03:B000                      	; include	ms_bllts.asm
     318   03:B000                      		
     319   03:B000                      ; ;-------------------------------------
     320   03:B000                      
     321   03:B000                      	
     322   03:B000                      		; page 1
     323   03:B000                      
     324   03:B000                      		; include	ms_crtl.asm
     325   03:B000                      		; include	put_ms_sprt.asm
     326   03:B000                      		; include probe_level.asm				
     327   03:B000                      		; include opening.asm		
     328   03:B000                      ; outvram:
     329   03:B000                      ; 2:		ld	a,d
     330   03:B000                      		; ld	(_kBank4),a
     331   03:B000                      		; ld	hl,0xA000
     332   03:B000                      		; ld	bc,0x98
     333   03:B000                      		; ld	a,32
     334   03:B000                      ; 1:		otir
     335   03:B000                      		; dec	a
     336   03:B000                      		; jp	nz,1b
     337   03:B000                      		; inc	d
     338   03:B000                      		; dec	e
     339   03:B000                      		; jr	nz,2b
     340   03:B000                      		; ret
     341   03:B000                      		
     342   03:B000                      		; page 2
     343   03:B000                      	; ; include mainhero_LMMM.asm
     344   03:B000                      
     345   03:B000                      	
     346   03:B000                      		; page 3
     347   03:B000                      ; manta_color:
     348   03:B000                      		; incbin mship03_clr.bin
     349   03:B000                      ; ms_spt:
     350   03:B000                      		; incbin mship03_frm.bin
     351   03:B000                      		
     352   03:B000                      		; page 4
     353   03:B000                      ; _tiles0:
     354   03:B000                      		; incbin "tiles.bin",0x0000,0x2000
     355   03:B000                      		; page 5
     356   03:B000                      		; incbin "tiles.bin",0x2000,0x2000
     357   03:B000                      		; page 6
     358   03:B000                      		; incbin "tiles.bin",0x4000,0x2000
     359   03:B000                      		; page 7
     360   03:B000                      		; incbin "tiles.bin",0x6000,0x2000
     361   03:B000                      		; page 8
     362   03:B000                      		; incbin "tiles.bin",0x8000,0x2000
     363   03:B000                      		; page 9
     364   03:B000                      		; incbin "tiles.bin",0xA000,0x2000
     365   03:B000                      		; page 10
     366   03:B000                      		; incbin "tiles.bin",0xC000,0x2000
     367   03:B000                      		; page 11
     368   03:B000                      		; incbin "tiles.bin",0xE000;,0x2000
     369   03:B000                      
     370   03:B000                      		; page 12
     371   03:B000                      
     372   03:B000                      		; page 15
     373   03:B000                      ; _level:
     374   03:B000                      		; incbin "datamap.bin"
     375   03:B000                      	
     376   03:B000                      		; page 16
     377   03:B000                      ; _opening:
     378   03:B000                      		; incbin "opening.bin",0x0000,0x2000
     379   03:B000                      		; page 17
     380   03:B000                      		; incbin "opening.bin",0x2000,0x2000
     381   03:B000                      		; page 18
     382   03:B000                      		; incbin "opening.bin",0x4000,0x2000
     383   03:B000                      		; page 19
     384   03:B000                      		; incbin "opening.bin",0x6000,0x2000
     385   03:B000                      		; page 20
     386   03:B000                      		; incbin "opening.bin",0x8000,0x2000
     387   03:B000                      		; page 21
     388   03:B000                      		; incbin "opening.bin",0xA000,0x2000
     389   03:B000                      		; page 22
     390   03:B000                      		; incbin "opening.bin",0xC000;,0x2000
     391   03:B000                      		; page 23
     392   03:B000                      		; ; incbin "opening.bin",0xE000;,,0x2000
     393   03:B000                      	
     394   03:B000                      		; page 24
     395   03:B000                      ; _scorebar:	
     396   03:B000                      		; incbin scorebar.bin
     397   03:B000                      	
     398   03:B000                      		; page 25
     399   03:B000                      ; _animated:	
     400   03:B000                      		; incbin animated.bin,0x0000,0x2000
     401   03:B000                      		; page 26
     402   03:B000                      		; incbin animated.bin,0x2000,0x2000
     403   03:B000                      
     404   03:B000                      		; page 27
     405   03:B000                      ; sprtdata:
     406   03:B000                      		; incbin 	uridium_revA.bin,,16*32
     407   03:B000                      		; incbin 	enemies_frm.bin
     408   03:B000                      
     409   03:B000                      		; page 28
     410   03:B000                      ; color_base:
     411   03:B000                      		; repeat 4
     412   03:B000                      		; ds	16,8
     413   03:B000                      		; ds	16,10+64
     414   03:B000                      		; endrepeat
     415   03:B000                      		; repeat 4
     416   03:B000                      		; ds	16,8
     417   03:B000                      		; ds	16,10+64
     418   03:B000                      		; endrepeat
     419   03:B000                      
     420   03:B000                      		
     421   03:B000                      		; incbin 	enemies_clr.bin
     422   03:B000                      		
     423   03:B000                      ; FINISH:
     424   03:B000                      
     425   03:B000                      
     426   03:B000                      ; ;---------------------------------------------------------
     427   03:B000                      ; ; Variables
     428   03:B000                      ; ;---------------------------------------------------------
     429   03:B000                      	
     430   03:B000                      	
     431   03:B000  (C000)              	MAP 0xC000
     432   03:B000                      
     433   03:B000                      ; _levelmap:			#mapWidth*mapHeight
     434   03:B000                      
     435   03:B000  (03:C000)           slotvar				#1
     436   03:B000  (03:C001)           slotram				#1
     437   03:B000  (03:C002)           SEL_NTSC			#1
     438   03:B000                      
     439   03:B000  (03:C003)           halfrate			#1
     440   03:B000                      
     441   03:B000                      ; joystick			#1
     442   03:B000                      
     443   03:B000                      ; _mcdivider			#1
     444   03:B000                      
     445   03:B000                      ; _mcx				#2	; relative with in the frame on the screen
     446   03:B000                      ; _mcy				#2
     447   03:B000                      
     448   03:B000                      ; _mclx				#2	; absolute with the level in ram
     449   03:B000                      ; _mcly				#2
     450   03:B000                      
     451   03:B000                      ; _mcframe			#1
     452   03:B000                      ; _mcstate			#1
     453   03:B000                      
     454   03:B000                      ; _mcdx				#2
     455   03:B000                      ; _mcdy				#2
     456   03:B000                      
     457   03:B000                      ; _mcprobe:			#1
     458   03:B000                      ; _mcprobeb:			#1
     459   03:B000                      
     460   03:B000                      ; _ticxframe			#1
     461   03:B000                      
     462   03:B000                      ; _buffer:			#16
     463   03:B000                      ; _fps:				#2
     464   03:B000                      ; _nframes:			#2
     465   03:B000                      ; _vbit16:			#2
     466   03:B000                      
     467   03:B000                      ; _ymappos:			#1
     468   03:B000                      ; _xmappos:			#2
     469   03:B000                      ; _levelmap_pos:		#2
     470   03:B000                      
     471   03:B000                      ; _shadowbuff:		#2
     472   03:B000                      
     473   03:B000  (03:C004)           _displaypage:		#1
     474   03:B000                      
     475   03:B000                      ; _mccolorchange:		#1
     476   03:B000  (03:C005)           _xoffset:			#1
     477   03:B000                      ; _yoffset:			#1
     478   03:B000                      
     479   03:B000                      ; __xoffset:			#1
     480   03:B000                      ; __r18:				#1
     481   03:B000                      
     482   03:B000                      ; randSeed:			#2
     483   03:B000                      ; cur_level:			#1
     484   03:B000                      ; wave_count:			#1
     485   03:B000                      ; landing_permission:	#1
     486   03:B000                      ; assault_wave_timer:	#2
     487   03:B000                      ; bullet_rate:		#1
     488   03:B000                      ; _dxchng:			#1		; <>0 if direction changes
     489   03:B000                      ; _dxmap:				#1		; previous dxmap
     490   03:B000                      ; dxmap:				#1
     491   03:B000                      ; xmap:				#2
     492   03:B000                      ; _xmapx4:			#2		; xmap x 4
     493   03:B000                      ; yship:				#1
     494   03:B000                      ; xship:				#2
     495   03:B000                      ; aniframe:			#1
     496   03:B000                      ; ms_state:			#1
     497   03:B000                      ; old_aniframe:		#1
     498   03:B000                      ; anispeed:			#1
     499   03:B000                      ; already_dead:		#1
     500   03:B000                      ; lives_bin:			#1
     501   03:B000                      
     502   03:B000                      ; god_mode:			#1
     503   03:B000                      ; visible_sprts:		#1
     504   03:B000                      ; flip_flop:			#1
     505   03:B000                      
     506   03:B000                      ; ram_sat:			#3*4
     507   03:B000                      
     508   03:B000                      	; struct enemy_data
     509   03:B000                      ; y				db	0
     510   03:B000                      ; x				dw	0
     511   03:B000                      ; xoff			db	0
     512   03:B000                      ; yoff			db	0
     513   03:B000                      ; xsize			db	0
     514   03:B000                      ; ysize			db	0
     515   03:B000                      ; status			db	0	; B7 = DWN/UP | B6 = RIGHT/LEFT | B5 = ok/wrong clr | B0 = Inactive/Active
     516   03:B000                      ; cntr			db	0
     517   03:B000                      ; kind			db	0
     518   03:B000                      ; frame			db	0
     519   03:B000                      ; color			db	0
     520   03:B000                      ; color2			db	0
     521   03:B000                      ; speed			dw	0
     522   03:B000                      	; ends
     523   03:B000                      	
     524   03:B000                      ; any_object:			#0
     525   03:B000                      ; ms_bullets:			#enemy_data*max_bullets
     526   03:B000                      ; enem_bullets:		#enemy_data*max_enem_bullets
     527   03:B000                      ; enemies:			#enemy_data*max_enem
     528   03:B000                      ; endram:				#1
     529   03:B000  (0000)              	ENDMAP

    LABELS
-------------------------------------------------
00:00005000   _kBank1
00:00007000   _kBank2
00:00009000   _kBank3
00:0000B000   _kBank4
00:0000F3DF X RG0SAV
00:0000F3E0   RG1SAV
00:0000F3E1 X RG2SAV
00:0000F3E2 X RG3SAV
00:0000F3E3 X RG4SAV
00:0000F3E4 X RG5SAV
00:0000F3E5 X RG6SAV
00:0000F3E6   RG7SAV
00:0000FFE7   RG8SAV
00:0000FFE8   RG9SAV
00:0000FFE9 X RG10SAV
00:0000FFEA X RG11SAV
00:0000FFEB X RG12SAV
00:0000FFEC X RG13SAV
00:0000FFED X RG14SAV
00:0000FFEE X RG15SAV
00:0000FFEF X RG16SAV
00:0000FFF0 X RG17SAV
00:0000FFF1 X RG18SAV
00:0000FFF2 X RG19SAV
00:0000FFF3 X RG20SAV
00:0000FFF4 X RG21SAV
00:0000FFF5 X RG22SAV
00:0000FFF7 X RG23SAV
00:0000FC9E   _jiffy
00:0000000C X max_enem
00:00000003 X max_enem_bullets
00:00000002 X max_bullets
00:00000004 X maxspeed
00:000000B4 X assault_wave_timer_preset
00:00000002 X enemy_bullet_speed
00:00000078 X xship_rel
00:00000100 X mapWidth
00:0000000B   mapHeight
00:000000A8 X YSIZE
00:00000024 X ENASLT
00:00000138   RSLREG
00:0000FCC1   EXPTBL
00:00004010   search_slot
00:0000402F   search_slotram
00:00004050   search_slotram0
00:00004055 X setrompage0
00:0000405B   setrampage0
00:00004061   setrompage2
00:00004067 X setrampage2
00:0000406D X setrompage3
00:00004073 X setrampage3
00:00004079 X recbios
00:0000407C   setslotpage0
00:000040B3 X setslotpage1
00:000040F2   setslotpage2
00:00004139   setslotpage3
00:00004178   _cls
00:00004190 X _cls0
00:00000099 X vdpport1
00:0000009A X vdpport2
00:000041A5   _vdpsetvramwr
00:000041A6 X _vdpsetvramwr2
00:000041B6 X _vdpsetvramwr14
00:000041BF X _vdpsetvramrd
00:000041D9 X _setpage
00:0000005F   chgmod
00:0000000C X RDSLT
00:00000156 X KILBUF
00:000041EA   set_scr
00:0000422D X _waitvdp
00:0000423C   _fake_isr
00:00004282   fsm
00:000042DE   x0
00:000042E8   x1
00:000042F8   x2
00:00004308   x3
00:00004318   x4
00:00004328   x5
00:00004338   x6
00:00004348   x7
00:00004358   x8
00:00004368   x9
00:00004378   x10
00:00004388   x11
00:00004398   x12
00:000043A8   x13
00:000043B8   x14
00:000043C8   x15
00:000043D8   move_slice
00:00004413   clear_slice
00:00004440 X brdrs
00:0000444B   _brdrs
00:00004485   plot_col64
00:00004491   plot_col32
00:0000449E   plot_col16
00:000045E8   checkkbd
00:000045F5   START
00:00004647   PAL_ntsc
00:00004656   _levelmap
03:0000A000   _tiles0
03:0000C000   slotvar
03:0000C001   slotram
03:0000C002   SEL_NTSC
03:0000C003   halfrate
03:0000C004   _displaypage
03:0000C005   _xoffset


 Output: main.out
-------------------------------------------------

 Page: 00
  Org: 00004000  Size: *  Used: 00000000

    No output

 Output: urd2.rom
-------------------------------------------------

 Page: 00
  Org: 00004000  Size: 00002000  Used: 00000756

   Address   Length Align   Label
   00004000    1878         search_slot
   00004756    6314       <empty>

 Page: 01
  Org: 00006000  Size: 00002000  Used: 00000000

   00006000    8192       <empty>

 Page: 02
  Org: 00008000  Size: 00002000  Used: 00000000

   00008000    8192       <empty>

 Page: 03
  Org: 0000A000  Size: 00002000  Used: 00001000

   Address   Length Align   Label
   0000A000    4096         _tiles0
   0000B000    4096       <empty>

 Page: 04
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 05
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 06
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 07
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 08
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 09
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 0A
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 0B
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 0C
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 0D
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 0E
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 0F
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>
