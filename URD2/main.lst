Sjasm Z80 Assembler v0.42c - www.xl2s.tk             [2016.03.08 - 00:17:04]

main.asm
Errors: 0

       1   00:0000                      ;----------------------------------------------------------------------------
       2   00:0000                      ;
       3   00:0000                      ;----------------------------------------------------------------------------
       4   00:0000                      
       5   00:0000                              output "urd2.rom"
       6   00:0000                      
       7   00:0000                      		;	konami scc
       8   00:0000                      		
       9   00:0000  (00:5000)           _kBank1:	equ 05000h ;- 57FFh (5000h used)
      10   00:0000  (00:7000)           _kBank2: 	equ 07000h ;- 77FFh (7000h used)
      11   00:0000  (00:9000)           _kBank3: 	equ 09000h ;- 97FFh (9000h used)
      12   00:0000  (00:B000)           _kBank4: 	equ 0B000h ;- B7FFh (B000h used)
      13   00:0000                      
      14   00:0000                      
      15   00:0000                      
      16   00:0000                      		defpage	 0,0x4000, 0x2000		; page 0 main code 
      17   00:0000                      		defpage	 1,0x6000, 0x2000		; page 1 code 
      18   00:0000                      		defpage	 2,0x8000, 0x2000		; page 2 code  
      19   00:0000                      		defpage	 3,0xA000, 0x2000		; swapped data 
      20   00:0000                      		
      21   00:0000                      		defpage	 4..15					; 64KB of swapped data 
      22   00:0000                      
      23   00:0000                      
      24   00:0000                      
      25   00:0000                        		include "header.asm"			; only definitions
       1.  00:0000                      
       2.  00:0000                        // MSX 1 
       3.  00:0000  (00:F3DF)           RG0SAV  equ 0xF3DF  
       4.  00:0000  (00:F3E0)           RG1SAV  equ 0xF3E0  
       5.  00:0000  (00:F3E1)           RG2SAV  equ 0xF3E1
       6.  00:0000  (00:F3E2)           RG3SAV  equ 0xF3E2
       7.  00:0000  (00:F3E3)           RG4SAV  equ 0xF3E3
       8.  00:0000  (00:F3E4)           RG5SAV  equ 0xF3E4
       9.  00:0000  (00:F3E5)           RG6SAV  equ 0xF3E5
      10.  00:0000  (00:F3E6)           RG7SAV  equ 0xF3E6
      11.  00:0000                      // MSX 2
      12.  00:0000  (00:FFE7)           RG8SAV  equ 0xFFE7 
      13.  00:0000  (00:FFE8)           RG9SAV  equ 0xFFE8 
      14.  00:0000  (00:FFE9)           RG10SAV equ 0xFFE9 
      15.  00:0000  (00:FFEA)           RG11SAV equ 0xFFEA 
      16.  00:0000  (00:FFEB)           RG12SAV equ 0xFFEB 
      17.  00:0000  (00:FFEC)           RG13SAV equ 0xFFEC 
      18.  00:0000  (00:FFED)           RG14SAV equ 0xFFED 
      19.  00:0000  (00:FFEE)           RG15SAV equ 0xFFEE 
      20.  00:0000  (00:FFEF)           RG16SAV equ 0xFFEF 
      21.  00:0000  (00:FFF0)           RG17SAV equ 0xFFF0 
      22.  00:0000  (00:FFF1)           RG18SAV equ 0xFFF1 
      23.  00:0000  (00:FFF2)           RG19SAV equ 0xFFF2 
      24.  00:0000  (00:FFF3)           RG20SAV equ 0xFFF3 
      25.  00:0000  (00:FFF4)           RG21SAV equ 0xFFF4 
      26.  00:0000  (00:FFF5)           RG22SAV equ 0xFFF5 
      27.  00:0000  (00:FFF7)           RG23SAV equ 0xFFF7 
      28.  00:0000                      
      29.  00:0000  (00:FC9E)           _jiffy: equ 0xFC9E 
      30.  00:0000                      
      31.  00:0000                      	
      32.  00:0000                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      33.  00:0000                      
      34.  00:0000  (00:000C)           max_enem:					equ 12		; max 12
      35.  00:0000  (00:0003)           max_enem_bullets:			equ 3
      36.  00:0000  (00:0002)           max_bullets:				equ 2		; max number of enemies*2 + ms_bullets + enem_bullets + 3 for ms	<= 32 sprites
      37.  00:0000                      
      38.  00:0000  (00:0004)           maxspeed:					equ 4		; the actual speed is divided by 4
      39.  00:0000  (00:00B4)           assault_wave_timer_preset:	equ	3*60	; a wave each 3 seconds
      40.  00:0000  (00:0002)           enemy_bullet_speed:			equ	2	
      41.  00:0000  (00:0078)           xship_rel:					equ (128-8)
      42.  00:0000                      
      43.  00:0000  (00:0100)           mapWidth	equ	256
      44.  00:0000  (00:000A)           mapHeight	equ	10
      45.  00:0000  (00:00A0)           YSIZE		equ	10*16
      46.  00:0000                      
      47.  00:0000                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      48.  00:0000  (00:0000)           debug equ 0
      49.  00:0000                      
      50.  00:0000                      	macro setpage_a
      51.  00:0000                    < 		ld	(_kBank3),a
      52.  00:0000                    < 		inc	a
      53.  00:0000                    < 		ld	(_kBank4),a
      54.  00:0000                    < 	endmacro
      55.  00:0000                      	
      56.  00:0000                      	macro bdrclr n
      57.  00:0000                    < 		if debug
      58.  00:0000                    < 		ifdif	n,0	
      59.  00:0000                    < 			ld		a,n
      60.  00:0000                    < 		else
      61.  00:0000                    < 			xor	a
      62.  00:0000                    < 		endif
      63.  00:0000                    < 		out		(0x99),a
      64.  00:0000                    < 		ld		a,7+128
      65.  00:0000                    < 		out		(0x99),a	
      66.  00:0000                    < 		endif
      67.  00:0000                    < 	endmacro
      68.  00:0000                      	
      69.  00:0000                      	macro set_tile reg
      70.  00:0000                    < 		ld	a,reg
      71.  00:0000                    < [3]		rlca
      72.  00:0000                    < 		and	00000111B
      73.  00:0000                    < 		add	a,:_tiles0
      74.  00:0000                    < 		ld	(_kBank4),a		; select tile bank
      75.  00:0000                    < 
      76.  00:0000                    < 		ld	a,reg
      77.  00:0000                    < 		and	00011111B
      78.  00:0000                    < 		add	a,high _tiles0
      79.  00:0000                    < 	endmacro
      80.  00:0000                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;  
      26   00:0000                      		
      27   00:0000                      		
      28   00:0000                      		
      29   00:0000  (00)                		page 0
      30   00:4000                      		
      31   00:4000                              org 4000h
      32   00:4000                              dw  4241h,START,0,0,0,0,0,0
      32   00:4000  41 42 4A 49 00 00 00 00 00 00 00 00 00 00 00 00 
      33   00:4010                      
      34   00:4010                      	;-------------------------------------		
      35   00:4010                      
      36   00:4010                      
      37   00:4010                      		include rominit64.asm				
       1.  00:4010                      
       2.  00:4010                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
       3.  00:4010                      ; set pages and subslot
       4.  00:4010                      ;
       5.  00:4010                      
       6.  00:4010                      
       7.  00:4010  (00:0024)           ENASLT:			equ		024h
       8.  00:4010  (00:0138)           RSLREG:			equ		0138h
       9.  00:4010  (00:FCC1)           EXPTBL:			equ		0FCC1h	; Bios Slot / Expansion Slot
      10.  00:4010                      
      11.  00:4010                      
      12.  00:4010                      ; ----------------------------
      13.  00:4010                      ; pre-set main slot for page 3
      14.  00:4010                      ; and set sub-slot for page 3
      15.  00:4010                      ; ----------------------------
      16.  00:4010                      	macro	mainslot_setup n
      17.  00:4010                    < 	and		3
      18.  00:4010                    < [2]	rrca
      19.  00:4010                    < 	and		0xC0
      20.  00:4010                    < 	ld		c,a
      21.  00:4010                    < 	ld		a,d
      22.  00:4010                    < 	and		0x3F
      23.  00:4010                    < 	or		c
      24.  00:4010                    < 	ld		c,a					; Primary slot value with main slot in page 3
      25.  00:4010                    < 
      26.  00:4010                    < 	ld		a,b
      27.  00:4010                    < 	and		0x0C
      28.  00:4010                    < [2]	rrca
      29.  00:4010                    < 	and		3
      30.  00:4010                    < 	ld		b,a					; B = Expanded slot in page 3
      31.  00:4010                    < 	ld		a,c
      32.  00:4010                    < 	out		(0A8h),a			; Slot : Main Slot, xx, xx, Main slot
      33.  00:4010                    < 	ld		a,(0FFFFh)
      34.  00:4010                    < 	cpl
      35.  00:4010                    < 	if (n<=4)
      36.  00:4010                    < [n]	RLCA
      37.  00:4010                    < 	else
      38.  00:4010                    < [8-n] RRCA	
      39.  00:4010                    < 	endif
      40.  00:4010                    < 	and		0xFC
      41.  00:4010                    < 	or		b
      42.  00:4010                    < 	if (n<=4)
      43.  00:4010                    < [n]	RRCA
      44.  00:4010                    < 	else
      45.  00:4010                    < [8-n] RLCA
      46.  00:4010                    < 	endif
      47.  00:4010                    < 	ld		(0FFFFh),a		; Expanded slot selected
      48.  00:4010                    < 	ld		b,a				; save for later	
      49.  00:4010                    < 	endmacro
      50.  00:4010                      		
      51.  00:4010                      
      52.  00:4010                      ; ------------------------------
      53.  00:4010                      ; SEARCH_SLOT
      54.  00:4010                      ; look for the slot of our rom
      55.  00:4010                      ; active in page 1
      56.  00:4010                      ; ------------------------------
      57.  00:4010                      
      58.  00:4010                      search_slot:
      59.  00:4010  CD 38 01            	call	RSLREG
      60.  00:4013  0F 0F               [2]	rrca
      61.  00:4015  E6 03               	and		3
      62.  00:4017  4F                  	ld		c,a
      63.  00:4018  06 00               	ld		b,0
      64.  00:401A  21 C1 FC            	ld		hl,EXPTBL
      65.  00:401D  09                  	add		hl,bc
      66.  00:401E  7E                  	ld		a,(hl)
      67.  00:401F  E6 80               	and		080h
      68.  00:4021  B1                  	or		c
      69.  00:4022  4F                  	ld		c,a
      70.  00:4023  23 23 23 23         [4]	inc		hl
      71.  00:4027  7E                  	ld		a,(hl)
      72.  00:4028  E6 0C               	and		0Ch
      73.  00:402A  B1                  	or		c
      74.  00:402B  32 11 CA            	ld		(slotvar),a
      75.  00:402E  C9                  	ret
      76.  00:402F                      	
      77.  00:402F                      ; ------------------------------
      78.  00:402F                      ; look for the slot of ram
      79.  00:402F                      ; active in page 3
      80.  00:402F                      ; ------------------------------
      81.  00:402F                      
      82.  00:402F                      search_slotram:
      83.  00:402F  F3                  	di
      84.  00:4030  CD 38 01            	call	RSLREG
      85.  00:4033  07 07               [2]	rlca
      86.  00:4035  E6 03               	and		3
      87.  00:4037  4F                  	ld		c,a
      88.  00:4038  06 00               	ld		b,0
      89.  00:403A  21 C1 FC            	ld		hl,EXPTBL
      90.  00:403D  09                  	add		hl,bc
      91.  00:403E  7E                  	ld		a,(hl)
      92.  00:403F  E6 80               	and		080h
      93.  00:4041  28 0D               	jr		z,search_slotram0
      94.  00:4043  B1                  	or		c
      95.  00:4044  4F                  	ld		c,a
      96.  00:4045  23 23 23 23         [4]	inc		hl
      97.  00:4049  7E                  	ld		a,(hl)
      98.  00:404A  07 07 07 07         [4]	rlca
      99.  00:404E  E6 0C               	and		0Ch
     100.  00:4050                      search_slotram0:
     101.  00:4050  B1                  	or		c
     102.  00:4051  32 12 CA            	ld		(slotram),a
     103.  00:4054  C9                  	ret
     104.  00:4055                      	
     105.  00:4055                      ; ------------------------------
     106.  00:4055                      ; SETROMPAGE0
     107.  00:4055                      ; Set the chart in
     108.  00:4055                      ; Page 0
     109.  00:4055                      ; -----------------------------
     110.  00:4055                      
     111.  00:4055                      setrompage0:
     112.  00:4055  3A 11 CA            	ld		a,(slotvar)
     113.  00:4058  C3 7C 40            	jp		setslotpage0
     114.  00:405B                      
     115.  00:405B                      setrampage0:
     116.  00:405B  3A 12 CA            	ld		a,(slotram)
     117.  00:405E  C3 7C 40            	jp		setslotpage0
     118.  00:4061                      
     119.  00:4061                      setrompage2:
     120.  00:4061  3A 11 CA            	ld		a,(slotvar)
     121.  00:4064  C3 F2 40            	jp		setslotpage2
     122.  00:4067                      
     123.  00:4067                      setrampage2:
     124.  00:4067  3A 12 CA            	ld		a,(slotram)
     125.  00:406A  C3 F2 40            	jp		setslotpage2
     126.  00:406D                      	
     127.  00:406D                      setrompage3:
     128.  00:406D  3A 11 CA            	ld		a,(slotvar)
     129.  00:4070  C3 39 41            	jp		setslotpage3
     130.  00:4073                      
     131.  00:4073                      setrampage3:
     132.  00:4073  3A 12 CA            	ld		a,(slotram)
     133.  00:4076  C3 39 41            	jp		setslotpage3
     134.  00:4079                      	
     135.  00:4079                      ; ------------------------------
     136.  00:4079                      ; RECBIOS
     137.  00:4079                      ; set the bios ROM
     138.  00:4079                      ; -------------------------------
     139.  00:4079                      recbios:
     140.  00:4079  3A C1 FC            	ld		a,(EXPTBL)
     141.  00:407C                      
     142.  00:407C                      ; ---------------------------
     143.  00:407C                      ; SETSLOTPAGE0
     144.  00:407C                      ; Set the slot passed in A
     145.  00:407C                      ; at page 0 in the Z80 address space
     146.  00:407C                      ; A: Format FxxxSSPP
     147.  00:407C                      ; ----------------------------
     148.  00:407C                      
     149.  00:407C                      setslotpage0:
     150.  00:407C  F3                  	di
     151.  00:407D  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     152.  00:407E  DB A8               	in		a,(0A8h)
     153.  00:4080  E6 FC               	and		0xFC
     154.  00:4082  57                  	ld		d,a					; D = Primary slot value
     155.  00:4083  78                  	ld		a,b
     156.  00:4084  E6 03               	and		3
     157.  00:4086  B2                  	or		d
     158.  00:4087  57                  	ld		d,a		; D = Final Value for primary slot
     159.  00:4088  78                  	ld		a,b		; Check if expanded
     160.  00:4089  CB 7F               	bit		7,a
     161.  00:408B  28 22               	jr		z,1f	; Not Expanded
     162.  00:408D                      	mainslot_setup	0
     162.  00:408D  E6 03             >  and  3
     162.  00:408F  0F 0F             > [2] rrca
     162.  00:4091  E6 C0             >  and  0xC0
     162.  00:4093  4F                >  ld  c,a
     162.  00:4094  7A                >  ld  a,d
     162.  00:4095  E6 3F             >  and  0x3F
     162.  00:4097  B1                >  or  c
     162.  00:4098  4F                >  ld  c,a
     162.  00:4099                    > 
     162.  00:4099  78                >  ld  a,b
     162.  00:409A  E6 0C             >  and  0x0C
     162.  00:409C  0F 0F             > [2] rrca
     162.  00:409E  E6 03             >  and  3
     162.  00:40A0  47                >  ld  b,a
     162.  00:40A1  79                >  ld  a,c
     162.  00:40A2  D3 A8             >  out  (0A8h),a
     162.  00:40A4  3A FF FF          >  ld  a,(0FFFFh)
     162.  00:40A7  2F                >  cpl
     162.  00:40A8                    >  if (n<=4)
     162.  00:40A8                    > [n] RLCA
     162.  00:40A8                    >  else
     162.  00:40A8                    ~ [8-n] RRCA
     162.  00:40A8                    ~  endif
     162.  00:40A8  E6 FC             >  and  0xFC
     162.  00:40AA  B0                >  or  b
     162.  00:40AB                    >  if (n<=4)
     162.  00:40AB                    > [n] RRCA
     162.  00:40AB                    >  else
     162.  00:40AB                    ~ [8-n] RLCA
     162.  00:40AB                    ~  endif
     162.  00:40AB  32 FF FF          >  ld  (0FFFFh),a
     162.  00:40AE  47                >  ld  b,a
     163.  00:40AF  7A                  1:	ld		a,d				; A = Final value
     164.  00:40B0  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     165.  00:40B2  C9                  	ret
     166.  00:40B3                      
     167.  00:40B3                      ; ---------------------------
     168.  00:40B3                      ; SETSLOTPAGE1
     169.  00:40B3                      ; Set the slot passed in A
     170.  00:40B3                      ; at page 1 in the Z80 address space
     171.  00:40B3                      ; A: Format FxxxSSPP
     172.  00:40B3                      ; ----------------------------
     173.  00:40B3                      
     174.  00:40B3                      setslotpage1:
     175.  00:40B3  F3                  	di
     176.  00:40B4  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     177.  00:40B5  DB A8               	in		a,(0A8h)
     178.  00:40B7  0F 0F               [2]	RRCA
     179.  00:40B9  E6 FC               	and		0xFC
     180.  00:40BB  57                  	ld		d,a					; D = Primary slot value
     181.  00:40BC  78                  	ld		a,b
     182.  00:40BD  E6 03               	and		3
     183.  00:40BF  B2                  	or		d
     184.  00:40C0  07 07               [2]	RLCA
     185.  00:40C2  57                  	ld		d,a		; D = Final Value for primary slot
     186.  00:40C3  78                  	ld		a,b		; Check if expanded
     187.  00:40C4  CB 7F               	bit		7,a
     188.  00:40C6  28 26               	jr		z,1f	; Not Expanded
     189.  00:40C8                      	mainslot_setup	6
     189.  00:40C8  E6 03             >  and  3
     189.  00:40CA  0F 0F             > [2] rrca
     189.  00:40CC  E6 C0             >  and  0xC0
     189.  00:40CE  4F                >  ld  c,a
     189.  00:40CF  7A                >  ld  a,d
     189.  00:40D0  E6 3F             >  and  0x3F
     189.  00:40D2  B1                >  or  c
     189.  00:40D3  4F                >  ld  c,a
     189.  00:40D4                    > 
     189.  00:40D4  78                >  ld  a,b
     189.  00:40D5  E6 0C             >  and  0x0C
     189.  00:40D7  0F 0F             > [2] rrca
     189.  00:40D9  E6 03             >  and  3
     189.  00:40DB  47                >  ld  b,a
     189.  00:40DC  79                >  ld  a,c
     189.  00:40DD  D3 A8             >  out  (0A8h),a
     189.  00:40DF  3A FF FF          >  ld  a,(0FFFFh)
     189.  00:40E2  2F                >  cpl
     189.  00:40E3                    >  if (n<=4)
     189.  00:40E3                    ~ [n] RLCA
     189.  00:40E3                    ~  else
     189.  00:40E3  0F 0F             > [8-n] RRCA
     189.  00:40E5                    >  endif
     189.  00:40E5  E6 FC             >  and  0xFC
     189.  00:40E7  B0                >  or  b
     189.  00:40E8                    >  if (n<=4)
     189.  00:40E8                    ~ [n] RRCA
     189.  00:40E8                    ~  else
     189.  00:40E8  07 07             > [8-n] RLCA
     189.  00:40EA                    >  endif
     189.  00:40EA  32 FF FF          >  ld  (0FFFFh),a
     189.  00:40ED  47                >  ld  b,a
     190.  00:40EE  7A                  1:	ld		a,d				; A = Final value
     191.  00:40EF  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     192.  00:40F1  C9                  	ret
     193.  00:40F2                      	
     194.  00:40F2                      
     195.  00:40F2                      ; ---------------------------
     196.  00:40F2                      ; SETSLOTPAGE2
     197.  00:40F2                      ; Set the slot passed in A
     198.  00:40F2                      ; at page 2 in the Z80 address space
     199.  00:40F2                      ; A: Format FxxxSSPP
     200.  00:40F2                      ; ----------------------------
     201.  00:40F2                      
     202.  00:40F2                      setslotpage2:
     203.  00:40F2  F3                  	di
     204.  00:40F3  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     205.  00:40F4  DB A8               	in		a,(0A8h)
     206.  00:40F6  07 07 07 07         [4]	RLCA
     207.  00:40FA  E6 FC               	and		0xFC
     208.  00:40FC  57                  	ld		d,a					; D = Primary slot value
     209.  00:40FD  78                  	ld		a,b
     210.  00:40FE  E6 03               	and		3
     211.  00:4100  B2                  	or		d
     212.  00:4101  0F 0F 0F 0F         [4]	RRCA
     213.  00:4105  57                  	ld		d,a		; D = Final Value for primary slot
     214.  00:4106  78                  	ld		a,b		; Check if expanded
     215.  00:4107  CB 7F               	bit		7,a
     216.  00:4109  28 2A               	jr		z,1f	; Not Expanded
     217.  00:410B                      	mainslot_setup	4
     217.  00:410B  E6 03             >  and  3
     217.  00:410D  0F 0F             > [2] rrca
     217.  00:410F  E6 C0             >  and  0xC0
     217.  00:4111  4F                >  ld  c,a
     217.  00:4112  7A                >  ld  a,d
     217.  00:4113  E6 3F             >  and  0x3F
     217.  00:4115  B1                >  or  c
     217.  00:4116  4F                >  ld  c,a
     217.  00:4117                    > 
     217.  00:4117  78                >  ld  a,b
     217.  00:4118  E6 0C             >  and  0x0C
     217.  00:411A  0F 0F             > [2] rrca
     217.  00:411C  E6 03             >  and  3
     217.  00:411E  47                >  ld  b,a
     217.  00:411F  79                >  ld  a,c
     217.  00:4120  D3 A8             >  out  (0A8h),a
     217.  00:4122  3A FF FF          >  ld  a,(0FFFFh)
     217.  00:4125  2F                >  cpl
     217.  00:4126                    >  if (n<=4)
     217.  00:4126  07 07 07 07       > [n] RLCA
     217.  00:412A                    >  else
     217.  00:412A                    ~ [8-n] RRCA
     217.  00:412A                    ~  endif
     217.  00:412A  E6 FC             >  and  0xFC
     217.  00:412C  B0                >  or  b
     217.  00:412D                    >  if (n<=4)
     217.  00:412D  0F 0F 0F 0F       > [n] RRCA
     217.  00:4131                    >  else
     217.  00:4131                    ~ [8-n] RLCA
     217.  00:4131                    ~  endif
     217.  00:4131  32 FF FF          >  ld  (0FFFFh),a
     217.  00:4134  47                >  ld  b,a
     218.  00:4135  7A                  1:	ld		a,d				; A = Final value
     219.  00:4136  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     220.  00:4138  C9                  	ret
     221.  00:4139                      	
     222.  00:4139                      ; ---------------------------
     223.  00:4139                      ; SETSLOTPAGE3
     224.  00:4139                      ; Set the slot passed in A
     225.  00:4139                      ; at page 3 in the Z80 address space
     226.  00:4139                      ; A: Format FxxxSSPP
     227.  00:4139                      ; ----------------------------
     228.  00:4139                      	
     229.  00:4139                      setslotpage3:
     230.  00:4139  F3                  	di
     231.  00:413A  47                  	ld		b,a					; B = Slot param in FxxxSSPP format
     232.  00:413B  DB A8               	in		a,(0A8h)
     233.  00:413D  07 07               [2]	RLCA
     234.  00:413F  E6 FC               	and		0xFC
     235.  00:4141  57                  	ld		d,a					; D = Primary slot value
     236.  00:4142  78                  	ld		a,b
     237.  00:4143  E6 03               	and		3
     238.  00:4145  B2                  	or		d
     239.  00:4146  0F 0F               [2]	RRCA	
     240.  00:4148  57                  	ld		d,a		; D = Final Value for primary slot
     241.  00:4149  78                  	ld		a,b		; Check if expanded
     242.  00:414A  CB 7F               	bit		7,a
     243.  00:414C  28 26               	jr		z,1f	; Not Expanded
     244.  00:414E                      	mainslot_setup	2
     244.  00:414E  E6 03             >  and  3
     244.  00:4150  0F 0F             > [2] rrca
     244.  00:4152  E6 C0             >  and  0xC0
     244.  00:4154  4F                >  ld  c,a
     244.  00:4155  7A                >  ld  a,d
     244.  00:4156  E6 3F             >  and  0x3F
     244.  00:4158  B1                >  or  c
     244.  00:4159  4F                >  ld  c,a
     244.  00:415A                    > 
     244.  00:415A  78                >  ld  a,b
     244.  00:415B  E6 0C             >  and  0x0C
     244.  00:415D  0F 0F             > [2] rrca
     244.  00:415F  E6 03             >  and  3
     244.  00:4161  47                >  ld  b,a
     244.  00:4162  79                >  ld  a,c
     244.  00:4163  D3 A8             >  out  (0A8h),a
     244.  00:4165  3A FF FF          >  ld  a,(0FFFFh)
     244.  00:4168  2F                >  cpl
     244.  00:4169                    >  if (n<=4)
     244.  00:4169  07 07             > [n] RLCA
     244.  00:416B                    >  else
     244.  00:416B                    ~ [8-n] RRCA
     244.  00:416B                    ~  endif
     244.  00:416B  E6 FC             >  and  0xFC
     244.  00:416D  B0                >  or  b
     244.  00:416E                    >  if (n<=4)
     244.  00:416E  0F 0F             > [n] RRCA
     244.  00:4170                    >  else
     244.  00:4170                    ~ [8-n] RLCA
     244.  00:4170                    ~  endif
     244.  00:4170  32 FF FF          >  ld  (0FFFFh),a
     244.  00:4173  47                >  ld  b,a
     245.  00:4174  7A                  1:	ld		a,d				; A = Final value
     246.  00:4175  D3 A8               	out		(0A8h),a		; Slot Final. Ram, rom c, rom c, Main
     247.  00:4177  C9                  	ret
     248.  00:4178                      
     249.  00:4178                      	
      38   00:4178                      		include vdpio.asm
       1.  00:4178                      
       2.  00:4178                             
       3.  00:4178                      ;-------------------------------------
       4.  00:4178                      _cls:		
       5.  00:4178  0E 00               		ld		c,0
       6.  00:417A  51                  		ld		d,c
       7.  00:417B  59                  		ld		e,c
       8.  00:417C  F3                  		di
       9.  00:417D  CD C5 41            		call	_vdpsetvramwr
      10.  00:4180  41                  		ld		b,c
      11.  00:4181  1E 01               		ld		e,1
      12.  00:4183  AF                  		xor		a
      13.  00:4184  D3 98               1:		out		(0x98),a
      14.  00:4186  ED A1               		cpi
      15.  00:4188  EA 84 41            		jp   		pe,1b
      16.  00:418B  1D                  		dec	e
      17.  00:418C  C2 84 41            		jp		nz,1b
      18.  00:418F  C9                  		ret
      19.  00:4190                      		
      20.  00:4190                      _cls0:
      21.  00:4190  0E 00               		ld		c,0
      22.  00:4192  51                  		ld		d,c
      23.  00:4193  59                  		ld		e,c
      24.  00:4194  F3                  		di
      25.  00:4195  CD C5 41            		call	_vdpsetvramwr
      26.  00:4198  FB                  		ei
      27.  00:4199  01 00 A0            		ld		bc,mapHeight*16*256
      28.  00:419C  AF                  		xor		a
      29.  00:419D  D3 98               1:		out		(0x98),a
      30.  00:419F  ED A1                       cpi
      31.  00:41A1  EA 9D 41                    jp   	pe,1b
      32.  00:41A4  C9                  		ret
      33.  00:41A5                      		
      34.  00:41A5                      font_cpy:		
      35.  00:41A5  0E 01               		ld		c,1
      36.  00:41A7  11 00 A0            		ld		de,160*256
      37.  00:41AA  CD C5 41            		call	_vdpsetvramwr
      38.  00:41AD  21 00 A0            		ld		hl,fonts
      39.  00:41B0  3E 0D               		ld		a,:fonts
      40.  00:41B2  16 03               		ld		d,3
      41.  00:41B4  32 00 B0            2:		ld		(_kBank4),a
      42.  00:41B7  01 98 00            		ld		bc,0x98
      43.  00:41BA  1E 20               		ld		e,32
      44.  00:41BC  ED B3               1:		otir
      45.  00:41BE  1D                  		dec	e
      46.  00:41BF  20 FB               		jr	nz,1b
      47.  00:41C1  15                  		dec	d
      48.  00:41C2  20 F0               		jr	nz,2b
      49.  00:41C4  C9                  		ret
      50.  00:41C5                      		
      51.  00:41C5                      ;-------------------------------------
      52.  00:41C5                      		
      53.  00:41C5  (00:0099)           vdpport1 equ 0x99
      54.  00:41C5  (00:009A)           vdpport2 equ 0x9A
      55.  00:41C5                      
      56.  00:41C5                      ; levelcolors:
      57.  00:41C5                      	;  incbin "palette.bin"
      58.  00:41C5                      
      59.  00:41C5                      ; _SetPalet:   
      60.  00:41C5                      		; di
      61.  00:41C5                      		; xor a 			;Set pointer to zero.
      62.  00:41C5                      		; out (vdpport1),a        
      63.  00:41C5                      		; ld  a,16 | 010000000B
      64.  00:41C5                      		; out (vdpport1),a
      65.  00:41C5                      
      66.  00:41C5                      		; ld  hl,levelcolors
      67.  00:41C5                      		; ld bc,vdpport2+32*256
      68.  00:41C5                      		; otir
      69.  00:41C5                      		; ei
      70.  00:41C5                      		; ret
      71.  00:41C5                      
      72.  00:41C5                      ;Set VDP for writing at address CDE (17-bit) 
      73.  00:41C5                      
      74.  00:41C5                      _vdpsetvramwr:
      75.  00:41C5  79                  		ld a,c
      76.  00:41C6                      _vdpsetvramwr2:
      77.  00:41C6                      ;Set VDP for writing at address ADE (17-bit) ;
      78.  00:41C6  CB 02               		rlc d
      79.  00:41C8  17                  		rla
      80.  00:41C9  CB 02               		rlc d
      81.  00:41CB  17                  		rla
      82.  00:41CC  CB 3A               		srl d ; primo shift, il secondo dopo la out
      83.  00:41CE                      
      84.  00:41CE  D3 99               		out (0x99),a ;set bits 14-16
      85.  00:41D0  3E 8E               		ld a,14+128
      86.  00:41D2  D3 99               		out (0x99),a
      87.  00:41D4                      
      88.  00:41D4  CB 3A               		srl d ; secondo shift.     
      89.  00:41D6                      _vdpsetvramwr14
      90.  00:41D6  7B                  		ld a,e ;set bits 0-7
      91.  00:41D7  D3 99               		out (0x99),a
      92.  00:41D9  7A                  		ld a,d ;set bits 8-13
      93.  00:41DA  F6 40               		or 0x40 ; + write access
      94.  00:41DC  D3 99               		out (0x99),a
      95.  00:41DE  C9                  		ret
      96.  00:41DF                      	
      97.  00:41DF                      ;Set VDP port #98 to start reading at address CDE (17-bit) ;
      98.  00:41DF                      
      99.  00:41DF                      _vdpsetvramrd:
     100.  00:41DF  79                  		ld a,c
     101.  00:41E0                      ;Set VDP port #98 to start reading at address ADE (17-bit) ;
     102.  00:41E0  CB 02               		rlc d
     103.  00:41E2  17                  		rla
     104.  00:41E3  CB 02               		rlc d
     105.  00:41E5  17                  		rla
     106.  00:41E6  CB 3A               		srl d 			; primo shift, il secondo dopo la out
     107.  00:41E8                      
     108.  00:41E8  D3 99               		out (0x99),a 	; set bits 14-16
     109.  00:41EA  3E 8E               		ld a,14+128
     110.  00:41EC  D3 99               		out (0x99),a
     111.  00:41EE                      
     112.  00:41EE  CB 3A               		srl d 	; secondo shift.            
     113.  00:41F0  7B                  		ld a,e 	; set bits 0-7
     114.  00:41F1  D3 99               		out (0x99),a
     115.  00:41F3  7A                  		ld a,d 	; set bits 8-13
     116.  00:41F4  E6 3F               		and 0x3F
     117.  00:41F6  D3 99               		out (0x99),a
     118.  00:41F8  C9                  		ret
     119.  00:41F9                      
     120.  00:41F9                      ;Display page E in screen 5
     121.  00:41F9                      _setpage:
     122.  00:41F9  7B                  	ld a,e
     123.  00:41FA  87 87 87 87 87      [5]	add a,a ;x32
     124.  00:41FF  F6 1F               	or	 00011111B
     125.  00:4201  F3                  	di
     126.  00:4202  D3 99               	out (0x99),a
     127.  00:4204  3E 82               	ld a,2+128
     128.  00:4206  D3 99               	out (0x99),a
     129.  00:4208  FB                  	ei            
     130.  00:4209  C9                  	ret
     131.  00:420A                      
     132.  00:420A  (00:005F)           chgmod        equ     0x005f      ;change graphic mode
     133.  00:420A  (00:000C)           RDSLT         equ     0x000c      ;read address HL in slot A
     134.  00:420A  (00:0156)           KILBUF        equ     0x0156      ;clear keyboard buffer
     135.  00:420A                      
     136.  00:420A                      set_scr:
     137.  00:420A                      	
     138.  00:420A                      	// sprites 16x16
     139.  00:420A  3A E0 F3            	ld		a,(RG1SAV)
     140.  00:420D  F6 02               	or		00000010B
     141.  00:420F  32 E0 F3            	ld		(RG1SAV),a
     142.  00:4212                      
     143.  00:4212                      	// enable sprites + TP
     144.  00:4212  3A E7 FF            	ld		a,(RG8SAV)
     145.  00:4215                      	; or		00100010B
     146.  00:4215  F6 20               	or		00100000B
     147.  00:4217  32 E7 FF            	ld		(RG8SAV),a
     148.  00:421A                      		
     149.  00:421A                      	// Set @50Hz (only PAL is supported)
     150.  00:421A  3A 13 CA            	ld	a,(SEL_NTSC)
     151.  00:421D  A7                  	and 	a
     152.  00:421E  20 07               	jr		nz,1f
     153.  00:4220                      	
     154.  00:4220  3A E8 FF            	ld		a,(RG9SAV)		
     155.  00:4223  F6 02               	or		00000010B		; PAL
     156.  00:4225  18 05               	jr	2f
     157.  00:4227                      1:		
     158.  00:4227  3A E8 FF            	ld		a,(RG9SAV)		
     159.  00:422A  E6 FD               	and		11111101B		; NTSC 
     160.  00:422C  32 E8 FF            2:	ld		(RG9SAV),a
     161.  00:422F                      
     162.  00:422F  3E 08               	ld  	a,8
     163.  00:4231  CD 5F 00            	call	chgmod
     164.  00:4234                      
     165.  00:4234  3A E8 FF            	ld		a,(RG9SAV)		
     166.  00:4237  E6 7F               	and		01111111B		; 192 lines	
     167.  00:4239  32 E8 FF            	ld		(RG9SAV),a
     168.  00:423C  D3 99               	out		(0x99),a
     169.  00:423E  3E 89               	ld		a,9+128
     170.  00:4240  D3 99               	out		(0x99),a
     171.  00:4242                      	
     172.  00:4242                      	// border color
     173.  00:4242  AF                  	xor		a
     174.  00:4243  32 E6 F3            	ld		(RG7SAV),a
     175.  00:4246  D3 99               	out		(0x99),a
     176.  00:4248  3E 87               	ld		a,7+128
     177.  00:424A  D3 99               	out		(0x99),a
     178.  00:424C  C9                  	ret
     179.  00:424D                      
     180.  00:424D                      
     181.  00:424D                      _waitvdp:
     182.  00:424D  3E 02               	ld a,2
     183.  00:424F  D3 99               	out (0x99),a
     184.  00:4251  3E 8F               	ld a, 128+15
     185.  00:4253  D3 99               	out (0x99),a
     186.  00:4255  DB 99               1:  in	a,(0x99)
     187.  00:4257  0F                  	rrca
     188.  00:4258  DA 55 42            	jp c,1b
     189.  00:425B                      
     190.  00:425B  C9                  	ret
     191.  00:425C                      
     192.  00:425C                      ; .inf:
     193.  00:425C                      	; ld	a,r			; random colour
     194.  00:425C                      	; out		(0x99),a
     195.  00:425C                      	; ld		a,7+128
     196.  00:425C                      	; out		(0x99),a
     197.  00:425C                      	; jp	1b
     198.  00:425C                      	
      39   00:425C                      		include isr.asm
       1.  00:425C                      
       2.  00:425C                      
       3.  00:425C                      isr_set:
       4.  00:425C  F3                  		di
       5.  00:425D  21 38 00            		ld	hl,0x0038
       6.  00:4260  36 C3               		ld	(hl),0xC3
       7.  00:4262  23                  		inc	hl
       8.  00:4263  36 9B               		ld	(hl),low _scroll
       9.  00:4265  23                  		inc	hl
      10.  00:4266  36 42               		ld	(hl),high _scroll
      11.  00:4268                      
      12.  00:4268  3E 9E               		ld    A,YSIZE-2
      13.  00:426A  D3 99               		out (0x99),a
      14.  00:426C  3E 93               		ld    A,19+128
      15.  00:426E  D3 99               		out (0x99),a	; set interrupt line
      16.  00:4270                      	
      17.  00:4270  3A DF F3            		ld    A,(RG0SAV)
      18.  00:4273  F6 10               		or    00010000B
      19.  00:4275  32 DF F3            		ld    (RG0SAV),A
      20.  00:4278  D3 99               		out (0x99),a
      21.  00:427A  3E 80               		ld    A,0+128
      22.  00:427C  D3 99               		out (0x99),a	; enable line interrupt
      23.  00:427E  C9                  		ret
      24.  00:427F                      	
      25.  00:427F                      isr_reset:
      26.  00:427F  F3                  		di
      27.  00:4280  21 38 00            		ld	hl,0x0038
      28.  00:4283  36 C3               		ld	(hl),0xC3
      29.  00:4285  23                  		inc	hl
      30.  00:4286  36 BA               		ld	(hl),low _fake_isr
      31.  00:4288  23                  		inc	hl
      32.  00:4289  36 42               		ld	(hl),high _fake_isr
      33.  00:428B                      
      34.  00:428B  3A DF F3            		ld    A,(RG0SAV)
      35.  00:428E  E6 EF               		and    11101111B
      36.  00:4290  32 DF F3            		ld    (RG0SAV),A
      37.  00:4293  D3 99               		out (0x99),a
      38.  00:4295  3E 80               		ld    A,0+128
      39.  00:4297  D3 99               		out (0x99),a	; disable line interrupt		
      40.  00:4299  FB                  		ei
      41.  00:429A  C9                  		ret
      42.  00:429B                      
      43.  00:429B                      
      44.  00:429B                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      45.  00:429B                      ;  actual ISR handler
      46.  00:429B                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      47.  00:429B                      
      48.  00:429B                      _scroll:
      49.  00:429B  F5                  		push	af
      50.  00:429C                      		
      51.  00:429C  3E 01               		ld a,1 			; read S#1
      52.  00:429E  D3 99               		out (0x99),a
      53.  00:42A0  3E 8F               		ld a,128+15
      54.  00:42A2  D3 99               		out (0x99),a
      55.  00:42A4                      		 
      56.  00:42A4  DB 99               		in	a,(0x99)
      57.  00:42A6  1F                  		rra
      58.  00:42A7  DA 37 43            		jp	c,lint	
      59.  00:42AA                      
      60.  00:42AA  AF                  		xor	a 			; read S#0
      61.  00:42AB  D3 99               		out (0x99),a
      62.  00:42AD  3E 8F               		ld a,128+15
      63.  00:42AF  D3 99               		out (0x99),a
      64.  00:42B1                      		 
      65.  00:42B1  DB 99               		in	a,(0x99)
      66.  00:42B3  07                  		rlca
      67.  00:42B4  DA C7 42            		jp	c,vblank
      68.  00:42B7                      		
      69.  00:42B7  F1                  		pop	af			; none of them (?)
      70.  00:42B8  FB                  		ei
      71.  00:42B9  C9                  		ret
      72.  00:42BA                      
      73.  00:42BA                      _fake_isr:
      74.  00:42BA  F5                  		push	af
      75.  00:42BB                      
      76.  00:42BB  AF                  		xor	a 			; read S#0
      77.  00:42BC  D3 99               		out (0x99),a
      78.  00:42BE  3E 8F               		ld a,128+15
      79.  00:42C0  D3 99               		out (0x99),a
      80.  00:42C2                      		 
      81.  00:42C2  DB 99               		in	a,(0x99)
      82.  00:42C4                      		
      83.  00:42C4  F1                  		pop	af			
      84.  00:42C5  FB                  		ei
      85.  00:42C6  C9                  		ret
      86.  00:42C7                      		
      87.  00:42C7                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      88.  00:42C7                      ;  VBLANK
      89.  00:42C7                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      90.  00:42C7                      	
      91.  00:42C7                      vblank:
      92.  00:42C7  3A E7 FF            		ld	a,(RG8SAV)
      93.  00:42CA  E6 FD               		and	011111101B		
      94.  00:42CC  32 E7 FF            		ld	(RG8SAV),a
      95.  00:42CF  D3 99               		out	(0x99),a
      96.  00:42D1  3E 88               		ld	a,8+128
      97.  00:42D3  D3 99               		out	(0x99),a			; enable sprites
      98.  00:42D5                      
      99.  00:42D5                      		; ld	a,(noscroll)
     100.  00:42D5                      		; or	a
     101.  00:42D5                      		; jr	z,1f
     102.  00:42D5                      		
     103.  00:42D5  E5                  		push   hl         
     104.  00:42D6  D5                  		push   de         
     105.  00:42D7  C5                  		push   bc         
     106.  00:42D8  D9                  		exx               
     107.  00:42D9  08                  		ex     af,af'     
     108.  00:42DA  E5                  		push   hl         
     109.  00:42DB  D5                  		push   de         
     110.  00:42DC  C5                  		push   bc         
     111.  00:42DD  F5                  		push   af         
     112.  00:42DE  FD E5               		push   iy         
     113.  00:42E0  DD E5               		push   ix         
     114.  00:42E2                      
     115.  00:42E2  CD D9 43            		call	pageswap			; test for page swap
     116.  00:42E5  CD 07 44            		call	reset_sliceflag
     117.  00:42E8                      		
     118.  00:42E8  2A 1E CA            		ld	hl,(_xmappos)			; corner top left of the screen window in the map in pixels
     119.  00:42EB                      
     120.  00:42EB                      		repeat 4
     121.  00:42EB                    < 		srl	h
     122.  00:42EB                    < 		rr	l
     123.  00:42EB                    < 		endrepeat					; corner top left of the screen window in the map in tiles
     123.  00:42EB  CB 3C CB 1D CB 3C CB 1D CB 3C CB 1D CB 3C CB 1D 
     124.  00:42FB                      		
     125.  00:42FB  3A 22 CA            		ld		a,(_xspeed+1)
     126.  00:42FE  CB 07               		rlc a
     127.  00:4300  DA 10 43            		jp	c,.scroll_left
     128.  00:4303                      		
     129.  00:4303                      .scroll_right		
     130.  00:4303  11 0F C0            		ld	de,_levelmap+15
     131.  00:4306  19                  		add	hl,de					; HL = corner top right of the screen window in the map in tiles
     132.  00:4307                      
     133.  00:4307  CD CB 43            		call	xscroll				; move the screen ! Not if VDP commands are being executed			
     134.  00:430A  CD 6B 45            		call	brdrs_right			; build a column right pointed by HL, clear a column left, move a stripe of screen
     135.  00:430D                      		
     136.  00:430D                      		bdrclr 00000011B
     136.  00:430D                    >   if debug
     136.  00:430D                    ~   ifdif n,0
     136.  00:430D                    ~    ld  a,n
     136.  00:430D                    ~   else
     136.  00:430D                    ~    xor a
     136.  00:430D                    ~   endif
     136.  00:430D                    ~   out  (0x99),a
     136.  00:430D                    ~   ld  a,7+128
     136.  00:430D                    ~   out  (0x99),a
     136.  00:430D                    ~   endif
     137.  00:430D                      		
     138.  00:430D  C3 1A 43            		jp	.return
     139.  00:4310                      		
     140.  00:4310                      .scroll_left
     141.  00:4310  11 00 C0            		ld	de,_levelmap+0
     142.  00:4313  19                  		add	hl,de					; HL = corner top left of the screen window in the map in tiles
     143.  00:4314                      		
     144.  00:4314  CD CB 43            		call	xscroll				; move the screen ! Not if VDP commands are being executed			
     145.  00:4317  CD 5D 45            		call	brdrs_left			; build a column left pointed by HL, clear a column right, move a stripe of screen
     146.  00:431A                      		
     147.  00:431A                      		bdrclr 00000011B
     147.  00:431A                    >   if debug
     147.  00:431A                    ~   ifdif n,0
     147.  00:431A                    ~    ld  a,n
     147.  00:431A                    ~   else
     147.  00:431A                    ~    xor a
     147.  00:431A                    ~   endif
     147.  00:431A                    ~   out  (0x99),a
     147.  00:431A                    ~   ld  a,7+128
     147.  00:431A                    ~   out  (0x99),a
     147.  00:431A                    ~   endif
     148.  00:431A                      		
     149.  00:431A                      .return
     150.  00:431A  CD 52 44            		call 	changexpos
     151.  00:431D  CD 1B 44            		call 	changespeed
     152.  00:4320                      		
     153.  00:4320                      		if debug		
     154.  00:4320                    ~ 		ld	hl,256	;XXXX
     155.  00:4320                    ~ 		ld	(_xspeed),hl
     156.  00:4320                    ~ 		endif
     157.  00:4320                      		
     158.  00:4320  2A 9E FC            		ld	hl,(_jiffy)				; timer
     159.  00:4323  23                  		inc	hl
     160.  00:4324  22 9E FC            		ld	(_jiffy),hl
     161.  00:4327                      				
     162.  00:4327                      		; call _waitvdp
     163.  00:4327                      		bdrclr 0
     163.  00:4327                    >   if debug
     163.  00:4327                    ~   ifdif n,0
     163.  00:4327                    ~    ld  a,n
     163.  00:4327                    ~   else
     163.  00:4327                    ~    xor a
     163.  00:4327                    ~   endif
     163.  00:4327                    ~   out  (0x99),a
     163.  00:4327                    ~   ld  a,7+128
     163.  00:4327                    ~   out  (0x99),a
     163.  00:4327                    ~   endif
     164.  00:4327                      		
     165.  00:4327  DD E1               		pop    ix         
     166.  00:4329  FD E1               		pop    iy         
     167.  00:432B  F1                  		pop    af         
     168.  00:432C  C1                  		pop    bc         
     169.  00:432D  D1                  		pop    de         
     170.  00:432E  E1                  		pop    hl         
     171.  00:432F  08                  		ex     af,af'     
     172.  00:4330  D9                  		exx               
     173.  00:4331  C1                  		pop    bc         
     174.  00:4332  D1                  		pop    de         
     175.  00:4333  E1                  		pop    hl         
     176.  00:4334                      
     177.  00:4334                      1:		
     178.  00:4334  F1                  		pop	af
     179.  00:4335  FB                  		ei
     180.  00:4336  C9                  		ret
     181.  00:4337                      		
     182.  00:4337                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     183.  00:4337                      ;  Line Interrupt
     184.  00:4337                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     185.  00:4337                      	; -hperiod number of CPU cycles per HBlank [228]
     186.  00:4337                      	; -vperiod number of CPU cycles per VBlank in NTSC [59736]
     187.  00:4337                      lint:
     188.  00:4337  3A E0 F3            		ld	a,(RG1SAV)
     189.  00:433A  E6 BF               		and	010111111B			; disable screen
     190.  00:433C  32 E0 F3            		ld	(RG1SAV),a
     191.  00:433F  D3 99               		out	(0x99),a
     192.  00:4341  3E 81               		ld	a,1+128
     193.  00:4343  D3 99               		out	(0x99),a
     194.  00:4345                      
     195.  00:4345  E5                  		push   hl         
     196.  00:4346  D5                  		push   de         
     197.  00:4347  C5                  		push   bc         
     198.  00:4348  D9                  		exx               
     199.  00:4349  08                  		ex     af,af'     
     200.  00:434A  E5                  		push   hl         
     201.  00:434B  D5                  		push   de         
     202.  00:434C  C5                  		push   bc         
     203.  00:434D  F5                  		push   af         
     204.  00:434E  FD E5               		push   iy         
     205.  00:4350  DD E5               		push   ix         
     206.  00:4352                      		
     207.  00:4352  3A E7 FF            		ld		a,(RG8SAV)
     208.  00:4355  F6 02               		or		000000010B		
     209.  00:4357  32 E7 FF            		ld		(RG8SAV),a
     210.  00:435A  D3 99               		out		(0x99),a
     211.  00:435C  3E 88               		ld		a,8+128
     212.  00:435E  D3 99               		out		(0x99),a		; disable sprites
     213.  00:4360                      		
     214.  00:4360  3E 3F               		ld a,3FH				; 0XX11111B
     215.  00:4362  D3 99               		out (0x99),a
     216.  00:4364  3E 82               		ld a,2+128				; R#2 
     217.  00:4366  D3 99               		out (0x99),a			; score bar in page 1
     218.  00:4368                      
     219.  00:4368  1E 08               		ld	e,8
     220.  00:436A  CD 3F 49            		call	checkkbd
     221.  00:436D  32 1B CA            		ld	(joystick),a		
     222.  00:4370  1E 00               		ld	e,0
     223.  00:4372  CD 3F 49            		call	checkkbd
     224.  00:4375  32 1C CA            		ld	(keys0_7),a
     225.  00:4378                      		
     226.  00:4378                      		; call	set_displaypage	; update displaypage and _xoffset
     227.  00:4378                      		
     228.  00:4378  CD B4 43 CD B4 43   [2]		call	waitHBLANK		; now we are at the start of HBLANK
     229.  00:437E  CD 4D 42            		call 	_waitvdp		; do not update r#18 if the vdp is copying
     230.  00:4381  CD B4 43            		call	waitHBLANK		; now we are at the start of HBLANK
     231.  00:4384                      		
     232.  00:4384  AF                  		xor	a
     233.  00:4385  D3 99               		out	(099h),a
     234.  00:4387  3E 92               		ld	a,18+128
     235.  00:4389  D3 99               		out	(099h),a			; score bar fixed 
     236.  00:438B                      		
     237.  00:438B  3A E0 F3            		ld	a,(RG1SAV)
     238.  00:438E  F6 42               		or 	01000010B			; enable screen
     239.  00:4390  32 E0 F3            		ld	(RG1SAV),a
     240.  00:4393  D3 99               		out	(0x99),a
     241.  00:4395  3E 81               		ld	a,1+128
     242.  00:4397  D3 99               		out	(0x99),a
     243.  00:4399                      
     244.  00:4399                      
     245.  00:4399                      		
     246.  00:4399                      		
     247.  00:4399                      		; ld	e,6
     248.  00:4399                      		; call	checkkbd
     249.  00:4399                      		; and		1				; SHIFT
     250.  00:4399                      		; ld		a,(_xoffset)
     251.  00:4399                      		; cp	14
     252.  00:4399                      		; call 	z,animtest
     253.  00:4399  3A 26 CA            		ld		a,(_xoffset)
     254.  00:439C  FE 0F               		cp	15
     255.  00:439E  CC 8D 48            		call 	z,animtest
     256.  00:43A1                      		
     257.  00:43A1                      								;  update displaypage and _xoffset
     258.  00:43A1  CD EA 43            		call	set_displaypage	; it has to be the LAST action in lint
     259.  00:43A4                      		
     260.  00:43A4  DD E1               		pop    ix         
     261.  00:43A6  FD E1               		pop    iy         
     262.  00:43A8  F1                  		pop    af         
     263.  00:43A9  C1                  		pop    bc         
     264.  00:43AA  D1                  		pop    de         
     265.  00:43AB  E1                  		pop    hl         
     266.  00:43AC  08                  		ex     af,af'     
     267.  00:43AD  D9                  		exx               
     268.  00:43AE  C1                  		pop    bc         
     269.  00:43AF  D1                  		pop    de         
     270.  00:43B0  E1                  		pop    hl         
     271.  00:43B1                      
     272.  00:43B1  F1                  		pop	 af
     273.  00:43B2  FB                  		ei
     274.  00:43B3  C9                  		ret
     275.  00:43B4                      	
     276.  00:43B4                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;	
     277.  00:43B4                      ; ; manage score bar at YSIZE
     278.  00:43B4                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;	
     279.  00:43B4                      waitHBLANK:
     280.  00:43B4  3E 02               		ld a,2 				; read S#2
     281.  00:43B6  D3 99               		out (0x99),a
     282.  00:43B8  3E 8F               		ld a,128+15
     283.  00:43BA  D3 99               		out (0x99),a		; poll for HBLANK
     284.  00:43BC                      		 
     285.  00:43BC  DB 99               1:		in	a,(0x99)		; if 1 we are in HBLANK already, so wait until end of HBLANK
     286.  00:43BE  E6 20               		and	0x20
     287.  00:43C0  C2 BC 43            		jp	nz,1b			
     288.  00:43C3                      
     289.  00:43C3  DB 99               1:		in	a,(0x99)		; wait until end of the active area
     290.  00:43C5  E6 20               		and	0x20
     291.  00:43C7  CA C3 43            		jp	z,1b
     292.  00:43CA  C9                  		ret
     293.  00:43CB                      	
     294.  00:43CB                      ; lint:	
     295.  00:43CB                      		; ; call	waitHBLANK
     296.  00:43CB                      		; ; now we are at the start of HBLANK
     297.  00:43CB                      	
     298.  00:43CB                      		; ; ld	a,(RG1SAV)
     299.  00:43CB                      		; ; and	010111111B			; disable screen
     300.  00:43CB                      		; ; ld	(RG1SAV),a
     301.  00:43CB                      		; ; out	(0x99),a
     302.  00:43CB                      		; ; ld	a,1+128
     303.  00:43CB                      		; ; out	(0x99),a
     304.  00:43CB                      
     305.  00:43CB                      
     306.  00:43CB                      		; ld a,00011111B		; 0XX11111B
     307.  00:43CB                      		; out (0x99),a
     308.  00:43CB                      		; ld a,2+128			; R#2 
     309.  00:43CB                      		; out (0x99),a		; score bar in page 0
     310.  00:43CB                      
     311.  00:43CB                      		; ld    A,mapHeight*16-(YSIZE-2)	; SCROLL DOWN
     312.  00:43CB                      		; out (0x99),a
     313.  00:43CB                      		; ld    A,23+128
     314.  00:43CB                      		; out (0x99),a
     315.  00:43CB                      
     316.  00:43CB                      		; xor		a
     317.  00:43CB                      		; out	(099h),a
     318.  00:43CB                      		; ld	a,18+128
     319.  00:43CB                      		; out	(099h),a		; set adjust 0,0
     320.  00:43CB                      
     321.  00:43CB                      
     322.  00:43CB                      		; ld	a,(RG8SAV)
     323.  00:43CB                      		; or	000000010B		; disable sprites
     324.  00:43CB                      		; ld	(RG8SAV),a
     325.  00:43CB                      		; out	(0x99),a
     326.  00:43CB                      		; ld	a,8+128
     327.  00:43CB                      		; out	(0x99),a
     328.  00:43CB                      
     329.  00:43CB                      		; ; call	waitHBLANK
     330.  00:43CB                      		
     331.  00:43CB                      		; ; ld	a,(RG1SAV)
     332.  00:43CB                      		; ; or 	01000010B		; enable screen
     333.  00:43CB                      		; ; ld	(RG1SAV),a
     334.  00:43CB                      		; ; out	(0x99),a
     335.  00:43CB                      		; ; ld	a,1+128
     336.  00:43CB                      		; ; out	(0x99),a
     337.  00:43CB                      	
     338.  00:43CB                      		; push   hl         
     339.  00:43CB                      		; push   de         
     340.  00:43CB                      		; push   bc         
     341.  00:43CB                      		; exx               
     342.  00:43CB                      		; ex     af,af'     
     343.  00:43CB                      		; push   hl         
     344.  00:43CB                      		; push   de         
     345.  00:43CB                      		; push   bc         
     346.  00:43CB                      		; push   af         
     347.  00:43CB                      		; push   iy         
     348.  00:43CB                      		; push   ix         
     349.  00:43CB                      
     350.  00:43CB                      		
     351.  00:43CB                      		; ld	hl,.exit
     352.  00:43CB                      		; push	hl
     353.  00:43CB                      		; ld		a,(dxmap)
     354.  00:43CB                      		; rlc a
     355.  00:43CB                      
     356.  00:43CB                      		; jp	nc,_blank_line_lft		; >0 == dx
     357.  00:43CB                      		; jp	 c,_blank_line_rgt		; <0 == sx
     358.  00:43CB                      ; 1:		pop	hl
     359.  00:43CB                      ; .exit:
     360.  00:43CB                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     361.  00:43CB                      		; ; ld		a,00001000B
     362.  00:43CB                      		; ; out		(0x99),a
     363.  00:43CB                      		; ; ld		a,7+128
     364.  00:43CB                      		; ; out		(0x99),a
     365.  00:43CB                      		
     366.  00:43CB                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     367.  00:43CB                      		; call	test_star
     368.  00:43CB                      
     369.  00:43CB                      		; xor		a
     370.  00:43CB                      		; out		(0x99),a
     371.  00:43CB                      		; ld		a,7+128
     372.  00:43CB                      		; out		(0x99),a
     373.  00:43CB                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     374.  00:43CB                      		
     375.  00:43CB                      		; pop    ix         
     376.  00:43CB                      		; pop    iy         
     377.  00:43CB                      		; pop    af         
     378.  00:43CB                      		; pop    bc         
     379.  00:43CB                      		; pop    de         
     380.  00:43CB                      		; pop    hl         
     381.  00:43CB                      		; ex     af,af'     
     382.  00:43CB                      		; exx               
     383.  00:43CB                      		; pop    bc         
     384.  00:43CB                      		; pop    de         
     385.  00:43CB                      		; pop    hl         
     386.  00:43CB                      
     387.  00:43CB                      		; pop		af
     388.  00:43CB                      		; ei
     389.  00:43CB                      		; ret
     390.  00:43CB                      
     391.  00:43CB                      ; ;-------------------------------------		
     392.  00:43CB                      
     393.  00:43CB                      ; border_color	equ 	0;	00100101B
     394.  00:43CB                      		
     395.  00:43CB                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;	
     396.  00:43CB                      ; ;   manage normal vblank routine
     397.  00:43CB                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;	
     398.  00:43CB                      
     399.  00:43CB                      ; vblank:
     400.  00:43CB                      		; call	activate_window	
     401.  00:43CB                      
     402.  00:43CB                      		; push   hl         
     403.  00:43CB                      		; push   de         
     404.  00:43CB                      		; push   bc         
     405.  00:43CB                      		; exx               
     406.  00:43CB                      		; ex     af,af'     
     407.  00:43CB                      		; push   hl         
     408.  00:43CB                      		; push   de         
     409.  00:43CB                      		; push   bc         
     410.  00:43CB                      		; push   af         
     411.  00:43CB                      		; push   iy         
     412.  00:43CB                      		; push   ix         
     413.  00:43CB                      
     414.  00:43CB                      		; ; ld	a,00011100B		; red
     415.  00:43CB                      		; ; out		(0x99),a
     416.  00:43CB                      		; ; ld		a,7+128
     417.  00:43CB                      		; ; out		(0x99),a
     418.  00:43CB                      
     419.  00:43CB                      		; call	changedir
     420.  00:43CB                      				
     421.  00:43CB                      		; ld	hl,(_jiffy)
     422.  00:43CB                      		; inc	hl
     423.  00:43CB                      		; ld	(_jiffy),hl
     424.  00:43CB                      				
     425.  00:43CB                      		; ; ld	a,00011100B		; red
     426.  00:43CB                      		; ; out	(0x99),a
     427.  00:43CB                      		; ; ld	a,7+128
     428.  00:43CB                      		; ; out	(0x99),a
     429.  00:43CB                      		
     430.  00:43CB                      
     431.  00:43CB                      		; ; xor		a		; black
     432.  00:43CB                      		; ; out	(0x99),a
     433.  00:43CB                      		; ; ld	a,7+128
     434.  00:43CB                      		; ; out	(0x99),a
     435.  00:43CB                      	
     436.  00:43CB                      		; pop    ix         
     437.  00:43CB                      		; pop    iy         
     438.  00:43CB                      		; pop    af         
     439.  00:43CB                      		; pop    bc         
     440.  00:43CB                      		; pop    de         
     441.  00:43CB                      		; pop    hl         
     442.  00:43CB                      		; ex     af,af'     
     443.  00:43CB                      		; exx               
     444.  00:43CB                      		; pop    bc         
     445.  00:43CB                      		; pop    de         
     446.  00:43CB                      		; pop    hl         
     447.  00:43CB                      
     448.  00:43CB                      		; pop		af
     449.  00:43CB                      		; ei
     450.  00:43CB                      		; ret
     451.  00:43CB                      ; ;-------------------------------------
     452.  00:43CB                      ; ;-------------------------------------
     453.  00:43CB                      
     454.  00:43CB                      ; _blank_line_lft:
     455.  00:43CB                      		; ; ld	a,00000111B		; blue
     456.  00:43CB                      		; ; out	(0x99),a
     457.  00:43CB                      		; ; ld	a,7+128
     458.  00:43CB                      		; ; out	(0x99),a
     459.  00:43CB                      
     460.  00:43CB                      		; ld	e,0
     461.  00:43CB                      		; call	blank_line
     462.  00:43CB                      
     463.  00:43CB                      		
     464.  00:43CB                      		
     465.  00:43CB                      		; ; xor	a
     466.  00:43CB                      		; ; out	(0x99),a
     467.  00:43CB                      		; ; ld	a,7+128
     468.  00:43CB                      		; ; out	(0x99),a
     469.  00:43CB                      		; ret
     470.  00:43CB                      
     471.  00:43CB                      ; ;-------------------------------------	
     472.  00:43CB                      
     473.  00:43CB                      ; _blank_line_rgt
     474.  00:43CB                      		; ; ld	a,00000111B		; blue
     475.  00:43CB                      		; ; out	(0x99),a
     476.  00:43CB                      		; ; ld	a,7+128
     477.  00:43CB                      		; ; out	(0x99),a
     478.  00:43CB                      
     479.  00:43CB                      		; ld	e,240
     480.  00:43CB                      		; call	blank_line
     481.  00:43CB                      
     482.  00:43CB                      		; ; xor	a
     483.  00:43CB                      		; ; out	(0x99),a
     484.  00:43CB                      		; ; ld	a,7+128
     485.  00:43CB                      		; ; out	(0x99),a
     486.  00:43CB                      		; ret
     487.  00:43CB                      		
     488.  00:43CB                      ; ;-------------------------------------	
     489.  00:43CB                      		
     490.  00:43CB                      ; inc_xoffset
     491.  00:43CB                      		; call	plot_line_rgt1
     492.  00:43CB                      		; call	.movex
     493.  00:43CB                      		; call	plot_line_rgt2
     494.  00:43CB                      				
     495.  00:43CB                      		; ; ld	a,00000010B		; blue
     496.  00:43CB                      		; ; out	(0x99),a
     497.  00:43CB                      		; ; ld	a,7+128
     498.  00:43CB                      		; ; out	(0x99),a
     499.  00:43CB                      		
     500.  00:43CB                      		; jp		newxmap
     501.  00:43CB                      		
     502.  00:43CB                      ; .movex
     503.  00:43CB                      		; ld		a,(_xoffset)
     504.  00:43CB                      		; and		a
     505.  00:43CB                      		; jr		nz,.case1_15
     506.  00:43CB                      ; .case0
     507.  00:43CB                      		; ld 		a,(_displaypage)
     508.  00:43CB                      		; xor		1
     509.  00:43CB                      		; ld 		d,a
     510.  00:43CB                      		; ld		e,240
     511.  00:43CB                      		; jp		clrboder
     512.  00:43CB                      		
     513.  00:43CB                      ; .case1_15
     514.  00:43CB                      ; [4]		add		a,a
     515.  00:43CB                      		; ld		e,a
     516.  00:43CB                      		; sub		a,16
     517.  00:43CB                      		; ld		d,a
     518.  00:43CB                      		; jp		move_block
     519.  00:43CB                      
     520.  00:43CB                      
     521.  00:43CB                      ; ;-------------------------------------	
     522.  00:43CB                      	
     523.  00:43CB                      ; dec_xoffset
     524.  00:43CB                      		; call	plot_line_lft1
     525.  00:43CB                      		; call	.movex
     526.  00:43CB                      		; call	plot_line_lft2
     527.  00:43CB                      				
     528.  00:43CB                      		; ; ld	a,00000011B		; blue
     529.  00:43CB                      		; ; out	(0x99),a
     530.  00:43CB                      		; ; ld	a,7+128
     531.  00:43CB                      		; ; out	(0x99),a
     532.  00:43CB                      
     533.  00:43CB                      		; jp		newxmap
     534.  00:43CB                      		
     535.  00:43CB                      ; .movex
     536.  00:43CB                      		; ld		a,(_xoffset)
     537.  00:43CB                      		; cp	15
     538.  00:43CB                      		; jr		nz,.case0_14
     539.  00:43CB                      ; .case15
     540.  00:43CB                      		; ld 		a,(_displaypage)
     541.  00:43CB                      		; xor		1
     542.  00:43CB                      		; ld 		d,a
     543.  00:43CB                      		; ld		e,0
     544.  00:43CB                      		; jp		clrboder
     545.  00:43CB                      		
     546.  00:43CB                      ; .case0_14
     547.  00:43CB                      ; [4]		add		a,a
     548.  00:43CB                      		; ld		e,a
     549.  00:43CB                      		; add		a,16
     550.  00:43CB                      		; ld		d,a
     551.  00:43CB                      		; jp		move_block
     552.  00:43CB                      
     553.  00:43CB                      
     554.  00:43CB                      ; ;-------------------------------------
     555.  00:43CB                      ; newxmap
     556.  00:43CB                      		; call 	plot_enemy		
     557.  00:43CB                      		; call	color_enemy
     558.  00:43CB                      
     559.  00:43CB                      		; ld		hl,(_xmapx4)
     560.  00:43CB                      		; ld		a,(dxmap)
     561.  00:43CB                      		; ld		e,a
     562.  00:43CB                      		; add 	a,a
     563.  00:43CB                      		; sbc 	a,a
     564.  00:43CB                      		; ld		d,a
     565.  00:43CB                      		; add 	hl,de
     566.  00:43CB                      		; ld		(_xmapx4),hl
     567.  00:43CB                      		; repeat 2
     568.  00:43CB                      		; sra		h
     569.  00:43CB                      		; rr  	l
     570.  00:43CB                      		; endrepeat
     571.  00:43CB                      		; ld		(xmap),hl
     572.  00:43CB                      		; ld 		a,l
     573.  00:43CB                      		; and		15
     574.  00:43CB                      		; ld		(_xoffset),a
     575.  00:43CB                      		; repeat 4
     576.  00:43CB                      		; sra		h
     577.  00:43CB                      		; rr  	l
     578.  00:43CB                      		; endrepeat
     579.  00:43CB                      		; ld 		a,l
     580.  00:43CB                      		; and		1
     581.  00:43CB                      		; ld		(_displaypage),a
     582.  00:43CB                      		; ld		de,_levelmap
     583.  00:43CB                      		; add		hl,de
     584.  00:43CB                      		; ld		(_levelmap_pos),hl
     585.  00:43CB                      		; ret
     586.  00:43CB                      		
     587.  00:43CB                      ; ;-------------------------------------
     588.  00:43CB                      
     589.  00:43CB                      ; activate_window	
     590.  00:43CB                      		; ld	a,(_displaypage)
     591.  00:43CB                      ; [5]		add a,a 			; x32
     592.  00:43CB                      		; or	00011111B
     593.  00:43CB                      		; out (0x99),a
     594.  00:43CB                      		; ld a,2+128
     595.  00:43CB                      		; out (0x99),a
     596.  00:43CB                      		
     597.  00:43CB                      		; ld    A,(_yoffset)		; SCROLL DOWN
     598.  00:43CB                      		; out (0x99),a
     599.  00:43CB                      		; add    A,YSIZE-1
     600.  00:43CB                      		; ld		l,a
     601.  00:43CB                      		; ld    A,23+128
     602.  00:43CB                      		; out (0x99),a
     603.  00:43CB                      
     604.  00:43CB                      		; ld    a,l
     605.  00:43CB                      		; out (0x99),a			; set interrupt line
     606.  00:43CB                      		; ld    A,19+128
     607.  00:43CB                      		; out (0x99),a
     608.  00:43CB                      		
     609.  00:43CB                      		; ld	a,(_xoffset)		; set R#18 only if not scrolling
     610.  00:43CB                      		; add	a,-8
     611.  00:43CB                      		; and	0Fh
     612.  00:43CB                      		; out	(099h),a
     613.  00:43CB                      		; ld	a,18+128
     614.  00:43CB                      		; out	(099h),a
     615.  00:43CB                      
     616.  00:43CB                      		; ld	a,(RG8SAV)		; enable sprites
     617.  00:43CB                      		; and	11111101B
     618.  00:43CB                      		; ld	(RG8SAV),a
     619.  00:43CB                      		; out	(0x99),a
     620.  00:43CB                      		; ld	a,8+128
     621.  00:43CB                      		; out	(0x99),a
     622.  00:43CB                      
     623.  00:43CB                      		; ret
     624.  00:43CB                      			
     625.  00:43CB                      ; ;-------------------------------------
     626.  00:43CB                      	
     627.  00:43CB                      ; changedir:
     628.  00:43CB                      		; ld		a,(_dxmap)
     629.  00:43CB                      		; and		128
     630.  00:43CB                      		; ld		b,a
     631.  00:43CB                      		; inc		hl
     632.  00:43CB                      		; ld		a,(dxmap)		; dxmap
     633.  00:43CB                      		; ld		c,a
     634.  00:43CB                      		; and		128
     635.  00:43CB                      		; xor		b				; compare signs
     636.  00:43CB                      		; jp		z,nodirchange
     637.  00:43CB                      		; ld		(_dxchng),a		; a<>0
     638.  00:43CB                      		; bit		7,c
     639.  00:43CB                      		; jr		z,.right
     640.  00:43CB                      ; .left
     641.  00:43CB                      		; call	plot_line_lft1
     642.  00:43CB                      		; ld 		a,(_displaypage)
     643.  00:43CB                      		; xor		1
     644.  00:43CB                      		; ld 		d,a
     645.  00:43CB                      		; ld		e,0
     646.  00:43CB                      		; call	clrboder
     647.  00:43CB                      		; call	plot_line_lft2
     648.  00:43CB                      		; jp		newxmap
     649.  00:43CB                      
     650.  00:43CB                      ; .right
     651.  00:43CB                      		; call	plot_line_rgt1
     652.  00:43CB                      		; ld 		a,(_displaypage)
     653.  00:43CB                      		; xor		1
     654.  00:43CB                      		; ld 		d,a
     655.  00:43CB                      		; ld		e,240
     656.  00:43CB                      		; call	clrboder
     657.  00:43CB                      		; call	plot_line_rgt2
     658.  00:43CB                      		; jp		newxmap
     659.  00:43CB                      
     660.  00:43CB                      ; nodirchange:
     661.  00:43CB                      		; ld		a,(_dxchng)
     662.  00:43CB                      		; and		a
     663.  00:43CB                      		; jr		nz,1f
     664.  00:43CB                      		; bit		7,c
     665.  00:43CB                      		; jp		z,inc_xoffset
     666.  00:43CB                      		; jp		dec_xoffset
     667.  00:43CB                      	
     668.  00:43CB                      ; 1:		xor	a
     669.  00:43CB                      		; ld		(_dxchng),a
     670.  00:43CB                      		; bit		7,c
     671.  00:43CB                      		; jp		z,.right
     672.  00:43CB                      ; .left
     673.  00:43CB                      		; call	plot_line_lft1
     674.  00:43CB                      		; ld		e,240-16
     675.  00:43CB                      		; ld		d,240
     676.  00:43CB                      		; call	move_block
     677.  00:43CB                      		; call	plot_line_lft2
     678.  00:43CB                      		; jp		newxmap
     679.  00:43CB                      
     680.  00:43CB                      ; .right
     681.  00:43CB                      		; call	plot_line_rgt1
     682.  00:43CB                      		; ld		e,16
     683.  00:43CB                      		; ld		d,0
     684.  00:43CB                      		; call	move_block
     685.  00:43CB                      		; call	plot_line_rgt2
     686.  00:43CB                      		; jp		newxmap
     687.  00:43CB                      
     688.  00:43CB                      ; ;-------------------------------------
      40   00:43CB                      		include fsmscroll.asm
       1.  00:43CB                      
       2.  00:43CB                      
       3.  00:43CB                      xscroll:
       4.  00:43CB  3A 26 CA            		ld		a,(_xoffset)		; set R#18 
       5.  00:43CE                      
       6.  00:43CE  C6 F8               		add		a,-8
       7.  00:43D0  E6 0F               		and		0Fh
       8.  00:43D2  D3 99               		out		(099h),a
       9.  00:43D4  3E 92               		ld		a,18+128
      10.  00:43D6  D3 99               		out		(099h),a
      11.  00:43D8                      		
      12.  00:43D8  C9                  		ret
      13.  00:43D9                      
      14.  00:43D9                      pageswap:
      15.  00:43D9                      
      16.  00:43D9  3A 25 CA            		ld		a,(_displaypage)
      17.  00:43DC  A7                  		and		a
      18.  00:43DD  3E 1F               		ld		a,00011111B			; page 0
      19.  00:43DF  28 02               		jr		z,1f
      20.  00:43E1  3E 3F               		ld		a,00111111B			; page 1
      21.  00:43E3  D3 99               1:		out 	(0x99),a
      22.  00:43E5  3E 82               		ld 		a,2+128
      23.  00:43E7  D3 99               		out 	(0x99),a
      24.  00:43E9  C9                  		ret
      25.  00:43EA                      		
      26.  00:43EA                      		
      27.  00:43EA                      set_displaypage:
      28.  00:43EA  2A 1E CA            		ld		hl,(_xmappos)		; corner top left of the screen window in the map in pixels
      29.  00:43ED  3E 0F               		ld		a,15
      30.  00:43EF  A5                  		and		l
      31.  00:43F0  32 26 CA            		ld		(_xoffset),a		; screen offset
      32.  00:43F3                      
      33.  00:43F3  3A 25 CA            		ld		a,(_displaypage)
      34.  00:43F6  67                  		ld		h,a
      35.  00:43F7                      
      36.  00:43F7  3E 10               		ld		a,16
      37.  00:43F9  A5                  		and		l
      38.  00:43FA                      		
      39.  00:43FA  28 02               		jr		z,1f
      40.  00:43FC                      		
      41.  00:43FC  3E 01               		ld		a,1
      42.  00:43FE                      		
      43.  00:43FE  32 25 CA            1:		ld		(_displaypage),a
      44.  00:4401  AC                  		xor		h
      45.  00:4402  C8                  		ret		z	
      46.  00:4403  32 10 CA            		ld		(_sliceflag_reset),a 	; page has changed !
      47.  00:4406  C9                  		ret
      48.  00:4407                      
      49.  00:4407                      reset_sliceflag:
      50.  00:4407  3A 10 CA            		ld		a,(_sliceflag_reset)
      51.  00:440A  A7                  		and		a
      52.  00:440B  C8                  		ret		z	; _sliceflag_reset testing
      53.  00:440C                      
      54.  00:440C  D9                  		exx			; clear _sliceflag and _sliceflag_reset
      55.  00:440D  01 10 00            		ld	bc,16			
      56.  00:4410  21 00 CA            		ld	hl,_sliceflag
      57.  00:4413  11 01 CA            		ld	de,_sliceflag+1
      58.  00:4416  70                  		ld	(hl),b
      59.  00:4417  ED B0               		ldir
      60.  00:4419  D9                  		exx
      61.  00:441A  C9                  		ret
      62.  00:441B                      		
      63.  00:441B                      		
      64.  00:441B                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      65.  00:441B                      ; test code to move a marker
      66.  00:441B                      ;
      67.  00:441B                      ; returns
      68.  00:441B                      ; _xspeed change pressing right and left
      69.  00:441B                      
      70.  00:441B                      changespeed:		
      71.  00:441B  3A 1C CA            		ld	a,(keys0_7)
      72.  00:441E  6F                  		ld	l,a
      73.  00:441F                      		
      74.  00:441F  CB 55               		bit 2,l			; press 2 for right
      75.  00:4421  20 16               		jr	nz,.notright
      76.  00:4423                      
      77.  00:4423  2A 21 CA            		ld	hl,(_xspeed)
      78.  00:4426  7C                  		ld	a,h
      79.  00:4427  25                  		dec	h
      80.  00:4428  F0                  		ret	p		; if hl>1.0 exit
      81.  00:4429  23                  		inc	hl
      82.  00:442A  24                  		inc	h
      83.  00:442B  22 21 CA            		ld	(_xspeed),hl
      84.  00:442E  AC                  		xor	h
      85.  00:442F  E6 80               		and	128							;dir change neg to pos
      86.  00:4431  32 23 CA            		ld		(_dxchng),a 			; direction has changed !
      87.  00:4434  C8                  		ret	z		
      88.  00:4435  32 10 CA            		ld		(_sliceflag_reset),a 	; reset slice flags
      89.  00:4438  C9                  		ret
      90.  00:4439                      		
      91.  00:4439                      .notright:
      92.  00:4439  CB 4D               		bit 1,l			; press 1 for left
      93.  00:443B  C0                  		ret	nz
      94.  00:443C                      		
      95.  00:443C  2A 21 CA            		ld	hl,(_xspeed)
      96.  00:443F  7C                  		ld	a,h
      97.  00:4440  2B                  		dec	hl
      98.  00:4441  24                  		inc	h
      99.  00:4442  F8                  		ret	m		; if hl<-1.0 exit
     100.  00:4443  25                  		dec	h
     101.  00:4444  22 21 CA            		ld	(_xspeed),hl
     102.  00:4447  AC                  		xor	h
     103.  00:4448  E6 80               		and	128							;dir change neg to pos
     104.  00:444A  32 23 CA            		ld		(_dxchng),a 			; direction has changed !
     105.  00:444D  C8                  		ret	z
     106.  00:444E  32 10 CA            		ld		(_sliceflag_reset),a 	; reset slice flags
     107.  00:4451  C9                  		ret
     108.  00:4452                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     109.  00:4452                      				
     110.  00:4452                      changexpos:
     111.  00:4452  ED 5B 21 CA         		ld	de,(_xspeed)
     112.  00:4456  3A 20 CA            		ld	a,(_xmappos+2)
     113.  00:4459  83                  		add	a,e
     114.  00:445A  32 20 CA            		ld	(_xmappos+2),a
     115.  00:445D  5A                  		ld	e,d
     116.  00:445E  CB 7A               		bit	7,d
     117.  00:4460  16 00               		ld	d,0
     118.  00:4462  28 02               		jr	z,1f
     119.  00:4464  16 FF               		ld	d,-1
     120.  00:4466  2A 1E CA            1:		ld	hl,(_xmappos)
     121.  00:4469  ED 5A               		adc	hl,de
     122.  00:446B  7C                  		ld	a,h
     123.  00:446C  E6 0F               		and	15
     124.  00:446E  67                  		ld	h,a
     125.  00:446F  22 1E CA            		ld	(_xmappos),hl			; scroll one pixel right
     126.  00:4472  C9                  		ret
     127.  00:4473                      		
      41   00:4473                      		include vdpcmds.asm
       1.  00:4473                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
       2.  00:4473                      ; hl	-> 256 tile data (columnwise)
       3.  00:4473                      ; destination:
       4.  00:4473                      ; 	d,e = dy,dx
       5.  00:4473                      ;	b = page
       6.  00:4473                      ;
       7.  00:4473                      LMMC_tile:
       8.  00:4473  3E 24               		ld 		a, 36
       9.  00:4475  D3 99               		out 	(0x99),a
      10.  00:4477  3E 91               		ld 		a, 17+128
      11.  00:4479  D3 99               		out 	(0x99),a
      12.  00:447B                      
      13.  00:447B  0E 9B               		ld		c,0x9B
      14.  00:447D  ED 59               		out 	(c), e 			; dx
      15.  00:447F  AF                  		xor		a
      16.  00:4480  D3 9B               		out 	(0x9B), a		; dx (high)
      17.  00:4482                      
      18.  00:4482  ED 51               		out 	(c), d			; dy
      19.  00:4484                      								; destination page
      20.  00:4484  ED 41               		out 	(c), b			; dy (high-> page 0 or 1)
      21.  00:4486                      		
      22.  00:4486  06 10               		ld 		b,16
      23.  00:4488  ED 41               		out 	(c), b			; x block size
      24.  00:448A  D3 9B               		out 	(0x9B), a
      25.  00:448C                      
      26.  00:448C  ED 41               		out 	(c), b			; y block size
      27.  00:448E  D3 9B               		out 	(0x9B), a
      28.  00:4490                      
      29.  00:4490  ED A3               		outi					; 1st byte color
      30.  00:4492  D3 9B               		out 	(0x9B), a		; normal tracing
      31.  00:4494                      
      32.  00:4494  3E F0               		ld		a,0xF0			; HMMC
      33.  00:4496  D3 9B               		out 	(0x9B), a
      34.  00:4498                      
      35.  00:4498  3E AC               		ld 		a, 44 + 128
      36.  00:449A  D3 99               		out 	(0x99),a
      37.  00:449C  3E 91               		ld 		a, 17+128
      38.  00:449E  D3 99               		out 	(0x99),a
      39.  00:44A0                      		
      40.  00:44A0                      		
      41.  00:44A0  11 0F 00            		ld		de,15
      42.  00:44A3  43                  		ld		b,e					; 15 other bytes
      43.  00:44A4  3E 10               		ld		a,16
      44.  00:44A6                      		
      45.  00:44A6  19                  1:		add		hl,de
      46.  00:44A7  ED A3               		outi						; other byte color
      47.  00:44A9  C2 A6 44            		jp		nz,1b
      48.  00:44AC  25                  		dec	h
      49.  00:44AD  23                  		inc	hl
      50.  00:44AE  06 10               		ld		b,16
      51.  00:44B0  3D                  		dec		a
      52.  00:44B1  C2 A6 44            		jp		nz,1b
      53.  00:44B4                      	
      54.  00:44B4  C9                  		ret
      55.  00:44B5                      
      56.  00:44B5                      
      57.  00:44B5                      	
      58.  00:44B5                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      59.  00:44B5                      ; input
      60.  00:44B5                      ; a = tile number	from page 0
      61.  00:44B5                      ; 
      62.  00:44B5                      ; d = dx	
      63.  00:44B5                      ; e = dy	
      64.  00:44B5                      ; b = destination page 
      65.  00:44B5                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      66.  00:44B5                      
      67.  00:44B5                      ; destructible tiles have to be in range 0..n-1 in the tile set
      68.  00:44B5                      
      69.  00:44B5                      move_tile:
      70.  00:44B5  67                  		ld		h,a
      71.  00:44B6  E6 0F               		and		00001111B	
      72.  00:44B8  87 87 87 87         [4]		add		a,a					
      73.  00:44BC  6F                  		ld		l,a			; sx
      74.  00:44BD  7C                  		ld		a,h
      75.  00:44BE  E6 F0               		and		11110000B	; tiles are under the lower border						
      76.  00:44C0  C6 B0               		add		a,160+16
      77.  00:44C2  67                  		ld		h,a			; sy
      78.  00:44C3                      
      79.  00:44C3  3E 20               		ld 		a, 32
      80.  00:44C5  D3 99               		out 	(0x99),a
      81.  00:44C7  3E 91               		ld 		a, 17+128
      82.  00:44C9  D3 99               		out 	(0x99),a
      83.  00:44CB                      
      84.  00:44CB  0E 9B               		ld 		c, 0x9B
      85.  00:44CD                      		
      86.  00:44CD  CD 4D 42            		call _waitvdp				; do not change R#18 if the VDP is copying !! NEEDED FOR NTSC
      87.  00:44D0                      				
      88.  00:44D0  ED 69               		out		(c), l 				; sx
      89.  00:44D2  AF                  		xor 	a
      90.  00:44D3  D3 9B               		out		(0x9B), a 			; sx (high)
      91.  00:44D5                      		
      92.  00:44D5  ED 61               		out		(c), h 	     		; sy
      93.  00:44D7  3E 01               		ld		a,1					; source page
      94.  00:44D9  D3 9B               		out 	(0x9B), a 			; sy 	(high-> page 0 or 1)
      95.  00:44DB                      
      96.  00:44DB  ED 51               		out 	(c), d 				; dx
      97.  00:44DD  AF                  		xor 	a
      98.  00:44DE  D3 9B               		out 	(0x9B), a			; dx (high)
      99.  00:44E0                      		
     100.  00:44E0  ED 59               		out 	(c), e	 			; dy
     101.  00:44E2  ED 41               		out 	(c), b				; dy 	(high-> page 0 or 1)
     102.  00:44E4                      
     103.  00:44E4  2E 10               		ld 		l,16 				
     104.  00:44E6  ED 69               		out 	(c), l			; x block size
     105.  00:44E8  AF                  		xor 	a
     106.  00:44E9  D3 9B               		out 	(0x9B), a					
     107.  00:44EB  ED 69               		out 	(c), l			; y block size
     108.  00:44ED  D3 9B               		out 	(0x9B), a
     109.  00:44EF  D3 9B               		out 	(0x9B), a
     110.  00:44F1  D3 9B               		out 	(0x9B), a
     111.  00:44F3                      
     112.  00:44F3  3E D0               		ld		a,11010000B
     113.  00:44F5  D3 9B               		out 	(0x9B), a			; command HMMM
     114.  00:44F7  C9                  		ret
     115.  00:44F8                      
     116.  00:44F8                      
     117.  00:44F8                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     118.  00:44F8                      ; input
     119.  00:44F8                      ; b = sx	from  _displaypage
     120.  00:44F8                      ; d = dx	to not _displaypage
     121.  00:44F8                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     122.  00:44F8                      
     123.  00:44F8                      move_slice:
     124.  00:44F8  3E 20               		ld 		a, 32
     125.  00:44FA  D3 99               		out 	(0x99),a
     126.  00:44FC  3E 91               		ld 		a, 17+128
     127.  00:44FE  D3 99               		out 	(0x99),a
     128.  00:4500                      
     129.  00:4500  0E 9B               		ld 		c, 0x9B
     130.  00:4502                      		
     131.  00:4502                      		; call _waitvdp				; no need ATM
     132.  00:4502                      		
     133.  00:4502  ED 41               		out		(c), b 				; sx
     134.  00:4504  AF                  		xor a
     135.  00:4505  D3 9B               		out		(0x9B), a 			; sx (high)
     136.  00:4507                      		
     137.  00:4507  D3 9B               		out		(0x9B), a 			; sy
     138.  00:4509  3A 25 CA            		ld 		a,(_displaypage)	; source page
     139.  00:450C  D3 9B               		out 	(0x9B), a 			; sy 	(high-> page 0 or 1)
     140.  00:450E                      
     141.  00:450E  ED 51               		out 	(c), d 				; dx
     142.  00:4510  AF                  		xor a
     143.  00:4511  D3 9B               		out 	(0x9B), a			; dx (high)
     144.  00:4513                      		
     145.  00:4513  D3 9B               		out 	(0x9B), a 			; dy
     146.  00:4515  3A 25 CA            		ld 		a,(_displaypage)	; destination page
     147.  00:4518  EE 01               		xor	1				
     148.  00:451A  D3 9B               		out 	(0x9B), a			; dy 	(high-> page 0 or 1)
     149.  00:451C                      
     150.  00:451C  3E 10               		ld 		a,16 				; block size
     151.  00:451E  D3 9B               		out 	(0x9B), a
     152.  00:4520  AF                  		xor a
     153.  00:4521  D3 9B               		out 	(0x9B), a	
     154.  00:4523  3E A0               		ld		a,10*16				; mapHeight*16
     155.  00:4525  D3 9B               		out 	(0x9B), a			; y block size
     156.  00:4527  AF                  		xor		a
     157.  00:4528  D3 9B               		out 	(0x9B), a
     158.  00:452A  D3 9B               		out 	(0x9B), a
     159.  00:452C  D3 9B               		out 	(0x9B), a
     160.  00:452E                      
     161.  00:452E  3E D0               		ld		a,11010000B
     162.  00:4530  D3 9B               		out 	(0x9B), a			; command HMMM
     163.  00:4532  C9                  		ret
     164.  00:4533                      		
     165.  00:4533                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     166.  00:4533                      ; input
     167.  00:4533                      ; d = page
     168.  00:4533                      ; e = dx
     169.  00:4533                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     170.  00:4533                      		
     171.  00:4533                      clear_slice:
     172.  00:4533  3E 24               		ld 		a, 36
     173.  00:4535  D3 99               		out 	(0x99),a
     174.  00:4537  3E 91               		ld 		a, 17+128
     175.  00:4539  D3 99               		out 	(0x99),a
     176.  00:453B                      		
     177.  00:453B  0E 9B               		ld 		c, 0x9B
     178.  00:453D                      		
     179.  00:453D                      		; call _waitvdp
     180.  00:453D                      		
     181.  00:453D  ED 59               		out 	(c), e 			; dx
     182.  00:453F  AF                  		xor		a
     183.  00:4540  D3 9B               		out 	(0x9B), a		; dx (high)
     184.  00:4542                      		
     185.  00:4542  D3 9B               		out 	(0x9B), a		; dy
     186.  00:4544                      								; destination page
     187.  00:4544  ED 51               		out 	(c), d			; dy (high-> page 0 or 1)
     188.  00:4546                      		
     189.  00:4546  3E 10               		ld 		a,16
     190.  00:4548  D3 9B               		out 	(0x9B), a			; x block size
     191.  00:454A  AF                  		xor		a
     192.  00:454B  D3 9B               		out 	(0x9B), a
     193.  00:454D                      
     194.  00:454D  3E A0               		ld		a,10*16				; mapHeight*16
     195.  00:454F  D3 9B               		out 	(0x9B), a			; y block size
     196.  00:4551  AF                  		xor a
     197.  00:4552  D3 9B               		out 	(0x9B), a
     198.  00:4554                      
     199.  00:4554  D3 9B               		out 	(0x9B), a			; border_color
     200.  00:4556  D3 9B               		out 	(0x9B), a
     201.  00:4558                      
     202.  00:4558  3E C0               		ld		a,11000000B
     203.  00:455A  D3 9B               		out 	(0x9B), a			; command HMMV
     204.  00:455C  C9                  		ret
      42   00:455D                      		include brdrs_opt.asm
       1.  00:455D                      brdrs_left:
       2.  00:455D                      		bdrclr 11100000B
       2.  00:455D                    >   if debug
       2.  00:455D                    ~   ifdif n,0
       2.  00:455D                    ~    ld  a,n
       2.  00:455D                    ~   else
       2.  00:455D                    ~    xor a
       2.  00:455D                    ~   endif
       2.  00:455D                    ~   out  (0x99),a
       2.  00:455D                    ~   ld  a,7+128
       2.  00:455D                    ~   out  (0x99),a
       2.  00:455D                    ~   endif
       3.  00:455D  CD 7A 45            		call	vdp_task_left
       4.  00:4560                      		bdrclr 0
       4.  00:4560                    >   if debug
       4.  00:4560                    ~   ifdif n,0
       4.  00:4560                    ~    ld  a,n
       4.  00:4560                    ~   else
       4.  00:4560                    ~    xor a
       4.  00:4560                    ~   endif
       4.  00:4560                    ~   out  (0x99),a
       4.  00:4560                    ~   ld  a,7+128
       4.  00:4560                    ~   out  (0x99),a
       4.  00:4560                    ~   endif
       5.  00:4560  CD 03 46            		call	_brdrs_left
       6.  00:4563  3A 26 CA            		ld		a,(_xoffset)
       7.  00:4566  A7                  		and		a
       8.  00:4567  CC BA 46            		call	z,colmn_patch_left
       9.  00:456A                      		bdrclr 11100000B
       9.  00:456A                    >   if debug
       9.  00:456A                    ~   ifdif n,0
       9.  00:456A                    ~    ld  a,n
       9.  00:456A                    ~   else
       9.  00:456A                    ~    xor a
       9.  00:456A                    ~   endif
       9.  00:456A                    ~   out  (0x99),a
       9.  00:456A                    ~   ld  a,7+128
       9.  00:456A                    ~   out  (0x99),a
       9.  00:456A                    ~   endif
      10.  00:456A  C9                  		ret
      11.  00:456B                      
      12.  00:456B                      brdrs_right:
      13.  00:456B                      		bdrclr 11100000B
      13.  00:456B                    >   if debug
      13.  00:456B                    ~   ifdif n,0
      13.  00:456B                    ~    ld  a,n
      13.  00:456B                    ~   else
      13.  00:456B                    ~    xor a
      13.  00:456B                    ~   endif
      13.  00:456B                    ~   out  (0x99),a
      13.  00:456B                    ~   ld  a,7+128
      13.  00:456B                    ~   out  (0x99),a
      13.  00:456B                    ~   endif
      14.  00:456B  CD BF 45            		call	vdp_task_right
      15.  00:456E                      		bdrclr 0
      15.  00:456E                    >   if debug
      15.  00:456E                    ~   ifdif n,0
      15.  00:456E                    ~    ld  a,n
      15.  00:456E                    ~   else
      15.  00:456E                    ~    xor a
      15.  00:456E                    ~   endif
      15.  00:456E                    ~   out  (0x99),a
      15.  00:456E                    ~   ld  a,7+128
      15.  00:456E                    ~   out  (0x99),a
      15.  00:456E                    ~   endif
      16.  00:456E  CD 42 46            		call	_brdrs_right
      17.  00:4571  3A 26 CA            		ld		a,(_xoffset)
      18.  00:4574  FE 0F               		cp		15
      19.  00:4576  CC 81 46            		call	z,colmn_patch_right
      20.  00:4579                      		bdrclr 11100000B
      20.  00:4579                    >   if debug
      20.  00:4579                    ~   ifdif n,0
      20.  00:4579                    ~    ld  a,n
      20.  00:4579                    ~   else
      20.  00:4579                    ~    xor a
      20.  00:4579                    ~   endif
      20.  00:4579                    ~   out  (0x99),a
      20.  00:4579                    ~   ld  a,7+128
      20.  00:4579                    ~   out  (0x99),a
      20.  00:4579                    ~   endif
      21.  00:4579  C9                  		ret
      22.  00:457A                      		
      23.  00:457A                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;		
      24.  00:457A                      vdp_task_left:
      25.  00:457A  3A 23 CA            		ld		a,(_dxchng)
      26.  00:457D  A7                  		and		a
      27.  00:457E  20 2C               		jr		nz,.left_dxchng
      28.  00:4580  3A 24 CA            		ld		a,(_dxchng2)
      29.  00:4583  A7                  		and		a
      30.  00:4584  20 2F               		jr		nz,.left_dxchng2
      31.  00:4586                      
      32.  00:4586                      		;  _sliceflag management 
      33.  00:4586                      		; NOTE _sliceflag has to be byte aligned!!
      34.  00:4586                      		
      35.  00:4586  3A 26 CA            		ld		a,(_xoffset)
      36.  00:4589  5F                  		ld		e,a
      37.  00:458A  16 CA               		ld		d,high _sliceflag
      38.  00:458C  1A                  		ld		a,(de)
      39.  00:458D  A7                  		and		a
      40.  00:458E  C0                  		ret		nz		; avoid twice the same VDP command
      41.  00:458F  3D                  		dec		a
      42.  00:4590  12                  		ld		(de),a
      43.  00:4591                      
      44.  00:4591                      		
      45.  00:4591  7B                  		ld		a,e
      46.  00:4592  FE 0F               		cp		15
      47.  00:4594  20 0B               		jr		nz,.x0_14
      48.  00:4596                      .x15:		
      49.  00:4596  3A 25 CA            		ld		a,(_displaypage)
      50.  00:4599  EE 01               		xor		1
      51.  00:459B  57                  		ld		d,a
      52.  00:459C  1E 00               		ld		e,0
      53.  00:459E  C3 33 45            		jp 		clear_slice
      54.  00:45A1                      
      55.  00:45A1                      .x0_14:
      56.  00:45A1  87 87 87 87         [4]		add		a,a
      57.  00:45A5  47                  		ld		b,a			; source slice
      58.  00:45A6  C6 10               		add		a,16
      59.  00:45A8  57                  		ld		d,a			; destination slice
      60.  00:45A9  C3 F8 44            		jp		move_slice
      61.  00:45AC                      
      62.  00:45AC                      .left_dxchng:
      63.  00:45AC  CD 96 45            		call	vdp_task_left.x15
      64.  00:45AF  3E 01               		ld	a,1
      65.  00:45B1  32 24 CA            		ld	(_dxchng2),a
      66.  00:45B4  C9                  		ret
      67.  00:45B5                      .left_dxchng2:
      68.  00:45B5  3E 0E               		ld		a,14
      69.  00:45B7  CD A1 45            		call	vdp_task_left.x0_14
      70.  00:45BA  AF                  		xor		a
      71.  00:45BB  32 24 CA            		ld	(_dxchng2),a
      72.  00:45BE  C9                  		ret
      73.  00:45BF                      		
      74.  00:45BF                      vdp_task_right:
      75.  00:45BF  3A 23 CA            		ld		a,(_dxchng)
      76.  00:45C2  A7                  		and		a
      77.  00:45C3  20 2B               		jr		nz,.right_dxchng
      78.  00:45C5  3A 24 CA            		ld		a,(_dxchng2)
      79.  00:45C8  A7                  		and		a
      80.  00:45C9  20 2E               		jr		nz,.right_dxchng2
      81.  00:45CB                      		
      82.  00:45CB                      		;  _sliceflag management 
      83.  00:45CB                      		; NOTE _sliceflag has to be byte aligned!!
      84.  00:45CB                      		
      85.  00:45CB  3A 26 CA            		ld		a,(_xoffset)
      86.  00:45CE  5F                  		ld		e,a
      87.  00:45CF  16 CA               		ld		d,high _sliceflag
      88.  00:45D1  1A                  		ld		a,(de)
      89.  00:45D2  A7                  		and		a
      90.  00:45D3  C0                  		ret		nz		; avoid twice the same VDP command
      91.  00:45D4  3D                  		dec		a
      92.  00:45D5  12                  		ld		(de),a
      93.  00:45D6                      
      94.  00:45D6  7B                  		ld		a,e
      95.  00:45D7  A7                  		and		a
      96.  00:45D8  20 0B               		jr		nz,.x1_15
      97.  00:45DA                      .x0:		
      98.  00:45DA  3A 25 CA            		ld		a,(_displaypage)
      99.  00:45DD  EE 01               		xor		1
     100.  00:45DF  57                  		ld		d,a
     101.  00:45E0  1E F0               		ld		e,240
     102.  00:45E2  C3 33 45            		jp 		clear_slice
     103.  00:45E5                      
     104.  00:45E5                      .x1_15:
     105.  00:45E5  87 87 87 87         [4]		add		a,a
     106.  00:45E9  47                  		ld		b,a			; source slice
     107.  00:45EA  D6 10               		sub		a,16
     108.  00:45EC  57                  		ld		d,a			; destination slice
     109.  00:45ED  C3 F8 44            		jp		move_slice
     110.  00:45F0                      
     111.  00:45F0                      .right_dxchng:
     112.  00:45F0  CD DA 45            		call	vdp_task_right.x0
     113.  00:45F3  3E 01               		ld	a,1
     114.  00:45F5  32 24 CA            		ld	(_dxchng2),a
     115.  00:45F8  C9                  		ret
     116.  00:45F9                      .right_dxchng2:
     117.  00:45F9  3E 01               		ld		a,1
     118.  00:45FB  CD E5 45            		call	vdp_task_right.x1_15
     119.  00:45FE  AF                  		xor		a
     120.  00:45FF  32 24 CA            		ld	(_dxchng2),a
     121.  00:4602  C9                  		ret
     122.  00:4603                      
     123.  00:4603                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;		
     124.  00:4603                      	; hl -> tile column in the map
     125.  00:4603                      _brdrs_left:
     126.  00:4603  3A 26 CA            		ld		a,(_xoffset)
     127.  00:4606  5F                  		ld		e,a
     128.  00:4607  C6 F0               		add		a,240
     129.  00:4609  DD 6F               		ld		ixl,a
     130.  00:460B                      
     131.  00:460B  0E 98               		ld	c,0x98
     132.  00:460D                      				
     133.  00:460D  3A 25 CA            		ld	a,(_displaypage)
     134.  00:4610  87 87               [2] 	add a,a
     135.  00:4612  D3 99               		out (0x99),a 	; set bits 14-16
     136.  00:4614  3E 8E               		ld a,14+128
     137.  00:4616  D3 99               		out (0x99),a
     138.  00:4618                      
     139.  00:4618  16 40               		ld	d,0x40		; write access
     140.  00:461A  CD E8 46            		call plot_col64
     141.  00:461D                      
     142.  00:461D  3A 25 CA            		ld	a,(_displaypage)
     143.  00:4620  87 87               [2] 	add a,a
     144.  00:4622  F6 01               		or	1
     145.  00:4624  D3 99               		out (0x99),a 	; set bits 14-16
     146.  00:4626  3E 8E               		ld a,14+128
     147.  00:4628  D3 99               		out (0x99),a
     148.  00:462A                      
     149.  00:462A  16 40               		ld	d,0x40		; write access	
     150.  00:462C  CD E8 46            		call	plot_col64
     151.  00:462F                      		
     152.  00:462F  3A 25 CA            		ld	a,(_displaypage)
     153.  00:4632  87 87               [2] 	add a,a
     154.  00:4634  F6 02               		or	2
     155.  00:4636  D3 99               		out (0x99),a 	; set bits 14-16
     156.  00:4638  3E 8E               		ld a,14+128
     157.  00:463A  D3 99               		out (0x99),a
     158.  00:463C                      
     159.  00:463C  16 40               		ld	d,0x40		; write access	
     160.  00:463E  CD EB 46            		call	plot_col32
     161.  00:4641                      				
     162.  00:4641  C9                  		ret
     163.  00:4642                      
     164.  00:4642                      
     165.  00:4642                      	; hl -> tile column in the map
     166.  00:4642                      		
     167.  00:4642                      _brdrs_right:
     168.  00:4642  3A 26 CA            		ld		a,(_xoffset)
     169.  00:4645  DD 6F               		ld		ixl,a
     170.  00:4647  C6 F0               		add		a,240
     171.  00:4649  5F                  		ld		e,a
     172.  00:464A                      
     173.  00:464A  0E 98               		ld	c,0x98
     174.  00:464C                      				
     175.  00:464C  3A 25 CA            		ld	a,(_displaypage)
     176.  00:464F  87 87               [2] 	add a,a
     177.  00:4651  D3 99               		out (0x99),a 	; set bits 14-16
     178.  00:4653  3E 8E               		ld a,14+128
     179.  00:4655  D3 99               		out (0x99),a
     180.  00:4657                      
     181.  00:4657  16 40               		ld	d,0x40		; write access
     182.  00:4659  CD E8 46            		call plot_col64
     183.  00:465C                      
     184.  00:465C  3A 25 CA            		ld	a,(_displaypage)
     185.  00:465F  87 87               [2] 	add a,a
     186.  00:4661  F6 01               		or	1
     187.  00:4663  D3 99               		out (0x99),a 	; set bits 14-16
     188.  00:4665  3E 8E               		ld a,14+128
     189.  00:4667  D3 99               		out (0x99),a
     190.  00:4669                      
     191.  00:4669  16 40               		ld	d,0x40		; write access	
     192.  00:466B  CD E8 46            		call	plot_col64
     193.  00:466E                      		
     194.  00:466E  3A 25 CA            		ld	a,(_displaypage)
     195.  00:4671  87 87               [2] 	add a,a
     196.  00:4673  F6 02               		or	2
     197.  00:4675  D3 99               		out (0x99),a 	; set bits 14-16
     198.  00:4677  3E 8E               		ld a,14+128
     199.  00:4679  D3 99               		out (0x99),a
     200.  00:467B                      
     201.  00:467B  16 40               		ld	d,0x40		; write access	
     202.  00:467D  CD EB 46            		call	plot_col32
     203.  00:4680                      				
     204.  00:4680  C9                  		ret
     205.  00:4681                      
     206.  00:4681                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;		
     207.  00:4681                      	; small patch on last column
     208.  00:4681                      	
     209.  00:4681                      	; hl -> tile column in the map + mapHeight
     210.  00:4681                      	
     211.  00:4681                      colmn_patch_right:
     212.  00:4681  3E F6               		ld		a,-mapHeight		; return to the start of the column
     213.  00:4683  84                  		add		a,h
     214.  00:4684  67                  		ld 		h,a
     215.  00:4685                      		
     216.  00:4685                      		set_tile (hl)		; first tile in the column
     216.  00:4685  7E                >   ld a,reg
     216.  00:4686  07 07 07          > [3]  rlca
     216.  00:4689  E6 07             >   and 00000111B
     216.  00:468B  C6 04             >   add a,:_tiles0
     216.  00:468D  32 00 B0          >   ld (_kBank4),a
     216.  00:4690                    > 
     216.  00:4690  7E                >   ld a,reg
     216.  00:4691  E6 1F             >   and 00011111B
     216.  00:4693  C6 A0             >   add a,high _tiles0
     217.  00:4695                      
     218.  00:4695  67                  		ld		h,a
     219.  00:4696  2E F0               		ld		l,0xF0
     220.  00:4698                      		
     221.  00:4698  3A 25 CA            		ld		a,(_displaypage)
     222.  00:469B  EE 01               		xor		1				; hidden page
     223.  00:469D  87 87               [2] 	add 	a,a
     224.  00:469F  D3 99               		out 	(0x99),a 		; set bits 14-16
     225.  00:46A1  3E 8E               		ld 		a,14+128
     226.  00:46A3  D3 99               		out 	(0x99),a
     227.  00:46A5                      
     228.  00:46A5  11 EF 40            		ld		de,0x40EF		; write access, columns 239 on hidden page
     229.  00:46A8                      				
     230.  00:46A8                      		; hl -> tile column in the tile set
     231.  00:46A8                      set2pixs:	
     232.  00:46A8  7B                  		ld 		a,e 			;set bits 0-7
     233.  00:46A9  D3 99               		out 	(0x99),a
     234.  00:46AB  7A                  		ld 		a,d 			;set bits 8-13
     235.  00:46AC  D3 99               		out 	(0x99),a
     236.  00:46AE  ED A3               		outi	
     237.  00:46B0  14                  		inc 	d
     238.  00:46B1  7B                  		ld 		a,e 			;set bits 0-7
     239.  00:46B2  D3 99               		out 	(0x99),a
     240.  00:46B4  7A                  		ld 		a,d 			;set bits 8-13
     241.  00:46B5  D3 99               		out 	(0x99),a
     242.  00:46B7  ED A3               		outi	
     243.  00:46B9  C9                  		ret
     244.  00:46BA                      
     245.  00:46BA                      	; small patch on first column
     246.  00:46BA                      	
     247.  00:46BA                      	; hl -> tile column in the map + mapHeight
     248.  00:46BA                      
     249.  00:46BA                      colmn_patch_left:
     250.  00:46BA  3E F6               		ld		a,-mapHeight		; return to the start of the column
     251.  00:46BC  84                  		add		a,h
     252.  00:46BD  67                  		ld 		h,a
     253.  00:46BE                      		
     254.  00:46BE                      		set_tile (hl)		; first tile in the column
     254.  00:46BE  7E                >   ld a,reg
     254.  00:46BF  07 07 07          > [3]  rlca
     254.  00:46C2  E6 07             >   and 00000111B
     254.  00:46C4  C6 04             >   add a,:_tiles0
     254.  00:46C6  32 00 B0          >   ld (_kBank4),a
     254.  00:46C9                    > 
     254.  00:46C9  7E                >   ld a,reg
     254.  00:46CA  E6 1F             >   and 00011111B
     254.  00:46CC  C6 A0             >   add a,high _tiles0
     255.  00:46CE                      
     256.  00:46CE  67                  		ld		h,a
     257.  00:46CF  2E 00               		ld		l,0x00
     258.  00:46D1                      		
     259.  00:46D1  3A 25 CA            		ld		a,(_displaypage)
     260.  00:46D4  EE 01               		xor		1				; hidden page
     261.  00:46D6  87 87               [2] 	add 	a,a
     262.  00:46D8  D3 99               		out 	(0x99),a 		; set bits 14-16
     263.  00:46DA  3E 8E               		ld 		a,14+128
     264.  00:46DC  D3 99               		out 	(0x99),a
     265.  00:46DE                      
     266.  00:46DE  11 10 40            		ld		de,0x4010		; write access, columns 16 on hidden page
     267.  00:46E1                      
     268.  00:46E1                      		; hl -> tile column in the tile set
     269.  00:46E1  CD A8 46            		call	set2pixs
     270.  00:46E4  14                  		inc		d
     271.  00:46E5  C3 A8 46            		jp		set2pixs
     272.  00:46E8                      		
     273.  00:46E8                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     274.  00:46E8                      		
     275.  00:46E8                      plot_col64:
     276.  00:46E8                      	; hl -> tile in the map
     277.  00:46E8  CD EB 46            		call	plot_col32
     278.  00:46EB                      plot_col32:		
     279.  00:46EB  CD EE 46            		call	plot_col16
     280.  00:46EE                      plot_col16:
     281.  00:46EE  E5                  		push	hl
     282.  00:46EF  CD F5 46            		call	_plot_col16
     283.  00:46F2  E1                  		pop		hl
     284.  00:46F3  24                  		inc h			; next line in the map 	; inc l for maps stored column-wise
     285.  00:46F4  C9                  		ret
     286.  00:46F5                      
     287.  00:46F5                      
     288.  00:46F5                      _plot_col16:
     289.  00:46F5                      		set_tile (hl)
     289.  00:46F5  7E                >   ld a,reg
     289.  00:46F6  07 07 07          > [3]  rlca
     289.  00:46F9  E6 07             >   and 00000111B
     289.  00:46FB  C6 04             >   add a,:_tiles0
     289.  00:46FD  32 00 B0          >   ld (_kBank4),a
     289.  00:4700                    > 
     289.  00:4700  7E                >   ld a,reg
     289.  00:4701  E6 1F             >   and 00011111B
     289.  00:4703  C6 A0             >   add a,high _tiles0
     290.  00:4705                      
     291.  00:4705  67                  		ld	h,a
     292.  00:4706  3A 26 CA            		ld	a,(_xoffset)
     293.  00:4709  87 87 87 87         [4]		add	a,a
     294.  00:470D  6F                  		ld	l,a
     295.  00:470E                      
     296.  00:470E                      	; hl -> tile column in the tile set
     297.  00:470E                      	
     298.  00:470E                      		repeat 16
     299.  00:470E                    < 		ld a,e 			;set bits 0-7
     300.  00:470E                    < 		out (0x99),a
     301.  00:470E                    < 		ld a,d 			;set bits 8-13
     302.  00:470E                    < 		out (0x99),a
     303.  00:470E                    < 		outi			; 18
     304.  00:470E                    < 		ld	a,ixl 		;set bits 0-7
     305.  00:470E                    < 		out (0x99),a
     306.  00:470E                    < 		ld a,d 			;set bits 8-13
     307.  00:470E                    < 		out (0x99),a
     308.  00:470E                    < 		xor	a
     309.  00:470E                    < 		out	(0x98),a
     310.  00:470E                    < 		inc	d
     311.  00:470E                    < 		endrepeat
     311.  00:470E  7B D3 99 7A D3 99 ED A3 DD 7D D3 99 7A D3 99 AF 
     311.  00:471E  D3 98 14 7B D3 99 7A D3 99 ED A3 DD 7D D3 99 7A 
     311.  00:472E  D3 99 AF D3 98 14 7B D3 99 7A D3 99 ED A3 DD 7D 
     311.  00:473E  D3 99 7A D3 99 AF D3 98 14 7B D3 99 7A D3 99 ED 
     311.  00:474E  A3 DD 7D D3 99 7A D3 99 AF D3 98 14 7B D3 99 7A 
     311.  00:475E  D3 99 ED A3 DD 7D D3 99 7A D3 99 AF D3 98 14 7B 
     311.  00:476E  D3 99 7A D3 99 ED A3 DD 7D D3 99 7A D3 99 AF D3 
     311.  00:477E  98 14 7B D3 99 7A D3 99 ED A3 DD 7D D3 99 7A D3 
     311.  00:478E  99 AF D3 98 14 7B D3 99 7A D3 99 ED A3 DD 7D D3 
     311.  00:479E  99 7A D3 99 AF D3 98 14 7B D3 99 7A D3 99 ED A3 
     311.  00:47AE  DD 7D D3 99 7A D3 99 AF D3 98 14 7B D3 99 7A D3 
     311.  00:47BE  99 ED A3 DD 7D D3 99 7A D3 99 AF D3 98 14 7B D3 
     311.  00:47CE  99 7A D3 99 ED A3 DD 7D D3 99 7A D3 99 AF D3 98 
     311.  00:47DE  14 7B D3 99 7A D3 99 ED A3 DD 7D D3 99 7A D3 99 
     311.  00:47EE  AF D3 98 14 7B D3 99 7A D3 99 ED A3 DD 7D D3 99 
     311.  00:47FE  7A D3 99 AF D3 98 14 7B D3 99 7A D3 99 ED A3 DD 
     311.  00:480E  7D D3 99 7A D3 99 AF D3 98 14 7B D3 99 7A D3 99 
     311.  00:481E  ED A3 DD 7D D3 99 7A D3 99 AF D3 98 14 7B D3 99 
     311.  00:482E  7A D3 99 ED A3 DD 7D D3 99 7A D3 99 AF D3 98 14 
     312.  00:483E  C9                  		ret
     313.  00:483F                      		
      43   00:483F                      		include anim_opt.asm
       1.  00:483F                      		
       2.  00:483F                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
       3.  00:483F                      ; test code to move a marker
       4.  00:483F                      ;
       5.  00:483F                      ; returns
       6.  00:483F                      ; d = dx	
       7.  00:483F                      ; e = dy	
       8.  00:483F                      
       9.  00:483F                      movemarker:		
      10.  00:483F  3A 1B CA            		ld	a,(joystick)
      11.  00:4842  6F                  		ld	l,a
      12.  00:4843                      
      13.  00:4843  CB 7D               		bit 7,l
      14.  00:4845  20 0E               		jr	nz,notright
      15.  00:4847  3A 14 CA            		ld	a,(_xtest)
      16.  00:484A  C6 10               		add	a,16
      17.  00:484C  FE F0               		cp	240
      18.  00:484E  28 13               		jr	z,1f
      19.  00:4850  32 14 CA            		ld	(_xtest),a
      20.  00:4853  18 0E               		jr	1f
      21.  00:4855                      notright:
      22.  00:4855  CB 65               		bit 4,l
      23.  00:4857  20 0A               		jr	nz,1f
      24.  00:4859  3A 14 CA            		ld	a,(_xtest)
      25.  00:485C  D6 10               		sub	a,16
      26.  00:485E  28 03               		jr	z,1f
      27.  00:4860  32 14 CA            		ld	(_xtest),a
      28.  00:4863                      1:		
      29.  00:4863  3A 14 CA            		ld	a,(_xtest)
      30.  00:4866  57                  		ld	d,a
      31.  00:4867                      
      32.  00:4867  CB 6D               		bit 5,l
      33.  00:4869  20 0D               		jr	nz,notup
      34.  00:486B  3A 15 CA            		ld	a,(_ytest)
      35.  00:486E  D6 10               		sub	a,16
      36.  00:4870  DA 88 48            		jp	c,1f
      37.  00:4873  32 15 CA            		ld	(_ytest),a
      38.  00:4876  18 10               		jr	1f
      39.  00:4878                      notup:
      40.  00:4878  CB 75               		bit 6,l
      41.  00:487A  20 0C               		jr	nz,1f
      42.  00:487C  3A 15 CA            		ld	a,(_ytest)
      43.  00:487F  C6 10               		add	a,16
      44.  00:4881  FE A0               		cp	10*16
      45.  00:4883  28 03               		jr	z,1f
      46.  00:4885  32 15 CA            		ld	(_ytest),a
      47.  00:4888                      1:
      48.  00:4888  3A 15 CA            		ld	a,(_ytest)
      49.  00:488B  5F                  		ld	e,a
      50.  00:488C  C9                  		ret
      51.  00:488D                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
      52.  00:488D                      	
      53.  00:488D                      animtest:
      54.  00:488D  3A 16 CA            		ld	a,(anim_buffer.flag)
      55.  00:4890  A7                  		and	a
      56.  00:4891  20 7A               		jr	nz,.manage_buffer
      57.  00:4893                      
      58.  00:4893  3A 26 CA            		ld		a,(_xoffset)		
      59.  00:4896  87 87 87 87         [4]		add		a,a					
      60.  00:489A  67                  		ld		h,a
      61.  00:489B                      		
      62.  00:489B                      		
      63.  00:489B  3A 22 CA            		ld		a,(_xspeed+1)
      64.  00:489E  CB 07               		rlc a
      65.  00:48A0  DA C4 48            		jp	c,.scroll_left
      66.  00:48A3                      		
      67.  00:48A3                      .scroll_right:			
      68.  00:48A3  3A 26 CA            		ld		a,(_xoffset)	
      69.  00:48A6  FE 0F               		cp		15
      70.  00:48A8  20 06               		jr		nz,.noexceptionr
      71.  00:48AA  CD 23 49            		call	test_change_page		; if xoffset=15 test for page swap
      72.  00:48AD  C2 FB 48            		jp		nz,.intercept_right		; if page swap intercetp
      73.  00:48B0                      .noexceptionr
      74.  00:48B0  CD 3F 48            		call 	movemarker
      75.  00:48B3  7B                  		ld		a,e
      76.  00:48B4  32 17 CA            		ld		(anim_buffer.dy),a
      77.  00:48B7                      
      78.  00:48B7  7C                  		ld		a,h
      79.  00:48B8  BA                  		cp		d
      80.  00:48B9  DA 33 49            		jp 		c,single_move
      81.  00:48BC                      		
      82.  00:48BC  7A                  		ld		a,d
      83.  00:48BD  D6 10               		sub		a,16
      84.  00:48BF  32 18 CA            		ld		(anim_buffer.dx),a
      85.  00:48C2  18 1E               		jr		1f
      86.  00:48C4                      		
      87.  00:48C4                      .scroll_left:
      88.  00:48C4  3A 26 CA            		ld		a,(_xoffset)	
      89.  00:48C7  A7                  		and		a
      90.  00:48C8  20 06               		jr		nz,.noexceptionl
      91.  00:48CA  CD 23 49            		call	test_change_page		; if xoffset=0 test for page swap		
      92.  00:48CD  C2 0C 49            		jp		nz,.intercept_left		; if page swap intercetp
      93.  00:48D0                      .noexceptionl
      94.  00:48D0  CD 3F 48            		call 	movemarker
      95.  00:48D3  7B                  		ld		a,e
      96.  00:48D4  32 17 CA            		ld		(anim_buffer.dy),a
      97.  00:48D7                      
      98.  00:48D7  7A                  		ld		a,d
      99.  00:48D8  BC                  		cp		h
     100.  00:48D9  DA 33 49            		jp 		c,single_move
     101.  00:48DC                      
     102.  00:48DC  7A                  		ld		a,d
     103.  00:48DD  C6 10               		add		a,16
     104.  00:48DF  32 18 CA            		ld		(anim_buffer.dx),a
     105.  00:48E2                      1:		
     106.  00:48E2  3A 25 CA            		ld 		a,(_displaypage)	; destination page	
     107.  00:48E5  47                  		ld		b,a		
     108.  00:48E6  EE 01               		xor		1
     109.  00:48E8  32 1A CA            		ld		(anim_buffer.page),a
     110.  00:48EB                      		
     111.  00:48EB  3E 0F               		ld		a,15	
     112.  00:48ED  32 16 CA            		ld		(anim_buffer.flag),a
     113.  00:48F0                      
     114.  00:48F0  3A 26 CA            		ld		a,(_xoffset)
     115.  00:48F3  E6 0F               		and		15
     116.  00:48F5  32 19 CA            		ld		(anim_buffer.tile),a
     117.  00:48F8                      		
     118.  00:48F8  C3 B5 44            		jp 		move_tile
     119.  00:48FB                      .intercept_right:
     120.  00:48FB  CD 3F 48            		call 	movemarker
     121.  00:48FE                      
     122.  00:48FE  3A 25 CA            		ld 		a,(_displaypage)	; destination page	
     123.  00:4901  EE 01               		xor		1
     124.  00:4903  47                  		ld		b,a		
     125.  00:4904  3A 26 CA            		ld		a,(_xoffset)
     126.  00:4907  E6 0F               		and 15
     127.  00:4909  C3 B5 44            		jp 		move_tile
     128.  00:490C                      
     129.  00:490C                      .intercept_left:
     130.  00:490C                      		
     131.  00:490C                      		
     132.  00:490C  C9                  		ret
     133.  00:490D                      	
     134.  00:490D                      .manage_buffer:
     135.  00:490D  AF                  		xor	a
     136.  00:490E  32 16 CA            		ld	(anim_buffer.flag),a
     137.  00:4911                      		
     138.  00:4911  3A 17 CA            		ld	a,(anim_buffer.dy)
     139.  00:4914  5F                  		ld	e,a
     140.  00:4915                      		
     141.  00:4915  3A 18 CA            		ld	a,(anim_buffer.dx)
     142.  00:4918  57                  		ld	d,a
     143.  00:4919                      		
     144.  00:4919  3A 1A CA            		ld	a,(anim_buffer.page)
     145.  00:491C  47                  		ld	b,a
     146.  00:491D                      		
     147.  00:491D  3A 19 CA            		ld	a,(anim_buffer.tile)
     148.  00:4920  C3 B5 44            		jp 	move_tile
     149.  00:4923                      	
     150.  00:4923                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     151.  00:4923                      		
     152.  00:4923                      
     153.  00:4923                      test_change_page:
     154.  00:4923  2A 1E CA            		ld		hl,(_xmappos)		; corner top left of the screen window in the map in pixels
     155.  00:4926  3A 25 CA            		ld		a,(_displaypage)
     156.  00:4929  67                  		ld		h,a
     157.  00:492A  3E 10               		ld		a,16
     158.  00:492C  A5                  		and		l
     159.  00:492D  28 02               		jr		z,1f
     160.  00:492F  3E 01               		ld		a,1
     161.  00:4931  AC                  1:		xor		h
     162.  00:4932  C9                  		ret						;	Z if there is no page change
     163.  00:4933                      								;	NZ if page changed
     164.  00:4933                      
     165.  00:4933                      
     166.  00:4933                      ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     167.  00:4933                      single_move:
     168.  00:4933  3A 25 CA            		ld 		a,(_displaypage)	; destination page	
     169.  00:4936  47                  		ld		b,a		
     170.  00:4937  3A 26 CA            		ld		a,(_xoffset)
     171.  00:493A  E6 0F               		and		15		
     172.  00:493C  C3 B5 44            		jp 		move_tile
     173.  00:493F                      		
      44   00:493F                      		
      45   00:493F                      		include checkkbd.asm
       1.  00:493F                      
       2.  00:493F                      ; // Line Bit_7 Bit_6 Bit_5 Bit_4 Bit_3 Bit_2 Bit_1 Bit_0
       3.  00:493F                      ; // 0 	   "7"  "6"   "5"   "4"   "3"   "2"   "1"   "0"
       4.  00:493F                      ; // 1 	   ";"  "]"   "["   "\"   "="   "-"   "9"   "8"
       5.  00:493F                      ; // 2 	   "B"  "A"   ???   "/"   "."   ","   "'"   "`"
       6.  00:493F                      ; // 3 	   "J"  "I"   "H"   "G"   "F"   "E"   "D"   "C"
       7.  00:493F                      ; // 4 	   "R"  "Q"   "P"   "O"   "N"   "M"   "L"   "K"
       8.  00:493F                      ; // 5 	   "Z"  "Y"   "X"   "W"   "V"   "U"   "T"   "S"
       9.  00:493F                      ; // 6 	   F3 	 F2    F1  CODE   CAP  GRAPH  CTRL SHIFT
      10.  00:493F                      ; // 7 	   RET  SEL    BS  STOP   TAB   ESC    F5    F4
      11.  00:493F                      ; // 8 	   RIGHT DOWN  UP  LEFT   DEL   INS   HOME SPACE
      12.  00:493F                      
      13.  00:493F                      checkkbd:
      14.  00:493F                      		; di
      15.  00:493F  DB AA               		in	a,(0aah)
      16.  00:4941  E6 F0               		and 011110000B			; upper 4 bits contain info to preserve
      17.  00:4943  B3                  		or	e
      18.  00:4944  D3 AA               		out (0aah),a
      19.  00:4946  DB A9               		in	a,(0a9h)
      20.  00:4948  6F                  		ld	l,a
      21.  00:4949                      		; ei
      22.  00:4949  C9                  		ret
      46   00:494A                      		
      47   00:494A                      ;-------------------------------------
      48   00:494A                      ; Entry point
      49   00:494A                      ;-------------------------------------
      50   00:494A                      START:
      51   00:494A  AF                  		xor	a
      52   00:494B  3C                  		inc	a
      53   00:494C  32 13 CA            		ld	(SEL_NTSC),a		; NTSC MODE
      54   00:494F  CD 0A 42            		call	set_scr			; set video mode to screen 8
      55   00:4952  F3                  		di
      56   00:4953                      		
      57   00:4953                      ;-------------------------------------
      58   00:4953                      ;   Power-up routine for 32K ROM
      59   00:4953                      ;   set pages and sub slot
      60   00:4953                      ;-------------------------------------
      61   00:4953  CD 10 40                    call    search_slot
      62   00:4956  CD 2F 40                    call    search_slotram	
      63   00:4959  CD 61 40            		call	setrompage2		; ROM in page 1 & 2
      64   00:495C  CD 5B 40            		call	setrampage0		; RAM in page 0 & 3
      65   00:495F                      
      66   00:495F                      
      67   00:495F                      		; activate  the fist 24K of rom
      68   00:495F  AF                  		xor	a			   
      69   00:4960  32 00 50            		ld	(_kBank1),a
      70   00:4963  3C                  		inc	a
      71   00:4964  32 00 70            		ld	(_kBank2),a
      72   00:4967  3C                  		inc	a
      73   00:4968  32 00 90            		ld	(_kBank3),a
      74   00:496B                      		
      75   00:496B  CD 78 41            		call	_cls
      76   00:496E                      		
      77   00:496E                      		;--- initialise ISR in RAM
      78   00:496E                      		
      79   00:496E  F3                  		di
      80   00:496F                      	
      81   00:496F  CD 5C 42            		call	isr_set
      82   00:4972                      		
      83   00:4972                      		; copy the level map from ROM to RAM
      84   00:4972                      		
      85   00:4972  CD 3A 4A            		call	vdptest
      86   00:4975  CD A5 41            		call	font_cpy
      87   00:4978  CD C6 49            		call	mapinit
      88   00:497B                      		
      89   00:497B                      		
      90   00:497B  21 00 00            		ld	hl,0
      91   00:497E  22 9E FC            		ld	(_jiffy),hl		
      92   00:4981  3E 20               		ld	a,32
      93   00:4983  32 14 CA            		ld	(_xtest),a
      94   00:4986  AF                  		xor	a
      95   00:4987  32 15 CA            		ld	(_ytest),a
      96   00:498A  32 25 CA            		ld	(_displaypage),a		
      97   00:498D  32 16 CA            		ld	(anim_buffer.flag),a
      98   00:4990  32 23 CA            		ld	(_dxchng),a
      99   00:4993  32 24 CA            		ld	(_dxchng2),a
     100   00:4996  3D                  		dec	a
     101   00:4997  32 10 CA            		ld	(_sliceflag_reset),a
     102   00:499A  CD 07 44            		call	reset_sliceflag
     103   00:499D                      		
     104   00:499D  FB                  		ei
     105   00:499E  76                  1:		halt
     106   00:499F  76                  		halt
     107   00:49A0                      		
     108   00:49A0  3A 9E FC            		ld	a,(_jiffy)		
     109   00:49A3  E6 1F               		and	31
     110   00:49A5  C2 9E 49            		jp	nz,1b
     111   00:49A8                      		
     112   00:49A8  1E 08               		ld	e,8
     113   00:49AA  CD 3F 49            		call	checkkbd
     114   00:49AD  E6 01               		and	1				; space
     115   00:49AF  CC B5 49            		call	z,PAL_ntsc
     116   00:49B2  C3 9E 49            		jp	1b
     117   00:49B5                      		
     118   00:49B5                      PAL_ntsc:
     119   00:49B5  F3                  		di
     120   00:49B6  3A E8 FF            		ld		a,(RG9SAV)		
     121   00:49B9  EE 02               		xor		00000010B		; PAL or NTSC 
     122   00:49BB  32 E8 FF            		ld		(RG9SAV),a
     123   00:49BE  D3 99               		out		(0x99),a
     124   00:49C0  3E 89               		ld		a,9+128
     125   00:49C2  D3 99               		out		(0x99),a
     126   00:49C4  FB                  		ei
     127   00:49C5  C9                  		ret
     128   00:49C6                      
     129   00:49C6                      mapinit:		
     130   00:49C6  3E 0C               		ld		a, :_level
     131   00:49C8  32 00 B0            		ld		(_kBank4),a
     132   00:49CB  21 00 A0            		ld		hl,_level
     133   00:49CE  11 00 C0            		ld		de,_levelmap
     134   00:49D1  01 00 0A            		ld		bc,mapWidth*mapHeight
     135   00:49D4  ED B0               		ldir
     136   00:49D6                      		
     137   00:49D6  AF                  		xor		a
     138   00:49D7  32 1D CA            		ld		(_ymappos),a
     139   00:49DA  32 20 CA            		ld		(_xmappos+2),a	; 24 bit	
     140   00:49DD  21 00 01            		ld		hl,256
     141   00:49E0  22 21 CA            		ld		(_xspeed),hl
     142   00:49E3  21 00 03            		ld		hl,768
     143   00:49E6  22 1E CA            		ld		(_xmappos),hl
     144   00:49E9                      		; ret
     145   00:49E9                      
     146   00:49E9                      buildmap:
     147   00:49E9  2A 1E CA            		ld	hl,(_xmappos)
     148   00:49EC                      
     149   00:49EC                      		repeat 4
     150   00:49EC                    < 		srl	h
     151   00:49EC                    < 		rr	l
     152   00:49EC                    < 		endrepeat					; corner top left of the screen window in the map in tiles
     152   00:49EC  CB 3C CB 1D CB 3C CB 1D CB 3C CB 1D CB 3C CB 1D 
     153   00:49FC                      		
     154   00:49FC  11 00 C0            		ld	de,_levelmap
     155   00:49FF  19                  		add	hl,de					; HL = corner top right of the screen window in the map in tiles
     156   00:4A00                      		
     157   00:4A00  11 00 00            		ld	de,0			; dest y,x
     158   00:4A03  06 96               		ld	b,15*10
     159   00:4A05                      1:		
     160   00:4A05                      		set_tile (hl)
     160   00:4A05  7E                >   ld a,reg
     160   00:4A06  07 07 07          > [3]  rlca
     160   00:4A09  E6 07             >   and 00000111B
     160   00:4A0B  C6 04             >   add a,:_tiles0
     160   00:4A0D  32 00 B0          >   ld (_kBank4),a
     160   00:4A10                    > 
     160   00:4A10  7E                >   ld a,reg
     160   00:4A11  E6 1F             >   and 00011111B
     160   00:4A13  C6 A0             >   add a,high _tiles0
     161   00:4A15  E5                  		push	hl
     162   00:4A16                      
     163   00:4A16  67                  		ld	h,a				; select offset in the bank
     164   00:4A17  2E 00               		ld	l,0
     165   00:4A19                      		
     166   00:4A19  D5                  		push	de
     167   00:4A1A  C5                  		push	bc
     168   00:4A1B  06 00               		ld		b,0				; page
     169   00:4A1D  CD 73 44            		call	LMMC_tile
     170   00:4A20  C1                  		pop		bc
     171   00:4A21  D1                  		pop		de
     172   00:4A22                      		
     173   00:4A22  E1                  		pop		hl
     174   00:4A23                      
     175   00:4A23  23                  		inc	hl
     176   00:4A24                      
     177   00:4A24  3E 10               		ld		a,16		; x=x+16
     178   00:4A26  83                  		add		a,e
     179   00:4A27  5F                  		ld		e,a
     180   00:4A28                      		
     181   00:4A28  FE F0               		cp		15*16
     182   00:4A2A  38 0B               		jr		c,2f
     183   00:4A2C                      
     184   00:4A2C  1E 00               		ld		e,0			; x = 0
     185   00:4A2E                      		
     186   00:4A2E  3E 10               		ld		a,16		; y=y+16
     187   00:4A30  82                  		add		a,d
     188   00:4A31  57                  		ld		d,a
     189   00:4A32                      
     190   00:4A32  3E F1               		ld		a,-15
     191   00:4A34  85                  		add		a,l
     192   00:4A35  6F                  		ld		l,a
     193   00:4A36  24                  		inc		h
     194   00:4A37                      		
     195   00:4A37  10 CC               2:		djnz	1b
     196   00:4A39  C9                  		ret
     197   00:4A3A                      		
     198   00:4A3A                      vdptest:
     199   00:4A3A  16 A0               		ld	d,160			; dest y
     200   00:4A3C  1E 00               		ld	e,0				; dest x
     201   00:4A3E  0E A0               		ld	c,160			; initial tile
     202   00:4A40  06 20               		ld	b,32			; number of tiles
     203   00:4A42                      1:		
     204   00:4A42                      		set_tile c
     204   00:4A42  79                >   ld a,reg
     204   00:4A43  07 07 07          > [3]  rlca
     204   00:4A46  E6 07             >   and 00000111B
     204   00:4A48  C6 04             >   add a,:_tiles0
     204   00:4A4A  32 00 B0          >   ld (_kBank4),a
     204   00:4A4D                    > 
     204   00:4A4D  79                >   ld a,reg
     204   00:4A4E  E6 1F             >   and 00011111B
     204   00:4A50  C6 A0             >   add a,high _tiles0
     205   00:4A52                      
     206   00:4A52  67                  		ld	h,a				; select offset in the bank
     207   00:4A53  2E 00               		ld	l,0
     208   00:4A55                      
     209   00:4A55  D5                  		push	de
     210   00:4A56  C5                  		push	bc
     211   00:4A57  06 01               		ld		b,1				; page
     212   00:4A59  CD 73 44            		call	LMMC_tile
     213   00:4A5C  C1                  		pop		bc
     214   00:4A5D  D1                  		pop		de
     215   00:4A5E                      		
     216   00:4A5E  0C                  		inc		c
     217   00:4A5F                      		
     218   00:4A5F  3E 10               		ld		a,16		; x=x+16
     219   00:4A61  83                  		add		a,e
     220   00:4A62  5F                  		ld		e,a
     221   00:4A63  30 04               		jr		nc,2f
     222   00:4A65                      
     223   00:4A65  3E 10               		ld		a,16		; y=y+16
     224   00:4A67  82                  		add		a,d
     225   00:4A68  57                  		ld		d,a
     226   00:4A69                      		
     227   00:4A69  10 D7               2:		djnz	1b
     228   00:4A6B  C9                  		ret
     229   00:4A6C                      		
     230   00:4A6C                      		
     231   00:4A6C  (04)                		page 4
     232   04:A000                      _tiles0:
     233   04:A000  (2000)              		incbin "tiles.bin",0x0000,0x2000
     234   04:C000  (05)                		page 5
     235   05:A000  (2000)              		incbin "tiles.bin",0x2000,0x2000
     236   05:C000  (06)                		page 6
     237   06:A000  (2000)              		incbin "tiles.bin",0x4000,0x2000
     238   06:C000  (07)                		page 7
     239   07:A000  (2000)              		incbin "tiles.bin",0x6000,0x2000
     240   07:C000  (08)                		page 8
     241   08:A000  (2000)              		incbin "tiles.bin",0x8000,0x2000
     242   08:C000  (09)                		page 9
     243   09:A000  (2000)              		incbin "tiles.bin",0xA000,0x2000
     244   09:C000  (0A)                		page 10
     245   0A:A000  (2000)              		incbin "tiles.bin",0xC000,0x2000
     246   0A:C000  (0B)                		page 11
     247   0B:A000  (2000)              		incbin "tiles.bin",0xE000,0x2000
     248   0B:C000                      
     249   0B:C000  (0C)                		page 12		
     250   0C:A000                      _level:
     251   0C:A000  (0A00)              		incbin	datamap.bin	
     252   0C:AA00                      		
     253   0C:AA00  (0D)                		page 13		
     254   0D:A000                      fonts:
     255   0D:A000  (2000)              		incbin	fonts.bin,0x0000,0x2000
     256   0D:C000  (0E)                		page 14
     257   0E:A000  (2000)              		incbin 	fonts.bin,0x2000,0x2000
     258   0E:C000  (0F)                		page 15
     259   0F:A000  (2000)              		incbin 	fonts.bin,0x4000,0x2000
     260   0F:C000                      		
     261   0F:C000                      		; call	opening
     262   0F:C000                      		
     263   0F:C000                      
     264   0F:C000                      		; call 	_hw_sprite_init
     265   0F:C000                      
     266   0F:C000                      		; ld		c,0
     267   0F:C000                      		; ld		de,256*(mapHeight*16+3)
     268   0F:C000                      		; call	_vdpsetvramwr
     269   0F:C000                      
     270   0F:C000                      		; ld		de, 256*:_scorebar+1
     271   0F:C000                      		; call	outvram
     272   0F:C000                      		
     273   0F:C000                      		; ld		c,1
     274   0F:C000                      		; ld		de,256*mapHeight*16
     275   0F:C000                      		; call	_vdpsetvramwr
     276   0F:C000                      
     277   0F:C000                      		; ld		de, 256*:_animated+2
     278   0F:C000                      		; call	outvram
     279   0F:C000                      
     280   0F:C000                      	
     281   0F:C000                      		; ; ld	a,:demo_song
     282   0F:C000                      		; ; setpage_a
     283   0F:C000                      		
     284   0F:C000                      		; ; ld	bc,	end_demo_song-musbuff
     285   0F:C000                      		; ; ld	hl,	demo_song
     286   0F:C000                      		; ; ld	de,	musbuff
     287   0F:C000                      		; ; ldir
     288   0F:C000                      			
     289   0F:C000                      		; ; call	replay_init
     290   0F:C000                      		; ; ld		hl,musbuff
     291   0F:C000                      		; ; call	replay_loadsong
     292   0F:C000                      
     293   0F:C000                      
     294   0F:C000                      		; ld		e,0
     295   0F:C000                      		; call	_setpage
     296   0F:C000                      				
     297   0F:C000                      		; ld	a, :_level
     298   0F:C000                      		; ld	(_kBank4),a
     299   0F:C000                      		
     300   0F:C000                      		; ld		hl,_level
     301   0F:C000                      		; ld		de,_levelmap
     302   0F:C000                      		; ld		bc,mapWidth*mapHeight
     303   0F:C000                      		; ldir
     304   0F:C000                      
     305   0F:C000                      
     306   0F:C000                      		; ; call	init_page0
     307   0F:C000                      
     308   0F:C000                      		; ld		a,0
     309   0F:C000                      		; ld		(cur_level),a
     310   0F:C000                      
     311   0F:C000                      		; ei
     312   0F:C000                      
     313   0F:C000                      ; restart:
     314   0F:C000                      		; call	_intreset
     315   0F:C000                      
     316   0F:C000                      		
     317   0F:C000                      
     318   0F:C000                      		; ld		a,1
     319   0F:C000                      		; ld		(_displaypage),a		
     320   0F:C000                      		; call 	_cls0
     321   0F:C000                      		; ld		hl,_levelmap
     322   0F:C000                      		; ld		(_levelmap_pos),hl
     323   0F:C000                      		
     324   0F:C000                      		; xor		a
     325   0F:C000                      		; ld		h,a
     326   0F:C000                      		; ld		l,a
     327   0F:C000                      		; ld		(flip_flop),a
     328   0F:C000                      		; ld		(god_mode),a
     329   0F:C000                      		; ld		(_ymappos),a
     330   0F:C000                      		; ld		(_xmappos),hl
     331   0F:C000                      		
     332   0F:C000                      		; ld		(_nframes),hl
     333   0F:C000                      		; ld		(_mcdx),hl
     334   0F:C000                      		; ld		(_mcframe),a
     335   0F:C000                      		
     336   0F:C000                      		; ld		(_yoffset),a		;  0 tutto su
     337   0F:C000                      		; ld		(_xoffset),a		;  0 tutto su
     338   0F:C000                      								
     339   0F:C000                      		; ld		(aniframe),a
     340   0F:C000                      		; ld		(anispeed),a
     341   0F:C000                      		; ld		(ms_state),a
     342   0F:C000                      		; inc 	a
     343   0F:C000                      		; ld		(old_aniframe),a		; old_aniframe!=aniframe
     344   0F:C000                      	
     345   0F:C000                      		; ld		(dxmap),a		; moving right
     346   0F:C000                      		; ld		(_dxmap),a		; moving right
     347   0F:C000                      
     348   0F:C000                      		; ld		(xmap),hl
     349   0F:C000                      		; ld		(_xmapx4),hl
     350   0F:C000                      		; ld		bc,xship_rel
     351   0F:C000                      		; add 	hl,bc
     352   0F:C000                      		; ld		(xship),hl
     353   0F:C000                      		; ld		a,80
     354   0F:C000                      		; ld		(yship),a
     355   0F:C000                      
     356   0F:C000                      		; call 	npc_init								
     357   0F:C000                      		; call 	load_colors
     358   0F:C000                      
     359   0F:C000                      		; xor	a
     360   0F:C000                      		; ld		(_kBank1),a
     361   0F:C000                      		; inc	a
     362   0F:C000                      		; ld		(_kBank2),a
     363   0F:C000                      		; inc	a
     364   0F:C000                      		; ld		(_kBank3),a
     365   0F:C000                      		
     366   0F:C000                      
     367   0F:C000                      		; call	_isrinit
     368   0F:C000                      
     369   0F:C000                      ; main_loop: 
     370   0F:C000                      				
     371   0F:C000                      		; ld	hl,0
     372   0F:C000                      		; ld	(_jiffy),hl
     373   0F:C000                      
     374   0F:C000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     375   0F:C000                      ; ; run ms FSM and place its sprites in the SAT in RAM
     376   0F:C000                      		; call	ms_ctrl
     377   0F:C000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     378   0F:C000                      ; ; test for game restart
     379   0F:C000                      		; ld	a,(ms_state)
     380   0F:C000                      		; cp	ms_reset
     381   0F:C000                      		; jp	z,restart
     382   0F:C000                      
     383   0F:C000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     384   0F:C000                      ; ; place MS in the SAT and test for collision
     385   0F:C000                      		; call	put_ms_sprt
     386   0F:C000                      		; ld		a,(god_mode)
     387   0F:C000                      		; and 	a
     388   0F:C000                      		; ; call	z,test_obstacles
     389   0F:C000                      
     390   0F:C000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     391   0F:C000                      ; ; run NCPS FSM
     392   0F:C000                      		; call	wave_timer
     393   0F:C000                      		; call	npc_loop
     394   0F:C000                      		; call	enemy_bullet_loop
     395   0F:C000                      
     396   0F:C000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     397   0F:C000                      ; ; run MS bullets FSM
     398   0F:C000                      		; call	bullet_loop
     399   0F:C000                      
     400   0F:C000                      		; ; ld	a,00100101B			; random colour
     401   0F:C000                      		; ; out		(0x99),a
     402   0F:C000                      		; ; ld		a,7+128
     403   0F:C000                      		; ; out		(0x99),a
     404   0F:C000                      		
     405   0F:C000                      		; ; call	_waitvdp
     406   0F:C000                      
     407   0F:C000                      		; ; ld	a,10100101B			; random colour
     408   0F:C000                      		; ; out		(0x99),a
     409   0F:C000                      		; ; ld		a,7+128
     410   0F:C000                      		; ; out		(0x99),a
     411   0F:C000                      				
     412   0F:C000                      		; ld	a,(joystick)
     413   0F:C000                      		; and	32
     414   0F:C000                      		; ; call	z,_plot_distrucable
     415   0F:C000                      
     416   0F:C000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     417   0F:C000                      		; ; ld		a,3
     418   0F:C000                      		; ; out		(0x99),a
     419   0F:C000                      		; ; ld		a,7+128
     420   0F:C000                      		; ; out		(0x99),a
     421   0F:C000                      		
     422   0F:C000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     423   0F:C000                      		; ; call	test_star
     424   0F:C000                      
     425   0F:C000                      		; ; xor		a
     426   0F:C000                      		; ; out		(0x99),a
     427   0F:C000                      		; ; ld		a,7+128
     428   0F:C000                      		; ; out		(0x99),a
     429   0F:C000                      ; ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
     430   0F:C000                      
     431   0F:C000                      		
     432   0F:C000                      ; 1:		ld	a,(_jiffy)		; wait for vblank (and not for linit)
     433   0F:C000                      		; or	a
     434   0F:C000                      		; jr	z,1b
     435   0F:C000                      	
     436   0F:C000                      		; ld	hl,(xmap)
     437   0F:C000                      		; ld	bc,xship_rel
     438   0F:C000                      		; add hl,bc
     439   0F:C000                      		; ld	(xship),hl
     440   0F:C000                      
     441   0F:C000                      		; ld		a,(dxmap)
     442   0F:C000                      		; ld		(_dxmap),a
     443   0F:C000                      
     444   0F:C000                      		; jp      main_loop
     445   0F:C000                      
     446   0F:C000                      ; ;-------------------------------------
     447   0F:C000                      ; AFXPLAY:
     448   0F:C000                      		; ret
     449   0F:C000                      ; ;	include vuitpakker.asm
     450   0F:C000                      	; include print.asm
     451   0F:C000                      	; include plot_line.asm
     452   0F:C000                      	; include plot_line2.asm
     453   0F:C000                      	; include color_update.asm
     454   0F:C000                      ; ms_bllts_col_win:
     455   0F:C000                      	; include ms_bllts_frm_coll_wind.asm
     456   0F:C000                      	; include	ms_bllts.asm
     457   0F:C000                      		
     458   0F:C000                      ; ;-------------------------------------
     459   0F:C000                      
     460   0F:C000                      	
     461   0F:C000                      		; page 1
     462   0F:C000                      
     463   0F:C000                      		; include	ms_crtl.asm
     464   0F:C000                      		; include	put_ms_sprt.asm
     465   0F:C000                      		; include probe_level.asm				
     466   0F:C000                      		; include opening.asm		
     467   0F:C000                      ; outvram:
     468   0F:C000                      ; 2:		ld	a,d
     469   0F:C000                      		; ld	(_kBank4),a
     470   0F:C000                      		; ld	hl,0xA000
     471   0F:C000                      		; ld	bc,0x98
     472   0F:C000                      		; ld	a,32
     473   0F:C000                      ; 1:		otir
     474   0F:C000                      		; dec	a
     475   0F:C000                      		; jp	nz,1b
     476   0F:C000                      		; inc	d
     477   0F:C000                      		; dec	e
     478   0F:C000                      		; jr	nz,2b
     479   0F:C000                      		; ret
     480   0F:C000                      		
     481   0F:C000                      		; page 2
     482   0F:C000                      	; ; include mainhero_LMMM.asm
     483   0F:C000                      
     484   0F:C000                      	
     485   0F:C000                      		; page 3
     486   0F:C000                      ; manta_color:
     487   0F:C000                      		; incbin mship03_clr.bin
     488   0F:C000                      ; ms_spt:
     489   0F:C000                      		; incbin mship03_frm.bin
     490   0F:C000                      		
     491   0F:C000                      		; page 4
     492   0F:C000                      ; _tiles0:
     493   0F:C000                      		; incbin "tiles.bin",0x0000,0x2000
     494   0F:C000                      		; page 5
     495   0F:C000                      		; incbin "tiles.bin",0x2000,0x2000
     496   0F:C000                      		; page 6
     497   0F:C000                      		; incbin "tiles.bin",0x4000,0x2000
     498   0F:C000                      		; page 7
     499   0F:C000                      		; incbin "tiles.bin",0x6000,0x2000
     500   0F:C000                      		; page 8
     501   0F:C000                      		; incbin "tiles.bin",0x8000,0x2000
     502   0F:C000                      		; page 9
     503   0F:C000                      		; incbin "tiles.bin",0xA000,0x2000
     504   0F:C000                      		; page 10
     505   0F:C000                      		; incbin "tiles.bin",0xC000,0x2000
     506   0F:C000                      		; page 11
     507   0F:C000                      		; incbin "tiles.bin",0xE000;,0x2000
     508   0F:C000                      
     509   0F:C000                      		; page 12
     510   0F:C000                      
     511   0F:C000                      		; page 15
     512   0F:C000                      ; _level:
     513   0F:C000                      		; incbin "datamap.bin"
     514   0F:C000                      	
     515   0F:C000                      		; page 16
     516   0F:C000                      ; _opening:
     517   0F:C000                      		; incbin "opening.bin",0x0000,0x2000
     518   0F:C000                      		; page 17
     519   0F:C000                      		; incbin "opening.bin",0x2000,0x2000
     520   0F:C000                      		; page 18
     521   0F:C000                      		; incbin "opening.bin",0x4000,0x2000
     522   0F:C000                      		; page 19
     523   0F:C000                      		; incbin "opening.bin",0x6000,0x2000
     524   0F:C000                      		; page 20
     525   0F:C000                      		; incbin "opening.bin",0x8000,0x2000
     526   0F:C000                      		; page 21
     527   0F:C000                      		; incbin "opening.bin",0xA000,0x2000
     528   0F:C000                      		; page 22
     529   0F:C000                      		; incbin "opening.bin",0xC000;,0x2000
     530   0F:C000                      		; page 23
     531   0F:C000                      		; ; incbin "opening.bin",0xE000;,,0x2000
     532   0F:C000                      	
     533   0F:C000                      		; page 24
     534   0F:C000                      ; _scorebar:	
     535   0F:C000                      		; incbin scorebar.bin
     536   0F:C000                      	
     537   0F:C000                      		; page 25
     538   0F:C000                      ; _animated:	
     539   0F:C000                      		; incbin animated.bin,0x0000,0x2000
     540   0F:C000                      		; page 26
     541   0F:C000                      		; incbin animated.bin,0x2000,0x2000
     542   0F:C000                      
     543   0F:C000                      		; page 27
     544   0F:C000                      ; sprtdata:
     545   0F:C000                      		; incbin 	uridium_revA.bin,,16*32
     546   0F:C000                      		; incbin 	enemies_frm.bin
     547   0F:C000                      
     548   0F:C000                      		; page 28
     549   0F:C000                      ; color_base:
     550   0F:C000                      		; repeat 4
     551   0F:C000                      		; ds	16,8
     552   0F:C000                      		; ds	16,10+64
     553   0F:C000                      		; endrepeat
     554   0F:C000                      		; repeat 4
     555   0F:C000                      		; ds	16,8
     556   0F:C000                      		; ds	16,10+64
     557   0F:C000                      		; endrepeat
     558   0F:C000                      
     559   0F:C000                      		
     560   0F:C000                      		; incbin 	enemies_clr.bin
     561   0F:C000                      		
     562   0F:C000                      ; FINISH:
     563   0F:C000                      
     564   0F:C000                      
     565   0F:C000                      ; ;---------------------------------------------------------
     566   0F:C000                      ; ; Variables
     567   0F:C000                      ; ;---------------------------------------------------------
     568   0F:C000                      	
     569   0F:C000                      	
     570   0F:C000  (C000)              	MAP 0xC000
     571   0F:C000                      
     572   0F:C000  (0F:C000)           _levelmap:			#mapWidth*mapHeight
     573   0F:C000                      ; do not change position in ram
     574   0F:C000  (0F:CA00)           _sliceflag:			#16		; while scrolling right, 
     575   0F:C000                      							; if flag(n)>0, slice n+1 on displaypage has 
     576   0F:C000                      							; been copied to slice n in !displaypage
     577   0F:C000                      							; flag(0) is set when the hidden border on 
     578   0F:C000                      							; !displaypage has been built on slice 15
     579   0F:C000                      							;
     580   0F:C000                      							; while scrolling left,  
     581   0F:C000                      							; if flag(n)>0, slice n on displaypage has 
     582   0F:C000                      							; been copied to slice n+1 in !displaypage
     583   0F:C000                      							; flag(15) is set when the hidden border on 
     584   0F:C000                      							; !displaypage has been built on slice 0
     585   0F:C000                      							;
     586   0F:C000                      							; _sliceflag is reset at page swap
     587   0F:C000                      ; do not change position in ram
     588   0F:C000  (0F:CA10)           _sliceflag_reset:	#1		; is set, _sliceflag is reset				
     589   0F:C000                      
     590   0F:C000  (0F:CA11)           slotvar				#1
     591   0F:C000  (0F:CA12)           slotram				#1
     592   0F:C000  (0F:CA13)           SEL_NTSC			#1
     593   0F:C000                      
     594   0F:C000  (0F:CA14)           _xtest:				#1
     595   0F:C000  (0F:CA15)           _ytest:				#1
     596   0F:C000                      
     597   0F:C000  (0F:CA16)           anim_buffer.flag:		#1
     598   0F:C000  (0F:CA17)           anim_buffer.dy:			#1
     599   0F:C000  (0F:CA18)           anim_buffer.dx:			#1
     600   0F:C000  (0F:CA19)           anim_buffer.tile:		#1
     601   0F:C000  (0F:CA1A)           anim_buffer.page:		#1
     602   0F:C000                      
     603   0F:C000  (0F:CA1B)           joystick			#1
     604   0F:C000  (0F:CA1C)           keys0_7				#1
     605   0F:C000                      
     606   0F:C000                      ; _mcdivider			#1
     607   0F:C000                      
     608   0F:C000                      ; _mcx				#2	; relative with in the frame on the screen
     609   0F:C000                      ; _mcy				#2
     610   0F:C000                      
     611   0F:C000                      ; _mclx				#2	; absolute with the level in ram
     612   0F:C000                      ; _mcly				#2
     613   0F:C000                      
     614   0F:C000                      ; _mcframe			#1
     615   0F:C000                      ; _mcstate			#1
     616   0F:C000                      
     617   0F:C000                      ; _mcdx				#2
     618   0F:C000                      ; _mcdy				#2
     619   0F:C000                      
     620   0F:C000                      ; _mcprobe:			#1
     621   0F:C000                      ; _mcprobeb:			#1
     622   0F:C000                      
     623   0F:C000                      ; _ticxframe			#1
     624   0F:C000                      
     625   0F:C000                      ; _buffer:			#16
     626   0F:C000                      ; _fps:				#2
     627   0F:C000                      ; _nframes:			#2
     628   0F:C000                      ; _vbit16:			#2
     629   0F:C000                      
     630   0F:C000  (0F:CA1D)           _ymappos:			#1
     631   0F:C000  (0F:CA1E)           _xmappos:			#3		; 24 bit = 12.8 bit
     632   0F:C000  (0F:CA21)           _xspeed:			#2		; 16 bit = 8.8 bit
     633   0F:C000  (0F:CA23)           _dxchng:			#1		; <>0 if direction changes
     634   0F:C000  (0F:CA24)           _dxchng2:			#1		; <>0 at second frame after direction has changed
     635   0F:C000                      
     636   0F:C000                      ; _shadowbuff:		#2
     637   0F:C000                      
     638   0F:C000  (0F:CA25)           _displaypage:		#1
     639   0F:C000                      
     640   0F:C000                      ; _mccolorchange:		#1
     641   0F:C000  (0F:CA26)           _xoffset:			#1
     642   0F:C000                      ; _yoffset:			#1
     643   0F:C000                      
     644   0F:C000                      ; __xoffset:			#1
     645   0F:C000                      ; __r18:				#1
     646   0F:C000                      
     647   0F:C000                      ; randSeed:			#2
     648   0F:C000                      ; cur_level:			#1
     649   0F:C000                      ; wave_count:			#1
     650   0F:C000                      ; landing_permission:	#1
     651   0F:C000                      ; assault_wave_timer:	#2
     652   0F:C000                      ; bullet_rate:		#1
     653   0F:C000                      
     654   0F:C000                      ; _dxmap:				#1		; previous dxmap
     655   0F:C000                      ; dxmap:				#1
     656   0F:C000                      ; xmap:				#2
     657   0F:C000                      ; _xmapx4:			#2		; xmap x 4
     658   0F:C000                      ; yship:				#1
     659   0F:C000                      ; xship:				#2
     660   0F:C000                      ; aniframe:			#1
     661   0F:C000                      ; ms_state:			#1
     662   0F:C000                      ; old_aniframe:		#1
     663   0F:C000                      ; anispeed:			#1
     664   0F:C000                      ; already_dead:		#1
     665   0F:C000                      ; lives_bin:			#1
     666   0F:C000                      
     667   0F:C000                      ; god_mode:			#1
     668   0F:C000                      ; visible_sprts:		#1
     669   0F:C000                      ; flip_flop:			#1
     670   0F:C000                      
     671   0F:C000                      ; ram_sat:			#3*4
     672   0F:C000                      
     673   0F:C000                      	; struct enemy_data
     674   0F:C000                      ; y				db	0
     675   0F:C000                      ; x				dw	0
     676   0F:C000                      ; xoff			db	0
     677   0F:C000                      ; yoff			db	0
     678   0F:C000                      ; xsize			db	0
     679   0F:C000                      ; ysize			db	0
     680   0F:C000                      ; status			db	0	; B7 = DWN/UP | B6 = RIGHT/LEFT | B5 = ok/wrong clr | B0 = Inactive/Active
     681   0F:C000                      ; cntr			db	0
     682   0F:C000                      ; kind			db	0
     683   0F:C000                      ; frame			db	0
     684   0F:C000                      ; color			db	0
     685   0F:C000                      ; color2			db	0
     686   0F:C000                      ; speed			dw	0
     687   0F:C000                      	; ends
     688   0F:C000                      	
     689   0F:C000                      ; any_object:			#0
     690   0F:C000                      ; ms_bullets:			#enemy_data*max_bullets
     691   0F:C000                      ; enem_bullets:		#enemy_data*max_enem_bullets
     692   0F:C000                      ; enemies:			#enemy_data*max_enem
     693   0F:C000                      ; endram:				#1
     694   0F:C000  (0000)              	ENDMAP

    LABELS
-------------------------------------------------
00:00005000   _kBank1
00:00007000   _kBank2
00:00009000   _kBank3
00:0000B000   _kBank4
00:0000F3DF   RG0SAV
00:0000F3E0   RG1SAV
00:0000F3E1 X RG2SAV
00:0000F3E2 X RG3SAV
00:0000F3E3 X RG4SAV
00:0000F3E4 X RG5SAV
00:0000F3E5 X RG6SAV
00:0000F3E6   RG7SAV
00:0000FFE7   RG8SAV
00:0000FFE8   RG9SAV
00:0000FFE9 X RG10SAV
00:0000FFEA X RG11SAV
00:0000FFEB X RG12SAV
00:0000FFEC X RG13SAV
00:0000FFED X RG14SAV
00:0000FFEE X RG15SAV
00:0000FFEF X RG16SAV
00:0000FFF0 X RG17SAV
00:0000FFF1 X RG18SAV
00:0000FFF2 X RG19SAV
00:0000FFF3 X RG20SAV
00:0000FFF4 X RG21SAV
00:0000FFF5 X RG22SAV
00:0000FFF7 X RG23SAV
00:0000FC9E   _jiffy
00:0000000C X max_enem
00:00000003 X max_enem_bullets
00:00000002 X max_bullets
00:00000004 X maxspeed
00:000000B4 X assault_wave_timer_preset
00:00000002 X enemy_bullet_speed
00:00000078 X xship_rel
00:00000100   mapWidth
00:0000000A   mapHeight
00:000000A0   YSIZE
00:00000000 X debug
00:00000024 X ENASLT
00:00000138   RSLREG
00:0000FCC1   EXPTBL
00:00004010   search_slot
00:0000402F   search_slotram
00:00004050   search_slotram0
00:00004055 X setrompage0
00:0000405B   setrampage0
00:00004061   setrompage2
00:00004067 X setrampage2
00:0000406D X setrompage3
00:00004073 X setrampage3
00:00004079 X recbios
00:0000407C   setslotpage0
00:000040B3 X setslotpage1
00:000040F2   setslotpage2
00:00004139   setslotpage3
00:00004178   _cls
00:00004190 X _cls0
00:000041A5   font_cpy
00:00000099 X vdpport1
00:0000009A X vdpport2
00:000041C5   _vdpsetvramwr
00:000041C6 X _vdpsetvramwr2
00:000041D6 X _vdpsetvramwr14
00:000041DF X _vdpsetvramrd
00:000041F9 X _setpage
00:0000005F   chgmod
00:0000000C X RDSLT
00:00000156 X KILBUF
00:0000420A   set_scr
00:0000424D   _waitvdp
00:0000425C   isr_set
00:0000427F X isr_reset
00:0000429B   _scroll
00:000042BA   _fake_isr
00:000042C7   vblank
00:00004303 X vblank.scroll_right
00:00004310   vblank.scroll_left
00:0000431A   vblank.return
00:00004337   lint
00:000043B4   waitHBLANK
00:000043CB   xscroll
00:000043D9   pageswap
00:000043EA   set_displaypage
00:00004407   reset_sliceflag
00:0000441B   changespeed
00:00004439   changespeed.notright
00:00004452   changexpos
00:00004473   LMMC_tile
00:000044B5   move_tile
00:000044F8   move_slice
00:00004533   clear_slice
00:0000455D   brdrs_left
00:0000456B   brdrs_right
00:0000457A   vdp_task_left
00:00004596   vdp_task_left.x15
00:000045A1   vdp_task_left.x0_14
00:000045AC   vdp_task_left.left_dxchng
00:000045B5   vdp_task_left.left_dxchng2
00:000045BF   vdp_task_right
00:000045DA   vdp_task_right.x0
00:000045E5   vdp_task_right.x1_15
00:000045F0   vdp_task_right.right_dxchng
00:000045F9   vdp_task_right.right_dxchng2
00:00004603   _brdrs_left
00:00004642   _brdrs_right
00:00004681   colmn_patch_right
00:000046A8   set2pixs
00:000046BA   colmn_patch_left
00:000046E8   plot_col64
00:000046EB   plot_col32
00:000046EE   plot_col16
00:000046F5   _plot_col16
00:0000483F   movemarker
00:00004855   notright
00:00004878   notup
00:0000488D   animtest
00:000048A3 X animtest.scroll_right
00:000048B0   animtest.noexceptionr
00:000048C4   animtest.scroll_left
00:000048D0   animtest.noexceptionl
00:000048FB   animtest.intercept_right
00:0000490C   animtest.intercept_left
00:0000490D   animtest.manage_buffer
00:00004923   test_change_page
00:00004933   single_move
00:0000493F   checkkbd
00:0000494A   START
00:000049B5   PAL_ntsc
00:000049C6   mapinit
00:000049E9 X buildmap
00:00004A3A   vdptest
04:0000A000   _tiles0
0C:0000A000   _level
0D:0000A000   fonts
0F:0000C000   _levelmap
0F:0000CA00   _sliceflag
0F:0000CA10   _sliceflag_reset
0F:0000CA11   slotvar
0F:0000CA12   slotram
0F:0000CA13   SEL_NTSC
0F:0000CA14   _xtest
0F:0000CA15   _ytest
0F:0000CA16   anim_buffer.flag
0F:0000CA17   anim_buffer.dy
0F:0000CA18   anim_buffer.dx
0F:0000CA19   anim_buffer.tile
0F:0000CA1A   anim_buffer.page
0F:0000CA1B   joystick
0F:0000CA1C   keys0_7
0F:0000CA1D   _ymappos
0F:0000CA1E   _xmappos
0F:0000CA21   _xspeed
0F:0000CA23   _dxchng
0F:0000CA24   _dxchng2
0F:0000CA25   _displaypage
0F:0000CA26   _xoffset


 Output: main.out
-------------------------------------------------

 Page: 00
  Org: 00004000  Size: *  Used: 00000000

    No output

 Output: urd2.rom
-------------------------------------------------

 Page: 00
  Org: 00004000  Size: 00002000  Used: 00000A6C

   Address   Length Align   Label
   00004000    2668         search_slot
   00004A6C    5524       <empty>

 Page: 01
  Org: 00006000  Size: 00002000  Used: 00000000

   00006000    8192       <empty>

 Page: 02
  Org: 00008000  Size: 00002000  Used: 00000000

   00008000    8192       <empty>

 Page: 03
  Org: 0000A000  Size: 00002000  Used: 00000000

   0000A000    8192       <empty>

 Page: 04
  Org: 0000A000  Size: 00002000  Used: 00002000

   Address   Length Align   Label
   0000A000    8192         _tiles0

 Page: 05
  Org: 0000A000  Size: 00002000  Used: 00002000

   Address   Length Align   Label
   0000A000    8192         

 Page: 06
  Org: 0000A000  Size: 00002000  Used: 00002000

   Address   Length Align   Label
   0000A000    8192         

 Page: 07
  Org: 0000A000  Size: 00002000  Used: 00002000

   Address   Length Align   Label
   0000A000    8192         

 Page: 08
  Org: 0000A000  Size: 00002000  Used: 00002000

   Address   Length Align   Label
   0000A000    8192         

 Page: 09
  Org: 0000A000  Size: 00002000  Used: 00002000

   Address   Length Align   Label
   0000A000    8192         

 Page: 0A
  Org: 0000A000  Size: 00002000  Used: 00002000

   Address   Length Align   Label
   0000A000    8192         

 Page: 0B
  Org: 0000A000  Size: 00002000  Used: 00002000

   Address   Length Align   Label
   0000A000    8192         

 Page: 0C
  Org: 0000A000  Size: 00002000  Used: 00000A00

   Address   Length Align   Label
   0000A000    2560         _level
   0000AA00    5632       <empty>

 Page: 0D
  Org: 0000A000  Size: 00002000  Used: 00002000

   Address   Length Align   Label
   0000A000    8192         fonts

 Page: 0E
  Org: 0000A000  Size: 00002000  Used: 00002000

   Address   Length Align   Label
   0000A000    8192         

 Page: 0F
  Org: 0000A000  Size: 00002000  Used: 00002000

   Address   Length Align   Label
   0000A000    8192         
